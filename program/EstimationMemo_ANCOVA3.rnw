\newpage


\section{Data preparation}

\subsection{Define initial sample}


\textcolor{red}{\Sexpr{gsub("\\_", "\\\\_", paste0(pathsaveHere, "RosterAdmin.rds"))}} keeps all 800 members which will be used in attrition and randomisation tests. They are maked as \textsf{o800==1L}. 

\textcolor{red}{\Sexpr{gsub("\\_", "\\\\_", paste0(pathsaveHere, DataFileNames[3], "Trimmed.rds"))}} keeps 798 members after keeping only old members, individual rejecters, and group rejecters. Trimmed sample is produced in \textsf{EstimationMemo\_ChildFile1.rnw}. 

\textsf{InitialSample} is produced by dropping 24 HHs of traditional arm (who received only 2 loans [twice and double in \textsf{TradGroup}]) from Trimmed Sample . \textcolor{red}{\Sexpr{gsub("\\_", "\\\\_", paste0(pathsaveHere, DataFileNames[3], "InitialSample.rds"))}}. 

<<read trimmed files to objects>>=
for (i in (1:length(DataFileNames))[-c(3)])
  assign(datafiles[i], readRDS(
    paste0(pathsaveHere, DataFileNames[i], "Trimmed.rds")
    ))
#arA <- readRDS(paste0(pathsaveHere, DataFileNames[2], "InitialSample.rds"))
## same: arA <- readRDS(paste0(pathsaveHere, "AllMeetingsRepaymentInitialSample.rds"))
@
<<save InitialSample files after dropping 24 members>>=
for (i in (1:length(DataFileNames))[-c(3)]) {
  dd <- readRDS(paste0(pathsaveHere, DataFileNames[i], "Trimmed.rds"))
  dd <- dd[!grepl("tw|dou", TradGroup), ]
  saveRDS(dd, paste0(pathsaveHere, DataFileNames[i], "InitialSample.rds"))
  write.tablev(dd, paste0(pathsaveHere, DataFileNames[i], "InitialSample.prn")
    , colnamestrue = F)
}
<<check late disbursement in ar, warning = F>>=
arT <- readRDS(paste0(pathsaveHere, DataFileNames[3], "Trimmed.rds"))
arT[, MonthGap := min(DisDate1, na.rm = T), by = groupid]
arT[MonthGap == Inf, MonthGap := NA]
arT[, MonthGap := round(
  as.numeric(DisDate1 - MonthGap)/(60*60*24*30.4375), 2)]
addmargins(table0(arT[o800 == 1L & tee == 1, .(Arm, Only2Loans = grepl("tw|dou", TradGroup))]))
ra <- readRDS(paste0(pathsaveHere, "RosterAdminData.rds"))
addmargins(table0(ra[o800 == 1L & tee == 1, Arm]))
# Who are additional 4 HHs?
ra[, eye := 1:.N, by = .(survey, hhid)]
ra[tee == 1 & eye == 1 & o800 == 1L & 
  !(hhid %in% arT[o800 == 1L & tee == 1, hhid]), .(hhid, VArm, Mstatus, BStatus, ObPattern)]
ar <- arT[!grepl("tw|dou", TradGroup), ]
addmargins(table0(ar[o800 == 1L & tee == 1, .(Tee, AttritIn)]))
saveRDS(ar, paste0(pathsaveHere, DataFileNames[3], "InitialSample.rds"))
ar <- readRDS(paste0(pathsaveHere, DataFileNames[3], "InitialSample.rds"))
@


<<compute InitialSample by MonthGap, eval = F>>=
nrowsforthis <- function(i) 
  nrow(ar[o1600 == 1L & tee == 1 & 
  (MonthGap <= InitialSampleMonthUpperBound+i | grepl("sav", BorrowerStatus)), ])
nrowsInAr <- data.table(t(as.numeric(lapply(-6:6, nrowsforthis))))
nrowsInAr <- cbind("\\makebox[2.5cm]{\\scriptsize number of observations}", nrowsInAr)
setnames(nrowsInAr, c("Months after first loan", -6:6+6))
UpAndN <- latextab(as.matrix(nrowsInAr), 
  hleft = "\\scriptsize\\hfil$", hcenter = c(2.5, rep(.5, ncol(nrowsInAr)-1)), 
  hright = "$", 
  headercolor = "gray80", adjustlineskip = "-.2ex", delimiterline= NULL,
  alternatecolor = "gray90")
write.tablev(UpAndN,  paste0(pathsaveHere, "MonthsGapUBAndSampleSize.tex"),
  colnamestrue = F)
@






The study followed the stepped wedge design within each group due to administrative and budgetary constraints. Our initial identification strategy was comaprison between arms and did not use the stepped wedge design to estimate impacts because of possible spillovers within a group and a relatively short period for outcomes to change before the control gets treated [We can estimate within-group, we may just have underestimated impacts]. A half of members in a group, approximately 800 in total, are assigned initially as the treated and then the rest was treated in the following months. So the number of the treated increased as time passes. 

We restrict ourselves to this initial 800 members in estimating the impacts. We do so because of possible spill overs within groups. We compare between arms, not individuals in a group. One can see how impacts may differ if we compare between-group and within-group estimates. Such comparison is left as future exercises.

	 %To define our initially-treated sample, we need to use a cutoff month up to which we will include members in the intial-treated. We do not have the information of the dates we offered the members the loans [Were there members who hesitated and waited some months to get a loan?]. To rule out possible endogeneity of loan receipt timing, we decide the cutoff month gap that gives about 800, a half of 1600 households, in the resulting sample size. We compute \textsf{MonthGap} which is the number of months between the disbursement of first loan and own loan for each group. There are \Sexpr{sum(is.na(ar[tee == 1, MonthGap]))} NAs, which is the total of members who stayed as a pure saver or who quit the group. We track all the individuals who were offered a loan, including pure savers and people who left the group. 
<<summary of 1600, warning = F, echo = F, eval = F>>=
summary(ar[tee == 1 & o1600 == 1L, .(MonthGap, Mstatus, 
  Mgroup, BorrowerStatus, creditstatus)])
@


We will add a binary indicator function \textsf{o800} to indicate the initial sample. In below, we first use the roster-administrative data to choose the households of \textsf{o800}, because it has the most complete record. Then, I look for these households in other files and create \textsf{o800} variable in them.

Correct NAs in \textsf{LoanYear} to -1 when members start repayment before disbursement.
<<correcting LoanYear in ar and arA>>=
# roster file has wrong tee numbering, Redefine as TEE.
setkey(ar, hhid, mid, Date)
ar[, TEE := 1:.N, by = .(hhid, mid)]
setkey(ar, hhid, Date, mid)
arA[, tee := NULL]
arA[, tee := as.integer(1:.N), by = hhid]
# in ar: Date is NA and TEE == 1. Produced by forcing TEE == 1 to added to roster file.
# Set LoanYear to 1
ar[TEE == 1 & is.na(Date) & is.na(LoanYear), LoanYear := 1]
# Some members start repayment before loan disbursement.
# Loan year is NA for such cases. 
# Define LYear that includes LoanYear = -1 or 5.
# From SO: https://stackoverflow.com/questions/1995933/number-of-months-between-two-dates
elapsed_months <- function(end_date, start_date) {
    ed <- as.POSIXlt(end_date)
    sd <- as.POSIXlt(start_date)
    12 * (ed$year - sd$year) + (ed$mon - sd$mon)
}
for (aobj in c("ar", "arA")) {
  aob <- get(aobj)
  if (!any(grepl("LYear$", colnames(aob))))
  {
    aob[, LYear := LoanYear]
    aob[Date < DisDate1, LYear := -1]
    DueDate <- as.POSIXlt(aob[, DisDate1])
    DueDate$mon <- DueDate$mon + 48
    aob[elapsed_months(Date, DisDate1) <= 48 & elapsed_months(Date, DisDate1) > 36, LYear := 4]
    aob[Date > DueDate, LYear := 5]
    assign(aobj, aob)
  }
}
# display NAs in LYear while repaying
# arA[is.na(LYear) &  value.repay > 0, .(Arm, hhid, tee, LYear, value.repay)]
<<Tabulation of membership of InitialSample by arms using ar, warning = F>>=
tb <- table0(ar[o800 == 1L & tee == 1L, .(BStatus, Arm)])
tb1 <- cbind(tb, total = apply(tb, 1, sum))
tb <- table0(ar[tee == 1L, .(BStatus, Arm)])
tb2 <- cbind(tb, total = apply(tb, 1, sum))
tb <- cbind(tb1, tb2)
tb <- rbind(tb, total = apply(tb, 2, sum))
tb <- as.matrix(cbind(paste0("\\makebox[2.5cm]{\\scriptsize\\hfill ", rownames(tb), "}"), tb))
IniSampByArmar <- latextab(tb,
  hleft = "\\scriptsize\\hfil$", hcenter = c(2.5, rep(.95, ncol(tb)-1)), 
  hright = "$", 
  headercolor = "gray80", adjustlineskip = "-.2ex", delimiterline= NULL,
  alternatecolor = "gray90",
  addseparatingcols = 5, separatingcolwidth = .2,
  separatingcoltitle = c("initial sample", "all sample"),
  addsubcoltitlehere = T)
write.tablev(IniSampByArmar,  
  paste0(pathsaveHere, "InitialSampleSizeByArmInAr.tex")
  , colnamestrue = F)
@
<<Tabulation of membership of InitialSample by arms using arA, warning = F>>=
tb <- table0(arA[o800 == 1L & tee == 1L & !grepl("tw|dou", TradGroup), .(BStatus, Arm)])
tb1 <- cbind(tb, total = apply(tb, 1, sum))
tb <- table0(arA[tee == 1L & !grepl("tw|dou", TradGroup), .(BStatus, Arm)])
tb2 <- cbind(tb, total = apply(tb, 1, sum))
tb <- cbind(tb1, tb2)
tb <- rbind(tb, total = apply(tb, 2, sum))
tb <- as.matrix(cbind(paste0("\\makebox[2.5cm]{\\scriptsize\\hfill ", rownames(tb), "}"), tb))
IniSampByArmar <- latextab(tb,
  hleft = "\\scriptsize\\hfil$", hcenter = c(2.5, rep(.95, ncol(tb)-1)), 
  hright = "$", 
  headercolor = "gray80", adjustlineskip = "-.2ex", delimiterline= NULL,
  alternatecolor = "gray90",
  addseparatingcols = 5, separatingcolwidth = .2,
  separatingcoltitle = c("initial sample", "all sample"),
  addsubcoltitlehere = T)
write.tablev(IniSampByArmar,  
  paste0(pathsaveHere, "InitialSampleSizeByArmInArA.tex")
  , colnamestrue = F)
@

\subsection{Descriptive statistics}

<<merge assets livestock saving data for destat, cache = F, eval = F, child='c:/data/GUK/analysis/program/ComputeNetAssetsANCOVA.rnw'>>=
#  source(paste0(pathprogram, "ComputeNetAssetsANCOVA.R"))
# this gives NetAssetsANCOVATrimmed.rds
# destat data is created in c:/data/GUK/analysis/program/FormSample.rnw, 
# which was in PermutationTestsContents5.rnw but moved to here.
@
% For mixed knitr and plain latex file, need to use knitr_child function. A chunk child-file style gives a latex compilation error.
\Sexpr{knit_child(paste0(pathprogram, "FormSample.rnw"))}
<<form sample data, eval = F, cache = F, child='c:/data/GUK/analysis/program/FormSample.rnw'>>=
# source(paste0(pathprogram, "FormSampleCommandsOnly.R"))
@

<<read destat data asv>>=
asv <- readRDS(paste0(pathsaveHere, "DestatData.rds"))
arms <- c("traditional", "large", "large grace", "cow")
armsC <- c("traditional", "large", "large grace", "cattle")
ArmsC <- c("Traditional", "Large", "Large grace", "Cattle")
MeanAndStd0 <- function(x, NARM = T) {
  nx <- names(x)
  if (is.null(dim(x))) x <- matrix(x)
  ms <- c(apply(x, 2, mean, na.rm = NARM), 
    apply(x, 2, function(z) var(z, na.rm = NARM)^.5))
  names(ms) <- paste0(nx, rep(c(".mean", ".std"), each = ncol(x)))
  return(ms) 
}
# destat for main text
iiM <- c("HeadLiteracy", "HeadAge", "HHsize", "FloodInRd1", 
  "NLHAssetAmount",  "PAssetAmount", 
  "TotalImputedValue", "NumCows", 
  "NetValue", "NetBroadValue",
  "Attrited", "IRejected", "GRejected", "Active",
  "RiskPrefVal", "TimePref1Val", "TimePref2Val", "PresentBias")
# FloodInRd1 has NAs, all entries are NAs for 5 HHs
dm <- asv[, 
  lapply(.SD, sum), .SDcols = iiM, by = Arm]
desMain <- asv[, 
  lapply(.SD, MeanAndStd0), .SDcols = iiM, by = Arm]
desMain2 <- asv[, 
  lapply(.SD, MeanAndStd0), .SDcols = iiM]
# Kruskal-Wallis equality of location between groups without normality and equal variance assumptions
kw <- lapply(iiM, function(x) kruskal.test(
  formula(paste0(x , "~ Arm")), data = asv))
kw <- lapply(kw, function(x) formatC((x$p.value)*100, digits = 2, format = "f"))
# ANOVA equality of location between groups under normality and equal variance assumptions
ano <- lapply(iiM, function(x) summary(aov(
  formula(paste0(x , "~ Arm")), data = asv)))
ano <- lapply(ano, function(x) formatC((x[[1]]$P[1])*100, digits = 2, format = "f"))
# Shapiro-Wilks tests for normality
sha <- lapply(iiM, function(x) shapiro.test(unlist(asv[, x, with = F]))$p.value)
sha <- lapply(sha, function(x) formatC(x*100, digits = 2, format = "f"))
# Flinger-Killeen's test of equal variance robust to nonnormality
eqv <- lapply(iiM, function(x) fligner.test(
  formula(paste0(x , "~ Arm")), data = asv)$p.value)
eqv <- lapply(eqv, function(x) formatC(x*100, digits = 2, format = "f"))
# N
desMainN <- asv[, (N = .N), by = Arm]
setnames(desMainN, "V1", "N")
desMainN <- rbind(desMainN, list(Arm = "overall", N = sum(desMainN[, N])))
desMain2[, Arm := "overall"]
desMain <- rbindlist(list(desMain, desMain2), use.names = T)
ascols <- c("NLHAssetAmount", "PAssetAmount", "TotalImputedValue",
  "NetValue", "NetBroadValue",
  "RiskPrefVal", "TimePref1Val", "TimePref2Val")
desMain[, (ascols) := lapply(.SD, round, 0), .SDcols = ascols]
othecols <- c("HeadLiteracy", "HeadAge", "HHsize", "FloodInRd1", "NumCows",
  "Attrited", "IRejected", "GRejected", "Active", "PresentBias")
desMain[, (othecols) := lapply(.SD, round, 3), .SDcols = othecols]
desMmean <- desMain[seq(1, nrow(desMain), 2), ]
desMstd <- desMain[-seq(1, nrow(desMain), 2), ]
setkey(desMmean, Arm)
setkey(desMstd, Arm)
#desMmean[, Members := c(table(asv[, Arm]), sum(table(asv[, Arm])))]
desMmean <- data.table(variables = colnames(desMmean), t(desMmean))
setnames(desMmean, c("variables", as.character(desMmean[1, -1])))
desMmean <- desMmean[-1, ]
desMstd <- data.table(variables = colnames(desMstd), t(desMstd))
setnames(desMstd, c("variables", as.character(desMstd[1, -1])))
desMstd <- desMstd[-1, ]
armso <- c(armsC, "overall")
desMstd[, (armso) := lapply(.SD, function(x) paste0("(", x, ")")), .SDcols = armso]
setkey(desMmean, variables, physical = F)
setkey(desMstd, variables, physical = F)
desM <- rbind(desMmean, desMstd)
setkey(desM, variables)
rnum <- NULL
for (i in 1:nrow(desMmean)) 
  rnum <- c(rnum, grep(paste0("^", desMmean[i, variables]), desM[, variables]))
desM <- desM[rnum, ]
# change Active to non-attriting borrowers
desM[grepl("Active", variables), variables := "Non-attriting borrowers"]
# add N
desMainN2 <- data.table(t(desMainN[, N]))
setnames(desMainN2, as.character(desMainN[, Arm]))
desMainN2[, variables := "N"]
desM <- rbindlist(list(desM, desMainN2), use.names = T, fill = T)
desM[seq(2, nrow(desM), 2), variables := ""]
desM[seq(1, nrow(desM), 2), variables := paste0("\\textsf{", variables, "}")]
setnames(desM, c("variables", armsC, "overall"), c("Variable", ArmsC, "Overall"))
#desM[, ANOVA := c(unlist(lapply(ano, function(x) c(x, ""))), "")]
#desM[, "K-W" := c(unlist(lapply(kw, function(x) c(x, ""))), "")]
#desM[, "S-W" := c(unlist(lapply(sha, function(x) c(x, ""))), "")]
#desM[, "F-K" := c(unlist(lapply(eqv, function(x) c(x, ""))), "")]
# substitute covariate names 
source(paste0(pathprogram, "SubstTableANCOVA.R"))
rn <- rn2 <- as.character(unlist(desM[, 1]))
for (i in 1:nrow(subst.tableA)) 
  rn <- gsub(subst.tableA[i, 1], subst.tableA[i, 2], rn)
rn <- gsub("\\{", "{(", rn[seq(1, length(rn), 2)])
rn <- gsub("\\}", ")}", rn)
rn <- gsub("textsf", "textrm", rn)
rn <- gsub("\\{", "\\{\\\\scriptsize ", rn)
rn <- c(t(cbind(rn2[seq(1, length(rn2), 2)], rn)))
rn <- rn[-length(rn)]
desM[, Variable := rn] 
DestatMainByArm <- latextab(as.matrix(desM),
  hleft = c("\\scriptsize\\hfill ", rep("\\scriptsize\\hfil$", ncol(desM)-1)), 
  hcenter = c(3.5, rep(1.05, ncol(desM)-1)), 
  hright = c("", rep("$", ncol(desM)-1)), 
  headercolor = "gray80", adjustlineskip = "-.4ex", delimiterline= NULL,
  alternatecolor2 = "gray90")
write.tablev(DestatMainByArm,  
  paste0(pathsaveHere, "DestatMainByArm.tex")
  , colnamestrue = F)
@

\hspace{-1cm}\begin{minipage}[t]{14cm}
\hfil\textsc{\normalsize Table \refstepcounter{table}\thetable: Baseline descriptive statistics by arm for all households including nonparticipants\label{tab DestatMainByArm}}\\
\setlength{\tabcolsep}{1pt}
\setlength{\baselineskip}{8pt}
\renewcommand{\arraystretch}{.55}
\hfil\begin{tikzpicture}
\node (tbl) {\input{\Sexpr{paste0(pathsaveHere, "DestatMainByArm.tex")}}};
\end{tikzpicture}\\
\renewcommand{\arraystretch}{.8}
\setlength{\tabcolsep}{1pt}
\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\hfill\scriptsize}p{.25cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source:& \multicolumn{2}{l}{\scriptsize Estimated with GUK administrative and survey data at the period 2. Survey respondents include nonparticipants to the experiments.}\\
Notes: & 1. & Information of original 800 households. Values are means, values in brackets are standard deviations. \\
& 2 & \textsf{HeadLiteracy}, \textsf{HeadAge} are literacy and ages of household heads. \textsf{HHsize} is total number of household members. \textsf{FloodInRd1} is flood exposure at period 2. \textsf{NLHAssetAmount} is non-land household asset holding value, \textsf{PAssetAmount} is productive asset holding value, \textsf{TotalImputedAmount} is imputed value of livestock holding. 
\textsf{NumCows} is cattle holding per household. \textsf{NetValue} is net asset values per housheold for asset items observed in all 4 rounds given by \textsf{NLHAssetAmount}+\textsf{PAssetAmount}+\textsf{TotalImputedAmount} - total debt. %\textsf{NarrowNetValue} is net asset values per housheold for asset items observed in all 4 rounds excluding cassette players, radios. 
\textsf{NetBroadValue} is net asset values per housheold for all asset items. %\textsf{RNetValue} is net asset values per housheold for asset items observed in all 4 rounds with cassette players, radios winsorised at BDT 20000 and bicycles at BDT 2000. \textsf{RNarrowNetValue} and \textsf{RNetBroadValue} are winsorised equivalents to \textsf{NarrowNetValue} and \textsf{NetBroadValue}. 
All asset values are expressed in BDT. \textsf{Attrited} indicates attrition rates in the household survey, and \textsf{GRejected} and \textsf{IRejected} show group rejection rates and individual rejection rates to the lending program. \textsf{Active} indicates the nonattrited borrower ratios. Because attrition and rejection are separate events, a household can reject and attrit, so active members $\geqslant$ total - (rejected members + attrited members). \Sexpr{PrefTestsDefinitions1}
\end{tabular}
\end{minipage}

<<correct disbursement dates of 4 members, echo = F, results = 'hide'>>=
arACompletePanel = copy(arA)
arACompletePanel <- arACompletePanel[
  hhid %in% ass[tee == 1 & !is.na(NLHAssetAmount), hhid] &
  hhid %in% ass[tee == 2 & !is.na(NLHAssetAmount), hhid] &
  hhid %in% ass[tee == 3 & !is.na(NLHAssetAmount), hhid] &
  hhid %in% ass[tee == 4 & !is.na(NLHAssetAmount), hhid], ]
for (aobj in c("ar", "arA", "arACompletePanel")) {
  aob <- get(aobj)
  aob[, value.EffRepay := value.repay + value.NetSaving]
  ## To migrate to Data preparation?: Starts here
  table0(aob[tee == 1 & is.na(MonthsElapsed) & grepl("old", Mship), 
    .(BStatus, groupid)])
  # 81693: Thee are 4 members whose disbursement dates are NA
  table0(aob[groupid == 81693 & grepl("bo", BStatus) & tee==1, 
    .(DisDate1, BStatus)])
  # These are borrowers, but all disbursement dates are NAs
  table0(aob[groupid == 81693 & grepl("bo", BStatus) & tee==48 & is.na(DisDate1),
   .(CumNetSaving, CumRepaid)])
  # Their distbursement dates must be the same as others in the same group
  # Copy from others
  ddates <- c("DisDate1", "DisDate2", "DisDate3")
  aob[groupid == 81693 & grepl("bo", BStatus), 
    (ddates) := lapply(.SD, function(z) z[!is.na(z)][1]), .SDcols = ddates, by = groupid]
  # update MonthsElapsed by referring to tee
  aob[groupid == 81693 & grepl("bo", BStatus), 
    MonthsElapsed := lapply(.SD, function(z) z[!is.na(z)][1]), 
    .SDcols = "MonthsElapsed", by = .(groupid, tee)]
  aob[grepl("bo", BStatus) & -11 <= MonthsElapsed & MonthsElapsed <= -0, 
    LoanYear := -1]
  aob[grepl("bo", BStatus) & -23 <= MonthsElapsed & MonthsElapsed <= -12, 
    LoanYear := -2]
  aob[grepl("bo", BStatus) & -35 <= MonthsElapsed & MonthsElapsed <= -24, 
    LoanYear := -3]
  aob[grepl("bo", BStatus) & 1 <= MonthsElapsed & MonthsElapsed <= 12, 
    LoanYear := 1]
  aob[grepl("bo", BStatus) & 13 <= MonthsElapsed & MonthsElapsed <= 24,
    LoanYear := 2]
  aob[grepl("bo", BStatus) & 25 <= MonthsElapsed & MonthsElapsed <= 36, 
    LoanYear := 3]
  aob[grepl("bo", BStatus) & 37 <= MonthsElapsed & MonthsElapsed <= 48, 
    LoanYear := 4]
  # repayment
  # Need to change value.missw NA => 1 for continuing members
  aob[!grepl("drop", Mgroup) & grepl("oldMem", Mstatus) & 
    !grepl("pure saver", BorrowerStatus) & 
    is.na(value.missw) & (is.na(value.repay) | value.repay == 0), 
    value.missw := 1]
  aob[, CumMisses := cumsum(value.missw), by = hhid]
  assign(aobj, aob)
  addmargins(table(aob[is.na(LoanYear), .(tee, Mgroup)]))
  ## To migrate to Data preparation?: Ends here
  #  HH characteristics from ar
  iiH <- c("HeadLiteracy", "HeadAge", "HHsize", "FloodInRd1")
  # FloodInRd1 has NAs, all entries are NAs for 5 HHs
  summary(aob[hhid %in% hhid[is.na(FloodInRd1)], 
    .(hhid = factor(hhid), FloodInRd1)])
  aob[tee==1, c("groupid", "hhid", "Mstatus", iiH), with = F]
  desH <- aob[o800 == 1 & tee == 1, 
    lapply(.SD, mean, na.rm = T), .SDcols = iiH, by = Arm]
  desN <- aob[o800 == 1 & tee == 1, lapply(.SD, function(z) length(z[!is.na(z)])), 
    .SDcols = iiH, by = Arm]
  cns <- colnames(desH[, -1])
  # below avoids flipping order of Arm
  setkey(desH, Arm)
  desH <- data.table(t(desH[, -1]))
  setnames(desH, armsC)
  desH[, variables := cns]
  setcolorder(desH, c("variables", armsC))
  desH[, (armsC) := lapply(.SD, formatC, digits = 2, format = "f"), .SDcol = armsC]
  assign(paste0("desH.", aobj), desH)
  assign(paste0("desN.", aobj), desN)
}
@

\subsection{Changes in assets}

<<read cleaned net assets data>>=
xpa <- readRDS(paste0(path1234, "ProdAssetsCleaned.rds"))
xha <- readRDS(paste0(path1234, "HHAssetsCleaned.rds"))
xas2 <- readRDS(paste0(path1234, "MergedAssetsCleaned.rds"))
# Trimmed data are before dropping 26 HHs.
ar <- readRDS(paste0(pathsaveHere, DataFileNames[3], "Trimmed.rds"))
completeAsset <- readRDS(paste0(path1234, "ListOfCompleteAssetsInAllRounds.rds"))
@
After winsorising cassette players, radios, and bicycles, there is no HH with anomalous asset values (changes in narrow net asset values $<-50000$).
<<Check anomalous values>>=
# asset data anomalous HHs
#xha[, DNNLHAval := c(NA, diff(NarrowNLHAssetAmount)), by = hhid]
xha[, DNLHAval := c(NA, diff(NLHAssetAmount)), by = hhid]
xha[, DvalAnomalous := hhid %in% hhid[DNLHAval < -50000] ]
#xha[, DvalNAnomalous := hhid %in% hhid[DNNLHAval < -10000] ]
@
<<>>=
ar2 <- unique(ar[o800 == 1L, .(Arm, hhid)]) # attaches Arm and limits obs to o800 == 1L
da50K <- unique(xha[(DvalAnomalous) & hhid %in% hhid[amount > 50000] & hhid %in% ar2[, hhid], hhid])
#dna50K <- unique(xha[(DvalNAnomalous) & hhid %in% hhid[amount > 10000] & hhid %in% ar2[, hhid], hhid])
@
%There are members who report sharp decline in net assets. This is mostly due to radio and casette player entries. There are \Sexpr{length(da50K)} households among \textsf{o800==1L} whose changes in net total asset $< -50000$ and have assets of values greater than 50000.

%When radios and casset players are excluded from/winsorised in total, there are \Sexpr{length(dna50K)} households among \textsf{o800==1L} whose changes in net total asset $< -10000$ and have assets of values greater than 10000. Note that residential land is only included in BroadHAssetAmount. 
<<>>=
setkey(ar2, hhid)
setkey(xha, hhid)
xha2 <- xha[ar2]
#xha2[(DvalAnomalous) & amount > 50000, 
#   .(hhid, survey, type, amount, RevAmount, NH=NarrowHAssetAmount, H=HAssetAmount, BH=BroadHAssetAmount)]
#xha2[(DvalNAnomalous) & amount > 10000, 
#   .(hhid, survey, type, amount, RevAmount, #NH=NarrowNLHAssetAmount, 
#   H=NLHAssetAmount, BH=BroadNLHAssetAmount)]
#xha2[(DvalNAnomalous), 
#   .(hhid, survey, type, amount, NH=NarrowNLHAssetAmount, H=NLHAssetAmount, BH=BroadNLHAssetAmount)][,
#   .(eye=1:.N, NH, H, BH), by = .(hhid, survey)][eye==1, ]
for (h in da50K)
  print(xha2[hhid == h, .(Arm, hhid, t=survey, type, amount, 
    #NH=NarrowNLHAssetAmount, 
    H=NLHAssetAmount, BH=BroadNLHAssetAmount, NLHAssetNum)])
@


\subsection{Error bar graphs of outcomes}

<<read mean outcomes data>>=
# Run ComputeNetAssetsANCOVA.R first to produce various "Figure" data.
# This is ran in \subsection{Descriptive statistics} as a knitr child file.
# source(paste0(pathprogram, "ComputeNetAssetsANCOVA.R"))
NeA1R <- readRDS(paste0(pathsaveHere, "NetAssetsANCOVATrimmed.rds"))
cpn <- NeA1R[(CompleteAssetPanel) & tee == 1, .(Arm, hhid, tee, 
  CP=CompleteAssetPanel, NLHAssetAmount, PAssetAmount, NumCows)]
# comple asset panel sample is only 220 HHs and only 35 HHs for traditional
lvoD <- readRDS(paste0(pathsaveHere, "NumCowsFigure.rds"))
nAD <- readRDS(paste0(pathsaveHere, "AllNetAssetsFigureMeanData.rds"))
cpn <- readRDS(paste0(pathsaveHere, "CPNetAssetsFigureMeanData.rds"))
conD <- readRDS(paste0(pathsaveHere, "ConsumptionFigure.rds"))
labDHH <- readRDS(paste0(pathsaveHere, "HHLabourIncomeFigure.rds"))
labDpc <- readRDS(paste0(pathsaveHere, "pcHHLabourIncomeFigure.rds"))
schD <- readRDS(paste0(pathsaveHere, "SchoolingFigure.rds"))
schD[, file := Schooling]
# break down various asset measures in nAD
nAD[grepl("cow", Arm), Arm := "cattle"]
armsC <- c("traditional", "large", "large grace", "cattle")
nAD[, Arm := factor(Arm, levels = armsC)]
na <- nAD[, .(Arm, tee, NetValue..mean, NetValue..upper, NetValue..lower, NetValue..N)]
#nna <- nAD[, .(Arm, tee, NarrowNetValue..mean, NarrowNetValue..upper, NarrowNetValue..lower, NarrowNetValue..N)]
#rna <- nAD[, .(Arm, tee, RNetValue..mean, RNetValue..upper, RNetValue..lower, RNetValue..N)]
#bna <- nAD[, .(Arm, tee, NetBroadValue..mean, NetBroadValue..upper, NetBroadValue..lower, NetBroadValue..N)]
#rbna <- nAD[, .(Arm, tee, RNetBroadValue..mean, RNetBroadValue..upper, RNetBroadValue..lower, RNetBroadValue..N)]
pal <- nAD[, .(Arm, tee, ProdValue..mean, ProdValue..upper, ProdValue..lower, ProdValue..N)]
pa <- nAD[, .(Arm, tee, PAssetAmount..mean, PAssetAmount..upper, PAssetAmount..lower, PAssetAmount..N)]
cpn <- cpn[, .(Arm, tee, NetValue..mean, NetValue..upper, NetValue..lower, NetValue..N)]
setnames(na, grepout("Ne", colnames(na)), c("mean", "upper", "lower", "N"))
#setnames(nna, colnames(na))
#setnames(rna, colnames(na))
#setnames(bna, colnames(na))
#setnames(rbna, colnames(na))
setnames(pal, colnames(na))
setnames(pa, colnames(na))
setnames(cpn, colnames(na))
figD <- rbindlist(list(
  cbind(file = "NumCows", lvoD),
  cbind(file = "PAssetAmount", pa),
  cbind(file = "ProdValue", pal),
  cbind(file = "NetAssets", na),
  cbind(file = "CPNetAssets", cpn),
  #cbind(file = "RNetAssets", rna),
  #cbind(file = "NarrowNetAssets", nna),
  #cbind(file = "BroadNetAssets", bna),
  #cbind(file = "RBroadNetAssets", rbna),
  cbind(file = "Consumption", conD),
  cbind(file = "HHLabourIncomes", labDHH),
  cbind(file = "pcHHLabourIncomes", labDpc),
  schD[, .(file, Arm, sex, tee, lower, mean, upper, N)]
  ), use.names = T, fill = T)
figD[, file := factor(file, levels = c(
  "NumCows", "PAssetAmount", "ProdValue",
  "NetAssets", "CPNetAssets", #"RNetAssets",   
  #"NarrowNetAssets", "BroadNetAssets", "RBroadNetAssets", 
  "Consumption", "HHLabourIncomes", "pcHHLabourIncomes",
  "primary0512", "junior1315", "high1618"))]
figD[, file := factor(file, labels = c(
  "NumCows", "PAssetAmount", "ProdValue",
  "NetAssets", "CPNetAssets", 
  #"RNetAssets", "NarrowNetAssets", "BroadNetAssets", "RBroadNetAssets", 
  "Consumption", "HHIncomes", "pcIncomes",
  "Sch0512", "Sch1315", "Sch1618"))]
figD[is.na(sex), sex := "NA"]
figD[, sex := factor(sex, labels = c("M", "F", "NA"))]
figD[, Sex := factor(sex, labels = c("Male", "Female", "Per household"))]
figD[grepl("tra", Arm), Arm := "Traditional"]
figD[grepl("ge$", Arm), Arm := "Large"]
figD[grepl("ce$", Arm), Arm := "LargeGrace"]
figD[grepl("^ca", Arm), Arm := "Cattle"]
figD[, Arm := factor(Arm, levels = c(Arms[-4], "Cattle"))]
saveRDS(figD, paste0(pathsaveHere, "figD.rds"))
<<figure raw outcomes, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 12, fig.lp = 'Figure '>>=
library(ggplot2)
figD <- readRDS(paste0(pathsaveHere, "figD.rds"))
Yfacet = c(
  `NumCows` = "number\nof cattle", 
  `PAssetAmount` = "productive\nassets", 
  `ProdValue` = "livestock and\nproductive\nassets", 
  `NetAssets` = "net assets", 
  `CPNetAssets` = "complete\npanel\nnet assets", 
#  `NarrowNetAssets` = "narrow\nnet assets", 
  `Consumption` = "consumption", 
  `HHIncomes` = "HH\nincomes", 
  `pcIncomes` = "per capita\nincomes", 
  `Sch0512` = "school\n05-12", 
  `Sch1315` = "school\n13-15", 
  `Sch1618` = "school\n16-18"
  )
Xfacet = c(`Traditional` = "Traditional", `Large` = "Large",
    `LargeGrace` = "Large grace", `Cattle` = "Cattle")
p <- ggplot(data = subset(figD, !grepl("^R|Br", file))
  , aes(x = factor(tee), y = mean, colour = Sex, shape = Sex, group = interaction(Arm, Sex))
  , size = 0.1, stroke = 0) + 
  geom_pointrange(aes(
    ymin = lower, ymax = upper), 
    stat = "identity", fatten = 1.25, 
    position = position_dodge(width = .5))
p <- p + 
  scale_y_continuous(name = "values" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 1:4) +
  #scale_colour_viridis_d(guide = "legend") +
  scale_colour_manual(
  values = c("Male" = "green", "Female" = "red", "Per household" = "blue")
  ) +
  scale_shape_manual(values = c("Male" = 16, "Female" = 17, "Per household" = 15)
  ) +
  facet_grid(file ~ Arm, scales = "free_y", 
    labeller = labeller(file = Yfacet, Arm = Xfacet)) +
  theme(
    strip.text.x = element_text(color = "blue", size = 6, 
      margin = margin(0, 1.25, 0, 1.25, "cm")), 
    strip.text.y = element_text(color = "blue", size = 6, 
      margin = margin(t=1.65, r=.1, b=1.65, l=.1, "cm")),
    axis.text.x = element_text(size = 5, angle = 0, vjust = 1, hjust = 1), 
    axis.text.y = element_text(size = 6), 
    plot.title = element_text(size = 8), 
    axis.title = element_text(size = 8), 
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 7),
    legend.key = element_rect(fill = "white"),
    legend.key.size = unit(.25, "cm"),    
    legend.margin = margin(t=-.5, r=0, b=0, l=0, "cm"), # 
    legend.box.margin = margin(t=.5, r=0, b=0, l=0, "cm"), # 
    legend.box.spacing = unit(.25, "cm"), # 
    legend.position="bottom") + 
  labs(
    x="Periods", 
    y = "values (in numbers or BDT or rates)", 
    colour = "",
    shape = ""
    )+ 
  guides(
    colour = guide_legend(title = "Groups", nrow = 1), 
    shape = guide_legend(title = "Groups", override.aes = list(size = .125), nrow = 1)
    )
ggsave(
  paste0(pathprogram, "figure/EstimationMemo/MeanOutcomesByArmAndPeriod.png")
  , p,
  width = 12, height = 15, units = "cm",
  dpi = 300
 )
par(lwd=.5)
pdf(
  paste0(pathprogram, "figure/EstimationMemo/MeanOutcomesByArmAndPeriod.pdf")
  , width = 12/2.54, height = 15/2.54)
print(p)
whatever <- dev.off()
par(lwd=1)
<<figure assets only, warning = F, message = F, results = "hide", fig.align='center', fig.height = 12, fig.width = 12, fig.lp = 'Figure '>>=
library(ggplot2)
# read_cleaned_data.rnw(1113)
# NarrowNetValue := TotalImputedValue + NarrowHAssetAmount + PAssetAmount 
#  - a2b(DebtOutstanding.before, NA, 0) - a2b(NonNGOBal, NA, 0)
# NarrowHAssetAmount := sum(amount[type %in% completeAsset], na.rm = T)
# Assets observed in all rounds. Some items 
# (cabinets, residential land, vcr/vcp, motorcycle, jewelry, are not recorded in period 2) 
# are observed from round 2. NarrowHAssets are
# "television"      "bicycle"         "wrist watch"     "electric fan"   
# "wall clock"      "radio"           "cassette player" "rickshaw/van"   
# read_cleaned_data.rnw(1172)
# NarrowAssetAmount := NarrowHAssetAmount+PAssetAmount
figD <- readRDS(paste0(pathsaveHere, "figD.rds"))
Yfacet = c(
  `NetAssets` = "net assets", 
  `ProdValue` = "livestock and\nproductive assets"#, 
#  `CPNetAssets` = "complete\npanel\nnet assets", 
#  `RNetAssets` = "revised\nnet assets", 
#  `NarrowNetAssets` = "narrow\nnet assets",
#  `RNarrowNetAssets` = "revised\nnarrow\n net assets", 
#  `BroadNetAssets` = "broad\nnet assets"
#  , `RBroadNetAssets` = "revised\nbroad\nnet assets"
  )
Xfacet = c(`Traditional` = "Traditional", `Large` = "Large",
    `LargeGrace` = "Large grace", `Cattle` = "Cattle")
p <- ggplot(data = subset(figD, grepl("^NetA|^ProdV", file))
  , aes(x = factor(tee), y = mean, colour = Arm, shape = Arm, group = Arm)
  , size = 0.1, stroke = 0) + 
  geom_pointrange(aes(
    ymin = lower, ymax = upper), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .5))
p <- p + 
  scale_y_continuous(name = "values" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 1:4) +
  scale_colour_manual(
  values = c("Traditional" = "green", "Large" = "darkgreen", "LargeGrace" = "blue", "Cattle" = "red")
  ) +
  scale_shape_manual(
  values = c("Traditional" = 16, "Large" = 17, "LargeGrace" = 18, "Cattle" = 15)
  ) +
  facet_grid(file ~ Arm, scales = "free_y", 
    labeller = labeller(file = Yfacet, Arm = Xfacet)) +
  theme(
    plot.margin = margin(t=.0, r=0, b=1, l=0, "cm"), # 
    strip.text.x = element_text(color = "blue", size = 6, 
      margin = margin(0, 1.25, 0, 1.25, "cm")), 
    strip.text.y = element_text(color = "blue", size = 6, 
      margin = margin(1.5, 0, 1.5, 0, "cm")),
    axis.text.x = element_text(size = 5, angle = 0, vjust = 1, hjust = 1), 
    axis.text.y = element_text(size = 6), 
    plot.title = element_text(size = 8), 
    axis.title = element_text(size = 6), 
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 7),
    legend.key = element_rect(fill = "white"),
    legend.key.size = unit(.25, "cm"),    
    legend.margin = margin(t=-.5, r=0, b=0, l=0, "cm"), # 
    legend.box.margin = margin(t=.5, r=0, b=0, l=0, "cm"), # 
    legend.box.spacing = unit(.25, "cm"), # 
    legend.position="bottom") + 
  labs(
    x="Periods", 
    y = "values (in BDT)", 
    colour = "",
    shape = ""
    )+ 
  guides(
    colour = guide_legend(title = "Arms", nrow = 1), 
    shape = guide_legend(title = "Arms", override.aes = list(size = .125), nrow = 1)
    )
ggsave(
  paste0(pathprogram, "figure/EstimationMemo/MeanAssetOutcomesByArmAndPeriod.png"),
  p,
  width = 9, height = 10, units = "cm",
  dpi = 300
 )
par(lwd=.5)
pdf(
  paste0(pathprogram, "figure/EstimationMemo/MeanAssetOutcomesByArmAndPeriod.pdf"),
  , width = 14/2.54, height = 12/2.54)
print(p)
whatever <- dev.off()
par(lwd=1)
<<figure raw outcomes income consumption, warning = F, message = F, results = "hide", fig.align='center', fig.height = 12, fig.width = 12, fig.lp = 'Figure '>>=
library(ggplot2)
figD <- readRDS(paste0(pathsaveHere, "figD.rds"))
cl <- subset(figD, grepl("Con|Inc", file) & !is.na(Arm))
cl[, file := factor(file, labels = c("Consumption", "Household income", "Per capita income"))]
cl <- cl[!grepl("Per ca.*in", file), ]
p <- ggplot(data = cl
  , aes(x = factor(tee), y = mean, group = Arm)
  , size = 0.1, stroke = 0) + 
  geom_pointrange(aes(
    ymin = lower, ymax = upper), colour = "blue", 
    stat = "identity", fatten = .75, 
    position = position_dodge(width = .5))
p <- p + 
  scale_y_continuous(name = "values" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 1:4) +
  facet_grid(file ~ Arm, scales = "free_y", 
    labeller = labeller(file = 
      c("Consumption" = "Per capita consumption", 
        "HHIncomes" = "Household labour income"
        #,"pcIncomes" = "per capita household labour income"
        ))) +
  theme(
    axis.text.x = element_text(size = 7, angle = 0, vjust = 1, hjust = 1), 
    axis.text.y = element_text(size = 8), 
    axis.title = element_text(size = 8), 
    strip.text.x = element_text(color = "blue", size = 8, 
      margin = margin(.05, 1.25, .05, 1.25, "cm")), 
    strip.text.y = element_text(color = "blue", size = 8, 
      margin = margin(1.5, .05, 1.5, .05, "cm")),
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 7),
    legend.key = element_rect(fill = "white"),
    legend.key.size = unit(.25, "cm"),
    legend.margin = margin(t=-.5, r=0, b=0, l=0, "cm"), # 
    legend.box.margin = margin(t=.5, r=0, b=0, l=0, "cm"), # 
    legend.box.spacing = unit(.25, "cm"), # 
    legend.position="none") + 
  xlab("periods")
invisible(ggsave(
  paste0(pathprogram, "figure/EstimationMemo/MeanConsumptionIncomeByArmAndPeriod.jpg"),
  p,
  width = 1, height = 1, units = "cm",
  dpi = 300
 ))
par(lwd=.1)
pdf(
  paste0(pathprogram, "figure/EstimationMemo/MeanConsumptionIncomeByArmAndPeriod.pdf")
  , width = 2*12/2.54, height = 2*6/2.54)
print(p)
whatever <- dev.off()
<<figure raw outcomes income consumption dodge, warning = F, message = F, results = "hide", fig.align='center', fig.height = 12, fig.width = 12, fig.lp = 'Figure '>>=
library(ggplot2)
figD <- readRDS(paste0(pathsaveHere, "figD.rds"))
cl <- subset(figD, grepl("Con|Inc", file) & !is.na(Arm))
cl[, file := factor(file, labels = c("Consumption", "Household income", "Per capita income"))]
p <- ggplot(data = cl
  , aes(x = factor(tee), y = mean, colour = Arm, shape = Arm, group = Arm)
  , size = 0.1, stroke = 0) + 
  geom_pointrange(aes(
    ymin = lower, ymax = upper), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .5))
p <- p + 
  scale_y_continuous(name = "values" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 1:4) +
  scale_colour_manual(
  values = c("Traditional" = "green", "Large" = "darkgreen", "LargeGrace" = "blue", "Cattle" = "red")
  ) +
  scale_shape_manual(
  values = c("Traditional" = 16, "Large" = 17, "LargeGrace" = 18, "Cattle" = 15)
  ) +
  facet_grid(file ~ ., scales = "free_y") +
  theme(
    strip.text.x = element_text(color = "blue", size = 8, 
      margin = margin(0, 1.25, 0, 1.25, "cm")), 
    strip.text.y = element_text(color = "blue", size = 8, 
      margin = margin(1.5, 0, 1.5, 0, "cm")),
    axis.text.x = element_text(size = 7, angle = 0, vjust = 1, hjust = 1), 
    axis.text.y = element_text(size = 8), 
    plot.title = element_text(size = 8), 
    axis.title = element_text(size = 8), 
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 7),
    legend.key = element_rect(fill = "white"),
    legend.key.size = unit(.25, "cm"),    
    legend.margin = margin(t=-.5, r=0, b=0, l=0, "cm"), # 
    legend.box.margin = margin(t=.5, r=0, b=0, l=0, "cm"), # 
    legend.box.spacing = unit(.25, "cm"), # 
    legend.position="bottom") + 
  labs(
    x="Periods", 
    y = "values (in BDT)", 
    colour = "",
    shape = ""
    )+ 
  guides(
    colour = guide_legend(title = "Arms", nrow = 1), 
    shape = guide_legend(title = "Arms", override.aes = list(size = .125), nrow = 1)
    )
invisible(ggsave(
  paste0(pathprogram, "figure/EstimationMemo/MeanConsumptionIncomeDodge.jpg"),
  p,
  width = 12, height = 10, units = "cm",
  dpi = 300
 ))
par(lwd=.5)
pdf(
  paste0(pathprogram, "figure/EstimationMemo/MeanConsumptionIncomeDodge.pdf")
  , width = 8*2/2.54, height = 10*2/2.54)
print(p)
whatever <- dev.off()
par(lwd=1)
@

\renewcommand{\arraystretch}{.6}
\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Mean outcomes by arm and period\label{fig MeanOutcomes}}\\
\hfil\includegraphics[width = 11cm]{\Sexpr{    paste0(pathprogram, "figure/EstimationMemo/MeanOutcomesByArmAndPeriod.pdf")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{.75cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Survey data.\\
Note:& Points indicate means, vertical bars indicate 95\% confidence intervals. 
\textsf{NumCows} is number of cattle owned. \textsf{NetValue} is net asset values per housheold for asset items observed in all 4 rounds. %\textsf{NarrowNetValue} is net asset values per housheold for asset items observed in all 4 rounds excluding cassette players, radios. %\textsf{NetBroadValue} is net asset values per housheold for all asset items. \textsf{RNetValue} and \textsf{RNarrowNetValue} are winsorised equivalents to \textsf{RNetValue} and \textsf{NarrowNetValue} with cassette players, radios winsorised at BDT 20000 and bicycles at BDT 2000. %and \textsf{RNetBroadValue} are and \textsf{NetBroadValue}.  
\textsf{Consumption} is annualised per capita consumption in Taka. Per capita consumption is a total of food, hygiene, social, and energy expenditure divided by the number of household members. In-kind consumption of home made products is imputed at median prices. \textsf{HHIncomes} is labour incomes of household, \textsf{pcHHIncomes} is per capita housheold labour incomes. \textsf{Sch0512}, \textsf{Sch1315}, \textsf{Sch1618} are enrollment at primary, secondary, and tertiary levels. \textsf{Female} and \textsf{Male} are female and male enrollment, respectively. \\[1ex]
\end{tabular}
}

\renewcommand{\arraystretch}{.6}
\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Mean asset outcomes by arm and period\label{fig MeanAssetOutcomes}}\\
\hfil\includegraphics[width = 11cm]{\Sexpr{    paste0(pathprogram, "figure/EstimationMemo/MeanAssetOutcomesByArmAndPeriod.pdf")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Survey data.\\
Note:& Points indicate means, vertical bars indicate 95\% confidence intervals. \textsf{NetAssets} is total assets less debt outstanding to all sources. 
\textsf{Livestock and productive assets} is total assets less household assets and debt outstanding to all sources. \\[1ex]
\end{tabular}
}

\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Mean income and consumption outcomes by arm and period\label{fig MeanICOutcomes}}\\
\hfil\includegraphics[width = 6cm]{\Sexpr{    paste0(pathprogram, "figure/EstimationMemo/MeanConsumptionIncomeDodge.pdf")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Survey data.\\
Note:& Points indicate means, vertical bars indicate 95\% confidence intervals. 
\textsf{Consumption} is annualised per capita consumption in Taka. Per capita consumption is a total of food, hygiene, social, and energy expenditure divided by the number of household members. In-kind consumption of home made products is imputed at median prices. \textsf{Incomes} is labour incomes of household in 1000 Taka units. \\[1ex]
\end{tabular}
}


\subsection{Graphs of repayments}

In \textsc{\normalsize Table \ref{tab DestatByArm using both}}, one sees that later receivers of \textsf{large grace} and \textsf{cattle} arm members could prepare better by saving before disbursement. 
<<form sample data for repayment graphs, eval = T, warning = F, cache = F>>=
source(paste0(pathprogram, "FormSampleCommandsOnly.R"))
@
<<later receivers, results = 'hide'>>=
for (aobj in c("ar", "arA", "arACompletePanel")) {
  aob <- get(aobj)
  summary(aob[MonthsElapsed < -24, .(groupid = factor(groupid), 
    Arm, hhid, DisDate = factor(DisDate1), Date = factor(Date), tee, BStatus, 
    value.repay, value.missw, value.NetSaving)])
  aob[, c("DisYear1", "DisYear2", "DisYear3") := 2013]
  for (yy in 2014:2017) 
    for (i in 1:3)
    aob[format(eval(parse(text=paste0("DisDate", i))), format = "%Y") == yy, 
      (paste0("DisYear", i)) := yy]
  aob[!grepl("tra", Arm), c("DisYear2", "DisYear3") := NA]
  print( grepout("Year$", colnames(aob)))
  # Accumulated saving at disbursement: ar (roster based) starts from 2014, so skip.
  if (grepl("arA", aobj)) {
    AcmSv <- rbindlist(
    list(
      aob[o800 == 1 & MonthsElapsed == 1, .(
        MeanNetSaving = mean(CumNetSaving), 
        StdNetSaving = var(CumNetSaving)^(.5), 
        Num = .N
      ), by = .(Arm, DisYear1)][order(Arm, DisYear1), ], 
      aob[o800 == 1 & !is.na(DisYear2) & MonthsElapsed == 13, .(
        MeanEffNetSaving = mean(CumRepaid-CumPlannedInstallment+CumNetSaving), 
        StdEffNetSaving = var(CumRepaid-CumPlannedInstallment+CumNetSaving)^(.5), 
        Num = .N), by = .(Arm, DisYear2)][order(Arm, DisYear2), ],
      aob[o800 == 1 & !is.na(DisYear3) & MonthsElapsed == 25, .(
        MeanEffNetSaving = mean(CumRepaid-CumPlannedInstallment+CumNetSaving), 
        StdEffNetSaving = var(CumRepaid-CumPlannedInstallment+CumNetSaving)^(.5), 
        Num = .N), by = .(Arm, DisYear3)][order(Arm, DisYear3), ])
    , fill = T) 
    setnames(AcmSv, "DisYear1", "DisYear")
    setkey(AcmSv, Arm, DisYear)
    AcmSv[, LoanAmount := 16800]
    AcmSv[grepl("trad", Arm), LoanAmount := 16800/3]
    AcmSv[, NetSavRate := round((MeanNetSaving/LoanAmount)*100, 2)]
    AcmSv[, StdNetSavRate := StdNetSaving/LoanAmount]
    AcmSv[, NetSavRateUB := NetSavRate + 1.96*StdNetSavRate]
    AcmSv[, NetSavRateLB := NetSavRate - 1.96*StdNetSavRate]
    # keep only first disbursements
    AcmSv <- AcmSv[!(grepl("tra", Arm) & DisYear != 2013), ]
    # accumulated savings
    AcS <- reshape(AcmSv, direction = "wide", idvar = "Arm",
      timevar = "DisYear", v.names = grepout("Me|N", colnames(AcmSv))
      )
    cn <- colnames(AcS)
    AcS <- data.table(t(AcS[, -(1:2)]))
    AcS <- cbind(variables = cn[-(1:2)], AcS)
    setnames(AcS, c("variables", armsC))
    AcS[grepl("^Net", variables), ][, variables := gsub("\\.", " disbursed in ", variables)][
      , variables := gsub("NetSavRate", "Net saving (\\\\\\% of loan)", variables)][]
    AcS[, (armsC) := lapply(.SD, formatC, digits = 2, format = "f"), .SDcol = armsC]
  } else AcS <- NULL
  assign(paste0("AcS.", aobj), AcS)
}
@
One also sees that \textsf{traditional} has lower repayment rates in the 2nd and 3rd loan years. This can be due to lower returns on small assets, or, moral hazard that they get new disbursements irrespective of loan delinquency. 
<<mean repayment by Arm and LoanYear>>=
SumMeanStd <- function(x, NARM = T) {
  nx <- names(x)
  if (is.null(dim(x))) x <- matrix(x)
  ms <- c(
      apply(x, 2, sum, na.rm = NARM), 
      apply(x, 2, mean, na.rm = NARM), 
      apply(x, 2, function(z) var(z, na.rm = NARM)^.5),
      apply(x, 2, function(z) length(z[!is.na(z)]))
    )
  names(ms) <- paste0(nx, rep(c(".sum", ".mean", ".std", ".N"), each = ncol(x)))
  return(ms) 
}
#for (Tee in seq(12, 48, 12))
#rbind(des.repay,
#     arA[!grepl("drop", Mgroup) & grepl("oldMem", Mstatus) & 
#       !grepl("pure saver", BorrowerStatus) 
#       &  MonthsElapsed == Tee, as.list(unlist(lapply(.SD, MeanAndStd))), 
#      .SDcols = c("CumRepaid", "CumMisses"), by = Arm]
ass <- readRDS(paste0(pathsaveHere, DataFileNames[4], "Trimmed.rds"))
for (aobj in c("ar", "arA", "arACompletePanel")) {
  aob <- get(aobj)
  atab <- 
      aob[o800 == 1 & !grepl("drop", Mgroup) & grepl("oldMem", Mstatus) & 
        !grepl("pure saver", BStatus), .(N=.N), by = .(Arm, hhid, LoanYear)]
  if (nrow(atab[hhid %in% hhid[N>12], ]) <= 0) cat(aobj, ": Number of member entries are less than 12 per year (good).\n")
  # Below shows value.missw is not a reliable variable. It is not consistent with value.repay.
  #aob[, .(Arm,hhid, tee, value.repay, value.missw,CumRepaid, CumPlannedInstallment)][1:48+48*1,]
  aob[, value.NotPaid := value.repay == 0, by = hhid]
  aob[, value.NotPaid := as.numeric(value.NotPaid), by = hhid]
  print( grepout("Year$", colnames(aob)))
  atab <-
      aob[o800 == 1 & !grepl("drop", Mgroup) & grepl("oldMem", Mstatus) & 
        !grepl("pure saver", BStatus) & !is.na(LYear) &
        hhid %in% hhid[value.NotPaid > 0], 
        .(Arm, hhid, LYear, tee, value.repay, value.NotPaid)]
  # Ignore entries with DisDate1 = NA (8169303  8169305  8169306  8169316) all traditional arm
  # which causes LYear to be NA. These entries have repaid all debts, so dropping them 
  # will cause underevaluation of traditional arm repayments.
  setnames(aob, "EffectiveRepayment", "value.EffRepay")
  des.repay <- 
      aob[o800 == 1 & !grepl("drop", Mgroup) & grepl("oldMem", Mstatus) & 
        !grepl("pure saver", BStatus), 
        as.list(unlist(lapply(.SD, SumMeanStd))), 
        .SDcols = c("value.repay", "value.NotPaid", "value.EffRepay"), 
        by = .(Arm, hhid, LYear)]
  setkey(des.repay, hhid, LYear)
  des.repay <- des.repay[!is.na(LYear), ]
  setkey(des.repay, Arm, hhid, LYear)
  setnames(des.repay, 
    grepout("\\.", colnames(des.repay))
    , gsub("\\.\\.", "", grepout("\\.", colnames(des.repay)))
    )
  #des.rep <- reshape(des.repay, direction = "wide", idvar = "Arm",
  #  timevar = "LYear", v.names = grepout("\\.", colnames(des.repay)))
  #desrep <- t(des.rep[, -1])
  des.repay[, grepout("std|mean", colnames(des.repay)) := NULL]
  des.rep = copy(reshape(des.repay, direction = "long", idvar = c("Arm", "hhid", "LYear"),
    varying = grepout("\\.", colnames(des.repay))))
  des.rep[, type := "sum"]
  des.rep[grepl("N$", time), type := "N"]
  des.rep[, variable := "repay"]
  des.rep[grepl("Not", time), variable := "NotPaid"]
  des.rep[grepl("Eff", time), variable := "EffRepayment"]
  des.rep[, variable := factor(variable)]
  # pick only the maximum values of each year (cumulative sum of entire year) for each member
  des.rep[, .(cumsum = max(value)), by = .(Arm, hhid, variable, type, LYear)]
  setkey(des.rep, Arm, hhid, variable, type, LYear)
  desrep <- des.rep[, .(total = sum(value)), by = .(hhid, variable, type, Arm, LYear)]
  desrep <- desrep[, .(meantotal = mean(total), length = .N), by = .(variable, type, Arm, LYear)]
  desrep[, length := NULL]
  desrep <- desrep[grepl("sum|N", type) & grepl("epay", variable), ]
  setkey(desrep, type, Arm, LYear)
  desrepW <- reshape(desrep, direction = "wide", 
    idvar = c("variable", "type", "LYear"), timevar = "Arm",
    v.names = grepout("meant|len", colnames(desrep)))
  desrepW <- desrepW[grepl("sum", type), ]
  desrepW[, variables := paste0("Repaid amount in Loan Year", LYear)]
  desrepW[grepl("Eff", variable), variables := paste0("Net saving + repaid amount in Loan Year", LYear)]
  setkey(desrepW, variable, LYear)
  desrepW[, c("variable", "type", "LYear") := NULL]
  setnames(desrepW, c(ArmsC, "variable"))
  setcolorder(desrepW, c("variable", ArmsC))
  #desrepW[, variables := paste0(type, " in Loan Year", LY)]
  desrepW <- 
    rbind(
      desrepW[grepl("^Re", variable), ], 
      t(matrix(c("Total repaid sum", apply(desrepW[grepl("^Re", variable), -1], 2, sum)))),
      desrepW[!grepl("^Re", variable), ], 
      t(matrix(c("Net saving + total repaid sum", apply(desrepW[!grepl("^Re", variable), -1], 2, sum))))
    , use.names = F)
  desrepW[, (ArmsC) := lapply(.SD, function(x) formatC(as.numeric(x), digits = 0, format = "f")), 
    .SDcols = ArmsC]
  # rename columns to match other descriptive stat objs
  setnames(desrepW, c("variables", "traditional", "large", "large grace", "cow"))
  desRep <- desrepW
  assign(paste0("desRep.", aobj), desRep)
  saveRDS(aob, paste0(pathsaveHere, "temp", aobj, ".rds"))
}
@
One may worry if flood affected repayments. Split sample into flood affected and unaffected. Affected by flood does not seem to change the repayment numbers.
<<repayment by flood shock, warning = F>>=
for (aobj in c("ar", "arA", "arACompletePanel")) {
  cat(aobj, "\n")
  # just for printing in knitr
  aob <- get(aobj)
  aob <- readRDS(paste0(pathsaveHere, "temp", aobj, ".rds"))
  desN <- get(paste0("desN.", aobj))
  # Summary by flood status.
  # Sum entries by year for each HHs, then take mean per arm.
  for (i in 0:1) {
    # sum per hh
    des.repay0 <- 
        aob[!grepl("drop", Mgroup) & grepl("oldMem", Mstatus) & 
          !grepl("pure saver", BStatus) & FloodInRd1 == i, 
          as.list(unlist(lapply(.SD, SumMeanStd))), 
          .SDcols = c("value.repay", "value.NotPaid"), 
          by = .(Arm, hhid, LYear)]
    des.repay0[, grepout("std|mean|N$", colnames(des.repay0)) := NULL]
    # take mean per arm
    des.repay <- 
      des.repay0[, lapply(.SD, mean), 
          .SDcols = grepout("value", colnames(des.repay0)), 
          by = .(Arm, LYear)]
    setkey(des.repay, Arm, LYear)
    des.rep <- reshape(des.repay, direction = "wide", idvar = "Arm",
      timevar = "LYear", v.names = grepout("\\.", colnames(des.repay)))
    desrep <- t(des.rep[, -1])
    colnames(desrep) <- des.rep[, Arm]
    rn <- rownames(desrep)
    desrep <- data.table(desrep)
    desrep[, variables := gsub("value\\.(.*?)\\..*$", "\\1", rn)]
    desrep[, stat := gsub("^.*\\.\\.(.*?)\\..*$", "\\1", rn)]
    desrep[, LY := as.numeric(gsub("^.*\\.(-?.)$", "\\1", rn))]
    desrep <- desrep[grepl("sum", stat) & LY >= -1, ]
    setkey(desrep, variables, LY)
    desrep[, variables := paste0(variables, " in Loan Year", LY)]
    desrep[, LY := NULL]
    setcolorder(desrep, c("variables", "traditional", "large", "large grace", "cattle"))
    desrep <- rbind(desrep, 
      t(c("Total repayment", apply(desrep[grepl("^repay", variables), 2:5], 2, sum), "sum"))
      , use.names = F)
    if (grepl("arA", aobj)) {
      desrep[, (armsC) := lapply(.SD, function(x) formatC(as.numeric(x), digits=2, format = "f")), 
        .SDcols = armsC]
      cat(paste0("Flood dummy = ", i, "\n"))
      print(desrep[grepl("repay", variables), ])
    }
  }
}
@
Combine descriptive statistics and produce \LaTeX  tables.
<<combine destats, warning = F>>=
for (aobj in c("ar", "arA", "arACompletePanel")) {
  desH <- get(paste0("desH.", aobj))
  AcS <- get(paste0("AcS.", aobj))
  desRep <- get(paste0("desRep.", aobj))
  desN <- get(paste0("desN.", aobj))
  if (any(grepl("cattle", colnames(desH)))) setnames(desH, "cattle", "cow")
  if (any(grepl("cattle", colnames(AcS)))) setnames(AcS, "cattle", "cow")
  if (any(grepl("cattle", colnames(desRep)))) setnames(desRep, "cattle", "cow")
  if (grepl("arA", aobj)) 
    des <- rbindlist(list(desH,
      AcS[grepl("^Net", variables), ][, variables := 
        gsub("\\.", " in ", variables)][
        , variables := gsub("NetSavRate", "Net saving (\\\\\\% of loan)", variables)][],
      desRep), use.names = T, fill = T
    ) else
    des <- rbindlist(list(desH, desRep), use.names = T, fill = T)
  if (any(grepl("^stat$", colnames(des)))) des[, stat := NULL]
  des <- des[!grepl("[LU]B|miss", variables), ]
  desN2 <- c("Number of loan receiving members", 
      t(matrix(unlist(desN[, 2, with = F][c(4, 1, 3, 2)]))))
  if (aobj == "ar") desN2[1] <- "Number of members"
  des <- rbind(as.matrix(des), 
    if (aobj == "arA") "Number of loan receiving members" = desN2 else
    "Number of members" = desN2 
    #,"Number of loan recipients" = as.matrix(desRepN[, -ncol(desRepN), with = F])
    )
  des <- data.table(des)
  des[, variables := gsub("EffRepay", "Effective repayment", variables)]
  des[, variables := gsub("repay", "Repayment", variables)]
  des[, variables := gsub("^total repaid.*", "Total repaid amount", variables)]
  des[, variables := gsub("LYear", "Loan Year ", variables)]
  des[, variables := gsub("Head", "Head ", variables)]
  des[, variables := gsub("HH", "Household ", variables)]
  des[, variables := gsub("^Fl.*", "Flood in round 1", variables)]
  setnames(des, "cow", "cattle")
  DestatByArm <- latextab(as.matrix(des),
    hleft = c("\\scriptsize\\hfill ", rep("\\scriptsize\\hfil$", ncol(des)-1)), 
    hcenter = c(5, rep(1.05, ncol(des)-1)), 
    hright = c("", rep("$", ncol(des)-1)), 
    headercolor = "gray80", adjustlineskip = "-.2ex", delimiterline= NULL,
    alternatecolor = "gray90")
  write.tablev(DestatByArm,  
    paste0(pathsaveHere, "DestatByArm", aobj, ".tex")
    , colnamestrue = F)
  assign(paste0("des", aobj), des)
}
des1st <- desar[!grepl("^Re|^Total|^Net", variables), ]
desboth <- rbind(des1st,  t(rep("", ncol(des1st))), desarA, use.names = F)
DestatByArmBoth <- latextab(as.matrix(desboth),
  hleft = c("\\scriptsize\\hfill ", rep("\\scriptsize\\hfil$", ncol(desboth)-1)), 
  hcenter = c(5, rep(1.05, ncol(desboth)-1)), 
  hright = c("", rep("$", ncol(desboth)-1)), 
  headercolor = "gray80", adjustlineskip = "-.2ex", delimiterline= NULL,
  alternatecolor = "gray90",
  LastDiffVariable = "^Number of members$",
  SepLineText = "{\\footnotesize Only loan receiving members}", inter.with = "",
  AdjustInterWith = 0, InterWithLength = "0em")
DestatByArmBoth[9, ] <- paste0(DestatByArmBoth[9, ], "[-2ex]")
DestatByArmBoth <- rbind(
    DestatByArmBoth[1:3, , drop = F],
    matrix("\\rowcolor{gray90}\\multicolumn{5}{l}{\\textit{\\footnotesize {\\footnotesize All members} }}\\\\"), 
    DestatByArmBoth[-(1:3), , drop = F]
  )
write.tablev(DestatByArmBoth,  
  paste0(pathsaveHere, "DestatByArmBoth.tex")
  , colnamestrue = F)
@

\hspace{-1cm}\begin{minipage}[t]{14cm}
\hfil\textsc{\normalsize Table \refstepcounter{table}\thetable: Descriptive statistics by arm for all households including nonparticipants\label{tab DestatByArm using ar}}\\
\setlength{\tabcolsep}{1pt}
\setlength{\baselineskip}{8pt}
\renewcommand{\arraystretch}{.55}
\hfil\begin{tikzpicture}
\node (tbl) {\input{\Sexpr{paste0(pathsaveHere, "DestatByArmar.tex")}}};
\end{tikzpicture}\\
\renewcommand{\arraystretch}{.8}
\setlength{\tabcolsep}{1pt}
\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\hfill\scriptsize}p{.25cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source:& \multicolumn{2}{l}{\mpage{12cm}{\scriptsize Estimated with GUK administrative and survey data. Based on data \textsf{ar} which has all survey respondents. Survey respondents include nonparticipants to the experimental part of study.}}\\
Notes: & 1. & Information of original 776 households. Net saving as percentage of loan amount is a mean over loan recipients whose first disbursement is in 2013. Effective repayment is a sum of repayment and net saving. 
\end{tabular}
\end{minipage}

\hspace{-1cm}\begin{minipage}[t]{14cm}
\hfil\textsc{\normalsize Table \refstepcounter{table}\thetable: Descriptive statistics by arm for borrowers\label{tab DestatByArm using arA}}\\
\setlength{\tabcolsep}{1pt}
\setlength{\baselineskip}{8pt}
\renewcommand{\arraystretch}{.55}
\hfil\begin{tikzpicture}
\node (tbl) {\input{\Sexpr{paste0(pathsaveHere, "DestatByArmarA.tex")}}};
\end{tikzpicture}\\
\renewcommand{\arraystretch}{.8}
\setlength{\tabcolsep}{1pt}
\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\hfill\scriptsize}p{.25cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source:& \multicolumn{2}{l}{\mpage{12cm}{\scriptsize Estimated with GUK administrative and survey data. Based on \textsf{arA} which has only borrowers and does not include nonparticipants.}}\\
Notes: & 1. & Information of borrowing members among original 776 households. Net saving as percentage of loan amount is a mean over loan recipients whose first disbursement is in 2013. Effective repayment is a sum of repayment and net saving. \\
& 2. & \textsf{Loan year} -1 is preparation period for loan disbursement when only saving is allowed. \\
\end{tabular}
\end{minipage}


\hspace{-1cm}\begin{minipage}[t]{14cm}
\hfil\textsc{\normalsize Table \refstepcounter{table}\thetable: Descriptive statistics by arm for borrowers, complete panel\label{tab DestatByArm using arACompletePanel}}\\
\setlength{\tabcolsep}{1pt}
\setlength{\baselineskip}{8pt}
\renewcommand{\arraystretch}{.55}
\hfil\begin{tikzpicture}
\node (tbl) {\input{\Sexpr{paste0(pathsaveHere, "DestatByArmarACompletePanel.tex")}}};
\end{tikzpicture}\\
\renewcommand{\arraystretch}{.8}
\setlength{\tabcolsep}{1pt}
\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\hfill\scriptsize}p{.25cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source:& \multicolumn{2}{l}{\mpage{12cm}{\scriptsize Estimated with GUK administrative and survey data. Based on \textsf{arACompletePanel} which has only non-attriting members who were surveyed at period 2.}}\\
Notes: & 1. & Information of borrowing members among original 776 households. Net saving as percentage of loan amount is a mean over loan recipients whose first disbursement is in 2013. Effective repayment is a sum of repayment and net saving. \\
& 2. & \textsf{Loan year} -1 is preparation period for loan disbursement when only saving is allowed. \\
\end{tabular}
\end{minipage}

\hspace{-1cm}\begin{minipage}[t]{14cm}
\hfil\textsc{\normalsize Table \refstepcounter{table}\thetable: Descriptive statistics by arm for all members and borrowing members\label{tab DestatByArm using both}}\\
\setlength{\tabcolsep}{1pt}
\setlength{\baselineskip}{8pt}
\renewcommand{\arraystretch}{.55}
\hfil\begin{tikzpicture}
\node (tbl) {\input{\Sexpr{paste0(pathsaveHere, "DestatByArmBoth.tex")}}};
\end{tikzpicture}\\
\renewcommand{\arraystretch}{.8}
\setlength{\tabcolsep}{1pt}
\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\hfill\scriptsize}p{.25cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source:& \multicolumn{2}{l}{\mpage{12cm}{\scriptsize Estimated with GUK administrative and survey data. Based on data \textsf{ar} which has all survey respondents. }}\\
Note: &  \multicolumn{2}{l}{\scriptsize All members are 776 households. Survey respondents include nonparticipants to the experimental part of study.  }
\end{tabular}
\end{minipage}


\section{Estimation using initial sample HHs}


\subsection{Repayment and net saving}
\Sexpr{
knit_child(paste0(pathprogram, "subsection_RepaymentAndNetSaving.rnw"))
}
\subsection{Schooling}
\Sexpr{
knit_child(paste0(pathprogram, "subsection_Schooling.rnw"))
}
\subsection{Incomes}
\Sexpr{
knit_child(paste0(pathprogram, "subsection_Incomes.rnw"))
}
\subsection{Consumption}
\Sexpr{
knit_child(paste0(pathprogram, "subsection_Consumption.rnw"))
}
\Sexpr{
knit_child(paste0(pathprogram, "subsection_ConsumptionOLS.rnw"))
}

\subsection{Assets}

%\subsubsection{Assets}
\Sexpr{
#knit_child(paste0(pathprogram, "subsubsection_Assets.rnw"))
}
\subsubsection{Homestead land}
\Sexpr{
knit_child(paste0(pathprogram, "subsubsection_HomesteadLand.rnw"))
}
<<>>=
sec <- "homestead"
@
%\subsubsection{Farm land}
\Sexpr{
#knit_child(paste0(pathprogram, "subsubsection_FarmLand.rnw"))
}
\subsubsection{Livestock, number of cattle}
\Sexpr{
knit_child(paste0(pathprogram, "subsubsection_Livestock.rnw"))
}
<<>>=
sec <- "livestock"
@

\subsubsection{Productive assets}
\Sexpr{
knit_child(paste0(pathprogram, "subsubsection_ProductiveAssets.rnw"))
}
<<>>=
sec <- "passets"
@

\subsubsection{Narrow productive assets}
\Sexpr{
knit_child(paste0(pathprogram, "subsubsection_NarrowProductiveAssets.rnw"))
}
<<>>=
sec <- "npassets"
@

\subsubsection{Productive assets+livestock}
\Sexpr{
knit_child(paste0(pathprogram, "subsubsection_ProductiveAssetsLivestock.rnw"))
}
<<>>=
sec <- "passetslivestock"
@

% \subsubsection{Assets+Livestock}
\Sexpr{
#knit_child(paste0(pathprogram, "subsubsection_Assets+Livestock.rnw"))
}
% \subsubsection{GUK broad net assets: Broad assets+Livestock-GUK Debt}
\Sexpr{
#knit_child(paste0(pathprogram, "subsubsection_BroadGUKNetAssets.rnw"))
}
\subsubsection{Net broad assets: Broad assets+Livestock-GUK Debt-Other Debts}

\Sexpr{
knit_child(paste0(pathprogram, "subsubsection_NetBroadAssets.rnw"))
}
<<>>=
sec <- "bnassets"
@
%\subsubsection{Narrow net assets: NarrowAssets+Livestock-GUK Debt-Other Debts}
\Sexpr{
#knit_child(paste0(pathprogram, "subsubsection_NarrowNetAssets.rnw"))
}
\subsubsection{Net assets: Assets+Livestock-GUK Debt-Other Debts}
\Sexpr{
knit_child(paste0(pathprogram, "subsubsection_NetAssets.rnw"))
}
<<>>=
sec <- "nassets"
@
%\subsubsection{Revised net assets: Winsorised Assets+Livestock-GUK Debt-Other Debts}
\Sexpr{
#knit_child(paste0(pathprogram, "subsubsection_RevisedNetAssets.rnw"))
}
%\subsubsection{Broad net non-livestock assets: Broad non-livestock assets-GUK Debt-Other Debts}
\Sexpr{
#knit_child(paste0(pathprogram, "subsubsection_BroadNetNLAssets.rnw"))
}
\subsubsection{Net non-livestock assets: Non-livestock assets-GUK Debt-Other Debts}
\Sexpr{
knit_child(paste0(pathprogram, "subsubsection_NetNLAssets.rnw"))
}
<<>>=
sec <- "nnlassets"
@
%\subsubsection{Narrow net non-livestock assets: Non-livestock assets-GUK Debt-Other Debts}
\Sexpr{
#knit_child(paste0(pathprogram, "subsubsection_NarrowNetNLAssets.rnw"))
}
\subsubsection{Cattle holding}

\Sexpr{
knit_child(paste0(pathprogram, "subsubsection_CattleHolding.rnw"))
}

\subsubsection{Net assets, experienced vs. inexperienced}
\Sexpr{
knit_child(paste0(pathprogram, "subsubsection_NetAssetsExperiencedVSInexperienced.rnw"))
}
<<>>=
sec <- "nassetsbyexperience"
@
\subsubsection{Livestock, experienced vs. inexperienced}
\Sexpr{
knit_child(paste0(pathprogram, "subsubsection_LivestockExperiencedVSInexperienced.rnw"))
}
<<>>=
sec <- "livestockbyexperience"
@
\subsubsection{Cattle holding, experienced vs. inexperienced}

\Sexpr{
knit_child(paste0(pathprogram, "subsubsection_CattleHoldingExperiencedVSInexperienced.rnw"))
}
<<>>=
sec <- "cattlebyexperience"
@


\section{Estimation using complete panel HHs in household assets}


This section uses subsample limited to households which gives complete panel of household assets. 

\subsection{Assets}

\subsubsection{Productive assets}
\Sexpr{
knit_child(paste0(pathprogram, "subsubsection_CPProductiveAssets.rnw"))
}
\subsubsection{Net assets: Assets+Livestock-GUK Debt-Other Debts}
\Sexpr{
knit_child(paste0(pathprogram, "subsubsection_CPNetAssets.rnw"))
}
%\subsubsection{Narrow net assets: NarrowAssets+Livestock-GUK Debt-Other Debts}
\Sexpr{
#knit_child(paste0(pathprogram, "subsubsection_CPNarrowNetAssets.rnw"))
}


\section{Summarising results}


\subsection{Counting observations used in ANCOVA estimation}

<<read initial sample data>>=
arA <- readRDS(paste0(pathsaveHere, DataFileNames[2], "Trimmed.rds"))
ar <- readRDS(paste0(pathsaveHere, DataFileNames[3], "Trimmed.rds"))
setkey(ar, Arm, BStatus, o800, survey)
ar[, Num := 1:.N, by = .(survey, Arm, BStatus, o800)]
ar[o800==1, .(Num = Num, N = length(unique(hhid))), 
  by = .(survey, Arm, BStatus)][Num==1, ]
ar[, MaxTee := max(tee), by = hhid]
# HHs with incomplete obs but wrongly classified as nonattriting
ar[hhid %in% hhid[AttritIn == 9 & MaxTee < 4] & tee == 1, 
  .(Arm, hhid, tee, MaxTee, AttritIn, BStatus, creditstatus, Mgroup)][order(Arm, hhid), ]
LostHHs <- ar[
  hhid %in% hhid[o800 == 1 & grepl("tra", Arm) & grepl("b", BStatus) 
  & survey == 1] &
  !(hhid %in% hhid[o800 == 1 & grepl("tra", Arm) & grepl("b", BStatus) 
  & survey == 2]) & tee == MaxTee, hhid]
summary(ass[hhid %in% LostHHs, .(Arm, TradGroup, BStatus, 
  hhid, survey=factor(survey), NLAssetAmount)])
lvo[hhid %in% LostHHs, .(Arm, BStatus, hhid, survey, NumCows)]  
con[hhid %in% LostHHs, .(BStatus, hhid, tee)]  
ass[o800==1 & grepl("tr", Arm), .(Num = 1:.N, N = length(unique(hhid))), 
  by = .(survey, BStatus)][Num==1, ]
# Di: Data before estimation
gc()
DataFileNames2 <- DataFileNames[-c(2, 6)]
Di0 <- lapply(1:length(DataFileNames2), function(i) 
  readRDS(paste0(pathsaveHere, DataFileNames2[i], "InitialSample.rds")))
Di0 <- lapply(Di0, function(x) x[o800 == 1, ])
picktee <- function(Period, x) switch(Period, Min = min(x), Max = max(x))
picktee("Min", 1:10)
picktee("Max", 1:10)
Di1 <- 
  lapply(Di0, function(x) addmargins(table0(x[tee == min(tee, na.rm = T) , .(BStatus, Arm)])))
Di4 <- 
  lapply(Di0, function(x) addmargins(table0(x[tee == max(tee, na.rm = T) , .(BStatus, Arm)])))
names(Di1) <- names(Di4) <- DataFileNames2
Di <- lapply(Di0, function(x) {
  x0 <- addmargins(
    table0(x[tee == min(tee, na.rm = T), .(BStatus, Arm)]))
  x1 <- data.frame(as.matrix.data.frame(x0))
  dxr <- dimnames(x0)[[1]]; dxr[is.na(dxr)] <- "NA"
  dxc <- dimnames(x0)[[2]]; dxc[is.na(dxc)] <- "NA"
  dimnames(x1) <- list(dxr, dxc)
  x1 <- data.table(x1)
  x1[, BStatus := dxr]
  return(x1)
  })
Di <- lapply(1:length(Di), function(i)Di[[i]][, File := DataFileNames2[i]])
Di <- rbindlist(Di, use.names = T, fill = T)
Di[, File := c(File[1], rep("", .N-1)), by = File]
Di <- Di[!grepl("pu", BStatus), ]
setcolorder(Di, c("File", "BStatus", armsC, "Sum"))
write.tablev(
 latextab(as.matrix(Di), 
    hleft = c(rep("\\footnotesize\\hfill", 2), rep("\\hfil\\footnotesize$", ncol(Di)-2)),
    hcenter = c(rep(2.8, 2), rep(.95, ncol(Di)-2)),
    hright = c("", "", rep("$", ncol(Di)-2)),
    alternatecolorManualColor = "gray90", 
    alternatecolorManual = c(seq(7, nrow(Di)+2, 10), seq(8, nrow(Di)+2, 10), 
      seq(9, nrow(Di)+2, 10), seq(10, nrow(Di)+2, 10), seq(11, nrow(Di)+2, 10)),
    addheaderAbove = paste0("(", letters[1:ncol(Di)], ")"), 
    headercolor = "paleblue")
  , paste0(pathprogram, 
      "table/EstimationMemo/NumObsByBStatusArmFile.tex")
  , colnamestrue = F)
qsave(Di, paste0(pathsaveHere, "NumObs.qs"))
rm(Di0)
# Dr: Data used in estimation, last period
DataUsedInEstimation <- c(
  "Schooling", "Repayment", "Asset", "AssetRobustness", "Land",
  "Livestock", "NumCows", "AssetLivestock", "NetAssetGUK", "NetAsset",
  "LabourIncome", "FarmIncome", "Consumption")
Dr00 <- lapply(1:length(DataUsedInEstimation), function(i) 
  readRDS(paste0(pathsaveHere, "ANCOVA_", DataUsedInEstimation[i], ".rds")))
names(Dr00) <- DataUsedInEstimation
# Dr0: Last base-regression specification in Dr00[[outcome]][[regtype]][[specification]]
Dr0 <- lapply(
    # choose 1st regtype (base)
    # and get the last specification
  lapply(Dr00, function(x) x[[1]][[length(x[[1]])]])
  ,
  # then pick the element with the name "data"
  function(z) z$data)
names(Dr0) <- names(Dr00)	
# for assets and consumption, 
#  last entry with 6M covariates has only 3 rounds (T=2, 3)
# so use [[4]]th regression specification of "incl1" [[1]] regressions.
Dr0[["Asset"]] <- Dr00[["Asset"]][[1]][[4]]$data
Dr0[["Consumption"]] <- Dr00[["Consumption"]][[1]][[4]]$data
arid <- unique(arA[, .(hhid, Arm, BStatus)])
# only some lack BStatus
#Dr0 <- lapply(Dr0, function(z) merge(z, arid, by = "hhid", all.x= T))
#Dr0[[1]] <- merge(Dr0[[1]], arid, by = "hhid", all.x= T)
#Dr0[[6]] <- merge(Dr0[[6]], arid, by = "hhid", all.x= T)
#Dr0[[2]][, hhid := as.numeric(gsub("\\..*", "", HHMid))]
for (m in c(3, 4, 8:10)) Dr0[[m]][, Arm := factor(Arm, labels = armsC)]
for (k in 1:2) {
  Dr <- lapply(Dr0, function(x) {
    x0 <- addmargins(
      table0(x[tee == picktee(c("Min", "Max")[k], tee), .(BStatus, Arm)]), 
        1:2, sum, quiet = T)
    x1 <- data.frame(as.matrix.data.frame(x0))
    dxr <- dimnames(x0)[[1]]; dxr[is.na(dxr)] <- "NA"
    dxc <- dimnames(x0)[[2]]; dxc[is.na(dxc)] <- "NA"
    dimnames(x1) <- list(dxr, dxc)
    x1 <- data.table(x1)
    x1[, BStatus := dxr]
    return(x1)
    })
  Dr <- lapply(1:length(Dr), function(i)Dr[[i]][, File := names(Dr0)[i]])
  Dr <- rbindlist(Dr, use.names = T, fill = T)
  setcolorder(Dr, c("File", "BStatus", armsC, "sum"))
  Dr <- Dr[!grepl("pure", BStatus), ]
  assign(paste0("Dr", k), Dr)
  write.tablev(
   latextab(as.matrix(Dr), 
      hleft = c(rep("\\footnotesize\\hfill", 2), rep("\\hfil\\footnotesize$", ncol(Dr)-2)),
      hcenter = c(rep(2.2, 2), rep(.95, ncol(Dr)-2)),
      hright = c("", "", rep("$", ncol(Dr)-2)),
      alternatecolorManualColor = "gray90", 
      alternatecolorManual = c(seq(7, nrow(Dr)+2, 10), seq(8, nrow(Dr)+2, 10), 
        seq(9, nrow(Dr)+2, 10), seq(10, nrow(Dr)+2, 10), seq(11, nrow(Dr)+2, 10)),
      addheaderAbove = paste0("(", letters[1:ncol(Dr)], ")"), 
      headercolor = "paleblue")
    , paste0(pathprogram, 
        "table/EstimationMemo/NumObsByBStatusArmRegUsed", 
        c("Min", "Max")[k], ".tex")
    , colnamestrue = F)
  saveRDS(Dr, paste0(pathsaveHere, "NumObsUsedInEstimation", 
    c("Min", "Max")[k], ".rds"))
}
qsave(Dr0, paste0(pathsaveHere, "DataInList_UsedInEstimation.qs"))
rm(Dr00)
rm(Dr0)
@

\renewcommand{\arraystretch}{.55}
\mpage{\linewidth}{
\hfil\textsc{\footnotesize Table \refstepcounter{table}\thetable: Number of observations by borrower status and arm\label{tab NumObsByBStatusArmFile}}\\
\hfil\input{\Sexpr{  paste0(pathprogram, "table/EstimationMemo/NumObsByBStatusArmFile.tex")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Survey data.\\
Note:&  \\[1ex]
\end{tabular}
}

\renewcommand{\arraystretch}{.55}
\mpage{\linewidth}{
\hfil\textsc{\footnotesize Table \refstepcounter{table}\thetable: Number of observations used in estimation by borrower status and arm at period 1\label{tab NumObsByBStatusArmRegUsedMin}}\\
\hfil\input{\Sexpr{  paste0(pathprogram, "table/EstimationMemo/NumObsByBStatusArmRegUsedMin.tex")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Survey data.\\
Note:&  \\[1ex]
\end{tabular}
}

\renewcommand{\arraystretch}{.55}
\mpage{\linewidth}{
\hfil\textsc{\footnotesize Table \refstepcounter{table}\thetable: Number of observations used in estimation by borrower status and arm at last period\label{tab NumObsByBStatusArmRegUsedMax}}\\
\hfil\input{\Sexpr{  paste0(pathprogram, "table/EstimationMemo/NumObsByBStatusArmRegUsedMax.tex")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Survey data.\\
Note:&  \\[1ex]
\end{tabular}
}


\subsection{IGA}

IGA info is from \textsf{\scriptsize \Sexpr{gsub("\\_", "\\\\_", list.files(path = pathcleaned, pattern = "Ad.*ta.dta$", full.names = T))}}. 
<<tabulate iga patterns, warning = F>>=
adw2 <- readRDS(paste0(path1234, "admin_data_wide2.rds"))
jds <- fread(paste0(pathreceived, "DataForJDS.prn"))
adw2[, o800 := 0L]
# need to use hhid (not groupid, because some o800 groups 
# have more than 20 members who are added after period 2)
adw2[hhid %in% jds[grepl("trea", treat), hhid], o800 := 1L]
adw2[, PurchaseDate1 := as.POSIXct(purchaseddate1stloan, format = "%d/%m/%Y")]
adw2[, PurchaseDate2 := as.POSIXct(purchaseddate2ndloan, format = "%d/%m/%Y")]
adw2[, PurchaseDate3 := as.POSIXct(purchaseddate3rdloan, format = "%d/%m/%Y")]
piga <- adw2[Tee == 1 & o800 == 1L, .(Arm, membershipstatus,
  PurchaseDate1, PurchaseDate2, PurchaseDate3, iga11st, iga12nd, iga13rd)]
setnames(piga, c("Arm", "membershipstatus", paste0(rep(c("PurchaseDate", "iga1"), each = 3), 1:3)))
piga[, PurchaseYear1 := as.integer(strftime(PurchaseDate1, format = "%Y"))]
piga[, PurchaseYear2 := as.integer(strftime(PurchaseDate2, format = "%Y"))]
piga[, PurchaseYear3 := as.integer(strftime(PurchaseDate3, format = "%Y"))]
piga[, (paste0("iga", 1:3)) := lapply(.SD, 
  function(x) {x <- as.character(x); x[grepl("Cow", x)] <- "cattle"; x[!is.na(x) & !grepl("cattle", x)] <- "other"; x}),
  .SDcols = paste0("iga1", 1:3)]
piga[, (paste0(rep(c("iga", "iga1"), each = 3), 1:3)) := lapply(.SD, factor), 
  .SDcols = paste0(rep(c("iga", "iga1"), each = 3), 1:3)]
setkey(piga, Arm, membershipstatus, 
  PurchaseYear1, PurchaseYear2, PurchaseYear3, iga1, iga2, iga3)
saveRDS(piga, paste0(pathsaveHere, "PurchasedDatesAndIGAs.rds"))
piga <- readRDS(paste0(pathsaveHere, "PurchasedDatesAndIGAs.rds"))
piga[, Arm := factor(Arm, labels = ArmsC)]
# reset key as factor(Arm, labels = ArmsC) drops keys
setkey(piga, Arm, membershipstatus, 
  PurchaseYear1, PurchaseYear2, PurchaseYear3, iga1, iga2, iga3)
# admin data only has member's info
# iga patterns for traditional (who has 2nd purchase by 2nd loans)
unq2 <- unique(piga[!is.na(PurchaseYear2), 
  .(Arm, membershipstatus, PurchaseYear1, PurchaseYear2, PurchaseYear3, iga1, iga2, iga3)])
piga2 <- piga[unq2, .N, by = .EACHI][order(Arm, iga1, iga2, iga3, PurchaseYear1), ]
# iga patterns in all arms
unq1 <- unique(piga[, 
  .(Arm, membershipstatus, PurchaseYear1, PurchaseYear2, PurchaseYear3, iga1, iga2, iga3)])
piga1 <- piga[unq1, .N, by = .EACHI][order(Arm, iga1, iga2, iga3, PurchaseYear1), ]
<<figure first IGA choices cattle vs other by arm, results = "markup", warning = F, message = F, fig.align='center', fig.height = 3, fig.width = 10, fig.cap = paste0("Income generatng activity choices", "\\\\ {\\footnotesize The first income generating activity choices are plotted.\\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
library(ggplot2)
piga1 <- piga1[!grepl("D", membershipstatus), ]
#piga1[, c("membershipstatus", "PurchaseYear3") := NULL]
piga1[, Total := sum(N, na.rm = T), by = .(Arm, iga1)]
piga1u <- unique(piga1[, .(Arm, iga1, Total)])
piga1u[, Arm := factor(Arm, levels = ArmsC)]
p <- ggplot(data = piga1u, aes(iga1, Total)) + 
  geom_col(aes(fill = iga1, colour = iga1)) +
  scale_fill_manual(values = c("cattle" = "darkblue", "other" = "white")) +
  scale_colour_manual(values = c("cattle" = "darkblue", "other" = "darkblue")) +
  xlab("First IGA choices") +
  theme(
    axis.text.x = element_text(angle = 30, vjust = .5, hjust = 1), 
    strip.text.x = element_text(colour = "blue"),
    legend.position = "none")+
  facet_grid( ~ Arm, switch = "y", scales = "free_y")
setEPS()
postscript(file =  
  paste0(pathprogram, "figure/EstimationMemo/FirstIGAChoicesCattleVsOther.eps"),
  , horizontal = F)
print(p)
whatever <- dev.off()
ggsave(
  paste0(pathprogram, "figure/EstimationMemo/FirstIGAChoicesCattleVsOther.png"),
  p,
  width = 14, height = 8, units = "cm",
  dpi = 300
 )
pdf(
  paste0(pathprogram, "figure/EstimationMemo/FirstIGAChoicesCattleVsOther.pdf"),
  , width = 14/2.54, height = 8/2.54)
print(p)
whatever <- dev.off()
<<define again piga1 for main text>>=
unq1 <- unique(piga[, 
  .(Arm, membershipstatus, PurchaseYear1, PurchaseYear2, PurchaseYear3, iga1, iga2, iga3)])
piga1 <- piga[unq1, .N, by = .EACHI][order(Arm, iga1, iga2, iga3, PurchaseYear1), ]
@

In \textsf{traditional} arm, there are \Sexpr{sum(piga1[grepl("Trad", Arm) & !grepl("D", membershipstatus) & !grepl("other", iga1), N])} borrowing members who report cattle as their first IGA, and \Sexpr{sum(piga1[grepl("Trad", Arm) & !grepl("D", membershipstatus) & grepl("other", iga1), N])} borrowing members (\Sexpr{round((sum(piga1[grepl("Trad", Arm) & !grepl("D", membershipstatus) & grepl("other", iga1), N])/sum(piga1[grepl("Trad", Arm) & !grepl("D", membershipstatus), N]))*100, 2)}\%) who report other than cattle as their first IGA. This contrasts with the non-\textsf{traditional} arms that \Sexpr{sum(piga1[!grepl("Trad", Arm) & !grepl("D", membershipstatus) & !grepl("other", iga1), N])} borrowing members who report cattle as their first IGA and \Sexpr{sum(piga1[!grepl("Trad", Arm) & !grepl("D", membershipstatus) & grepl("other", iga1), N])} borrowing members (\Sexpr{round((sum(piga1[!grepl("Trad", Arm) & !grepl("D", membershipstatus) & grepl("other", iga1), N])/sum(piga1[!grepl("Trad", Arm) & !grepl("D", membershipstatus), N]))*100, 2)}\%) other than cattle as their first IGA. 
<<figure second third IGA choices cattle vs other by arm, results = "hide", warning = F, message = F, fig.align='center', fig.height = 3, fig.width = 10, fig.cap = paste0("Income generatng activity choices", "\\\\ {\\footnotesize The second and third income generating activity choices are plotted.\\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
library(ggplot2)
piga1 <- piga[unq1, .N, by = .EACHI][order(Arm, iga1, iga2, iga3, PurchaseYear1), ]
piga1[, Total.2 := sum(N, na.rm = T), by = .(Arm, iga2)]
piga1[, Total.3 := sum(N, na.rm = T), by = .(Arm, iga3)]
piga1u <- unique(piga1[, .(Arm, iga2, iga3, Total.2, Total.3)])
piga1u[grepl("cow", Arm), Arm := "cattle"]
setnames(piga1u, grepout("^iga", colnames(piga1u)), 
  gsub("a", "a.", grepout("^iga", colnames(piga1u))))
piga1uL <- melt(piga1u, idvar = "Arm", 
  measure.vars = grepout("^iga", colnames(piga1u)), variable.name = "IGAOrder")
piga1uL[, Total := Total.2]
piga1uL[grepl("3", IGAOrder), Total := Total.3]
piga1uL[, paste0("Total.", 2:3) := NULL]
piga1uL[, IGAOrder := gsub("iga.", "", IGAOrder)]
piga1uLu <- unique(piga1uL)
setnames(piga1uLu, "value", "iga")
piga1uLu[, Total23 := sum(Total), by = .(Arm, iga)]
piga1uLuu <- unique(piga1uLu[, .(Arm, iga, Total23)])
piga1uLuu <- piga1uLuu[!is.na(iga) | grepl("arge$", Arm), ]
piga1uLuu[grepl("arge$", Arm), c("iga", "Total23") := .("cattle", 0)]
piga1uLuu[, Arm := factor(Arm, labels = ArmsC)]
p <- ggplot(data = piga1uLuu, aes(iga, Total23)) + 
  geom_col(aes(fill = iga, colour = iga)) +
  scale_fill_manual(values = c("cattle" = "darkblue", "other" = "white")) +
  scale_colour_manual(values = c("cattle" = "darkblue", "other" = "darkblue")) +
  xlab("Second and third IGAs") +
  theme(
    axis.text.x = element_text(angle = 30, vjust = .5, hjust = 1), 
    strip.text.x = element_text(colour = "blue"),
    legend.position = "none")+
  facet_grid( ~ Arm, switch = "y", scales = "free_y")
ggsave(
  paste0(pathprogram, "figure/EstimationMemo/SecondThirdIGAChoicesCattleVsOther.png"),
  p,
  width = 14, height = 8, units = "cm",
  dpi = 300
 )
pdf(
  paste0(pathprogram, "figure/EstimationMemo/SecondThirdIGAChoicesCattleVsOther.pdf"),
  , width = 14/2.54, height = 8/2.54)
print(p)
whatever <- dev.off()
@
<<warning = F>>=
iga <- adw2[, .(hhid, Arm, membershipstatus, Date, iga11st, iga12nd, iga13rd)]
setnames(iga, c("hhid", "Arm", "membershipstatus", "Date", paste0("iga", 1:3)))
if (Only800) iga <- iga[hhid %in% ar[o800 == 1L, hhid], ]
#table0(iga[, iga1])
#table0(iga[, iga2])
#table0(iga[, iga3])
setkey(iga, hhid, Date)
# NumIGA = total # of IGAs for each Date for each household
iga[, NumIGA := sum(!is.na(iga1)) + sum(!is.na(iga2)) + sum(!is.na(iga3)), by = .(hhid, Date)]
#iga[NumIGA == 0 & !is.na(iga1), ]
setkey(iga, NumIGA, iga1, iga2, iga3)
iga.unique <- unique(iga[, .(NumIGA, iga1, iga2, iga3)])
iga.unique <- iga[iga.unique, .N/48, by = .EACHI]
setnames(iga.unique, "V1", "N")
setorder(iga.unique, -NumIGA, -N, iga1, iga2, iga3)
# tabulation by all IGAs
setkey(iga, NumIGA, Arm, membershipstatus, iga1, iga2, iga3)
igaan <- unique(iga[, .(Arm, membershipstatus, NumIGA, iga1, iga2, iga3)])
igaan <- iga[igaan, .(N=.N/48), by = .EACHI]
igaan <- igaan[!grepl("Dr", membershipstatus), ]
igaan[, membershipstatus := NULL]
setorder(igaan, -NumIGA, -N, iga1, iga2, iga3)
# tabulation by IGA #1
setkey(iga, NumIGA, iga1, Arm)
igaArm.unique <- unique(iga[, .(NumIGA, iga1, Arm)])
igaArm.unique <- iga[igaArm.unique, .N/48, by = .EACHI]
setnames(igaArm.unique, "V1", "N")
setorder(igaArm.unique, -NumIGA, -N, iga1)
for (i in 1:3) {
  iga[, paste0("IGA.", i) := as.character(NA)]
  iga[grepl("Cow|oxen", eval(parse(text = paste0("iga", i)))), 
    paste0("IGA.", i) := "cattle"]
  iga[grepl("Goa|heep", eval(parse(text = paste0("iga", i)))), 
    paste0("IGA.", i) := "goat sheep"]
  iga[grepl("small", eval(parse(text = paste0("iga", i)))), 
    paste0("IGA.", i) := "small trade"]
  iga[grepl("house|land", eval(parse(text = paste0("iga", i)))), 
    paste0("IGA.", i) := "house land"]
  iga[grepl("machi", eval(parse(text = paste0("iga", i)))), 
    paste0("IGA.", i) := "machinery"]
  iga[grepl("addy|nut", eval(parse(text = paste0("iga", i)))), 
    paste0("IGA.", i) := "paddy nuts corn"]
  iga[, paste0("IGA.", i) := factor(eval(parse(text = paste0("IGA.", i))), 
    levels = c("cattle", "goat sheep", "machinery", "small trade", "house land", "paddy nuts corn", NA))]
}
iga[grepl("tra", Arm), Arm := "Traditional"]
iga[grepl("ge$", Arm), Arm := "Large"]
iga[grepl("ce$", Arm), Arm := "LargeGrace"]
iga[grepl("^co", Arm), Arm := "Cattle"]
# tabulation by all IGAs (same execersize as igaan in the above)
setkey(iga, NumIGA, IGA.1, IGA.2, IGA.3, Arm)
iga.unique3 <- unique(iga[, .(NumIGA, IGA.1, IGA.2, IGA.3, Arm)])
iga.unique3 <- iga[iga.unique3, .(N = .N/48), by = .EACHI]
setorder(iga.unique3, -NumIGA, -N, Arm, IGA.1, IGA.2, IGA.3)
iga.unique3[, NumIGA := factor(NumIGA, levels = 3:0)]
# 0 IGA are drop outs, no IGA reported in admin data
<<figure IGA choices original HHs, results = "hide", warning = F, message = F, fig.align='center', fig.height = 8, fig.width = 10>>=
library(ggplot2)
igau <- iga.unique3[NumIGA != 0 & !is.na(IGA.1), ]
igauL <- melt(igau, idvar = c("Arm", "NumIGA", "N"),
  measure.vars = grepout("^I", colnames(igau)), variable.name = "IGAOrder")
igauL[, IGAOrder := gsub("IGA.", "", IGAOrder)]
setnames(igauL, "value", "iga")
igauL <- igauL[!is.na(iga), ]
# sum each IGA by the number of total IGAs 
# (if there are 3 IGAs, number of x IGA = sum(any combination that includes x)
# values for x = number of HHs which has x in n IGAs with n = 1, 2, 3.
igauL[, Total := sum(N, na.rm = T), by = .(Arm, NumIGA, iga)]
igauLu <- unique(igauL[, .(Arm, NumIGA, iga, Total)])
igauLu[grepl("cow", Arm), Arm := "cattle"]
p <- ggplot(data = igauLu, aes(iga, Total)) + 
  geom_col(aes(fill = iga)) +
  scale_fill_manual(values = 
 c("cattle"="darkblue", "goat sheep"="darkblue", "small trade"="darkblue",
  "paddy nuts corn"="darkblue", "house land"="darkblue")
  ) +
  xlab("IGAs") +
  theme(
    axis.text.x = element_text(angle = 30, vjust = .5, hjust = 1), 
    strip.text = element_text(colour = "blue"),
    legend.position = "none")+
  facet_grid(NumIGA ~ Arm, switch = "y")
setEPS()
postscript(file =  
  paste0(pathprogram, "figure/EstimationMemo/AllIGAChoicesByNumIGA.eps"),
  , horizontal = F)
print(p)
whatever <- dev.off()
pdf(
  paste0(pathprogram, "figure/EstimationMemo/AllIGAChoicesByNumIGA.pdf"),
  , width = 14/2.54, height = 10/2.54)
print(p)
whatever <- dev.off()
<<figure All IGA choices original HHs, results = "hide", warning = F, message = F, fig.align='center', fig.height = 3, fig.width = 10, fig.cap = paste0("All income generatng activity choices", "\\\\ {\\footnotesize All of multiple investment choices are summed by arms and the number of IGAs and plotted as bars. \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
iga.unique3[, num := 1:.N]
igaUL <- reshape(iga.unique3, direction = "long", idvar = c("num", "NumIGA", "Arm", "N"),
  varying = paste0("IGA.", 1:3))
setnames(igaUL, "time", "rank")
setkey(igaUL, num, rank)
library(ggplot2)
p <- ggplot(data = igaUL[NumIGA != 0 & !is.na(IGA), ], aes(IGA, N)) + 
  geom_col() +
  xlab("IGA choices") +
  theme(
    axis.text.x = element_text(angle = 30, vjust = .5, hjust = 1), 
    strip.text.y = element_text(colour = "blue"))+
  facet_grid(NumIGA ~ Arm, switch = "y")
setEPS()
postscript(file =  
  paste0(pathprogram, "figure/EstimationMemo/AllIGAChoices.eps"),
  , horizontal = F)
print(p)
whatever <- dev.off()
pdf(
  paste0(pathprogram, "figure/EstimationMemo/AllIGAChoices.pdf"),
  , width = 14/2.54, height = 8/2.54)
print(p)
whatever <- dev.off()
<<figure All IGA choices collapsed original HHs, results = "hide", warning = F, message = F, fig.align='center', fig.height = 3, fig.width = 10, fig.cap = paste0("All income generatng activity choices collapsed over different number of IGAs", "\\\\ {\\footnotesize All of multiple investment choices are summed by arms and plotted as bars. \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
iga.unique3[, num := 1:.N]
igaUL <- reshape(iga.unique3, direction = "long", idvar = c("num", "NumIGA", "Arm", "N"),
  varying = paste0("IGA.", 1:3))
setnames(igaUL, "time", "rank")
setkey(igaUL, num, rank)
library(ggplot2)
p <- ggplot(data = igaUL[NumIGA != 0 & !is.na(IGA), ], aes(IGA, N)) + 
  geom_col() +
  xlab("First IGA choices") +
  theme(axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1), 
    strip.text.y = element_text(colour = "blue"))+
  facet_grid(. ~ Arm, switch = "y")
setEPS()
postscript(file =  
  paste0(pathprogram, "figure/EstimationMemo/AllIGAChoicesCollapsed.eps"),
  , horizontal = F)
print(p)
whatever <- dev.off()
pdf(
  paste0(pathprogram, "figure/EstimationMemo/AllIGAChoicesCollapsed.pdf"),
  , width = 14/2.54, height = 8/2.54)
print(p)
whatever <- dev.off()
<<>>=
@
<<>>=
sec <- "IGA"
@


\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: First IGA choices \label{fig IGAChoices}}\\
\hfil\includegraphics[height = 5cm]{\Sexpr{  paste0(pathprogram, "figure/EstimationMemo/FirstIGAChoices.pdf")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Survey data.\\
Note:&  The first income generating activity (IGA) choices are plotted. The rows headed by `$n=1, 2, 3$' indicate there are $n$ project(s) owned by the household, and displayed type of project on the horizontal axis shows the contents of first project that was invested. \\[1ex]
\end{tabular}
}

\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: All IGA choices \label{fig All IGAChoices}}\\
\hfil\includegraphics[height = 5cm]{\Sexpr{    paste0(pathprogram, "figure/EstimationMemo/AllIGAChoices.pdf")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Survey data.\\
Note:&  \\[1ex]
\end{tabular}
}

\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: All IGA choices (collapsed view)\label{fig All IGAChoicesCollapsed}}\\
\hfil\includegraphics[height = 5cm]{\Sexpr{    paste0(pathprogram, "figure/EstimationMemo/AllIGAChoicesCollapsed.pdf")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Survey data.\\
Note:&  \\[1ex]
\end{tabular}
}


\subsection{Graphs}

Cumulative changes of non-traditional arm up to $t$ is given by $\mbox{(Intercept)}+b_{\mbox{\scriptsize Arm}}+b_{\mbox{\scriptsize $t$}}+b_{\mbox{\scriptsize Arm*$t$}}.$  This is given by \textsf{Intercept+Arm+TimeX+Arm.TimeX}. For the traditional arm, it is given by $\mbox{(Intercept)}+b_{\mbox{\scriptsize $t$}}.$

Time-varying impacts relative to the traditional arm is given by $b_{\mbox{\scriptsize Arm}}+b_{\mbox{\scriptsize Arm*$t$}}.$ This is given by \textsf{Arm+Arm.TimeX}. 


Need to run construct confi manually and run EstimationMemo.rnw again to draw error bar charts. To compute linear functions of estimated parameters, we use a vector \textsf{hv} giving linear combinations, covariance matrix of the regression \textsf{thisV}, and run $Wald$ tests with:\\
{\verb+  glht(model=thisreg, linfct = matrix(hv, byrow = T, nrow=1),+ \\
\verb+    alternative="two.sided", vcov.=thisV)+}



\renewcommand{\arraystretch}{.8}
\hfil\begin{tabular}{>{\footnotesize}p{1.75cm}<{}
>{\footnotesize}p{6cm}<{}
>{\footnotesize}p{5cm}<{}}
\rowcolor{gray90}
\hfil Object & \hfil What it does & \hfil Note\\
 hvT0 &  \mpage{6cm}{Picks covariates to test overall change.\\
  \texttt{"\textbackslash\textbackslash(Intercept\textbackslash\textbackslash)"\setlength{\baselineskip}{8pt}} }& \\
 hvN0 &  \mpage{6cm}{Overall mean impact of each non-traditional arm.\\
  \texttt{"\textbackslash\textbackslash(Intercept\textbackslash\textbackslash)", "dummyInKind"}\setlength{\baselineskip}{8pt}} & \\
 hvN1 &  \mpage{6cm}{Difference of period 2 Arm relative to period 2 trad.\\
  \texttt{"dummyInKind"}\setlength{\baselineskip}{8pt}}& \\
 hvTinT &  \mpage{6cm}{Picks covariates to test changes in period t relative to period 2.\\
  \texttt{"Time.4"}\setlength{\baselineskip}{8pt}}  & \\
  hv & \mpage{6cm}{Collects all coefficients by far to compute changes.\\
 \texttt{\textbackslash\textbackslash(Intercept\textbackslash\textbackslash) + Time.T}\setlength{\baselineskip}{8pt}} & hv $<-$ hvT0 + hvTinT\\
 hvNinT &  \mpage{6cm}{Picks covariates to test changes in period t relative to period 2 trad.\\ 
  \texttt{"Time.4", "dummyInKind.Time4"}\setlength{\baselineskip}{8pt}} &  Use this if period 2 trad is the reference.\\
 dhvNinT &  \mpage{6cm}{Difference relative to concurrent trad.\\
 \texttt{"dummyInKind.Time4"}\setlength{\baselineskip}{8pt}} &  Marginal difference between g and trad in period T.\setlength{\baselineskip}{8pt}\\
 cumNrelativeT &  \mpage{6cm}{Cumulative difference relative to concurrent trad.\\
  \texttt{"dummyInKind.Time2"+"dummyInKind.Time3"}\\\texttt{+"dummyInKind.Time4"}\setlength{\baselineskip}{8pt}} &  \textsf{cumstrings} adds dummyInKind.TimeX as period loops goes, with paste(cumstrings, paste0("\^", covadd.nontrad[[i]][2], "\$"), sep = "|")\setlength{\baselineskip}{8pt}\\
 periNrelativeT &  \mpage{6cm}{Periodwise difference relative to concurrent trad.\\
  \texttt{"dummyInKind"+"dummyInKind.TimeX"}\setlength{\baselineskip}{8pt}} &  Total difference between g and trad in time X. Period X effects relative to trad in perid X.  "dummyInKind" is stored in peristrings at hvN1\setlength{\baselineskip}{8pt}\\
 hvN2 &  \mpage{6cm}{Nontrad gross mean in period t.\\
 \texttt{\textbackslash\textbackslash(Intercept\textbackslash\textbackslash)+TimeX+TimeX.Arm}\\\texttt{=hvT0 + hvNinT}\setlength{\baselineskip}{8pt}} & Baseline trad + change relative to period 2 trad.\setlength{\baselineskip}{8pt}
\end{tabular}



<<set parameters, eval = T>>=
lattributeList <- list(
  c("Large", "LargeGrace", "Cattle"),
  c("LargeSize", "WithGrace", "InKind")
  )
# these are used for letting XX=Large, Cow, etc.
covadd0 <- list(c("\\(Intercept\\)", "dummyXX"), 
  c("Time.3", "dummyXX.Time3"),
  c("Time.4", "dummyXX.Time4"))
covaddsav <- list(c("\\(Intercept\\)", "dummyXX"), 
  c("LY2", "dummyXX.LY2"), # LY is loan year
  c("LY3", "dummyXX.LY3"),
  c("LY4", "dummyXX.LY4"))
# scY: school has variable names such as dummyHigh, 
#  need to delete "dummy" from them
#  male*school ~ Arm
covaddsch <- list(
  # male, traditional (MofT)
  MofT=c("\\(Intercept\\)", "^dummyJunior$", "^dummyHigh$"), 
  # female, traditional (FofT)
  FofT=c("^Female$", "^dummyJunior.Female$", "^dummyHigh.Female$"),
  # male, other arms (MofN)
  MofN=c("^dummyXX$", "^dummyXX.dummyJunior$", "^dummyXX.dummyHigh$"), 
  # female, other arms (FofN)
  FofN=c("^dummyXX.Female$", "^dummyXX.dummyJunior.Female$", 
    "^dummyXX.dummyHigh.Female$"),
  # male, trad, time (MofTinT)
  MofTinT=c("^Time.YY$", "^dummyJunior.TimeYY$", "^dummyHigh.TimeYY$"), 
  # female, trad, time (FofTinT)
  FofTinT=c("^Female.TimeYY$", "^dummyJunior.Female.TimeYY$", 
   "^dummyHigh.Female.TimeYY$"), 
  # male, other arms, time (MofNinT)
  MofNinT=c("^dummyXX.TimeYY$", "^dummyXX.dummyJunior.TimeYY$", 
  "^dummyXX.dummyHigh.TimeYY$"), 
  # female, other arms, time (FofNinT)
  FofNinT=c("^dummyXX.Female.TimeYY$", 
    "^dummyXX.dummyJunior.Female.TimeYY$", 
    "^dummyXX.dummyHigh.Female.TimeYY$")
  )
FileNames <- c(#"Saving", 
  "Schooling", #"Asset", 
  "Land", "Livestock", "NumCows",
  "AssetLivestock", "NetAssets", "NetBroadAssets",
  "NetAssetsAnnualPrices", "NetNLAssets", #"NarrowNetNLAssets",
  "NetAssetsExperience", 
  "NumCowsExperience", 
  paste0("NetAssetsByExperience", c("a", "o", "n")),
  paste0("NumCowsByExperience", c("a", "o", "n")),
  "LabourIncome", #"FarmIncome", 
  "Consumption", "ConsumptionOLS")
ListHeaderList <- c(#"sv", 
  "sc", #"as", 
  "ld", "lv", "cw", 
  "al", "na", "nb", 
  "np", "nl", # non livestock assets
  "nE", "lE", # net assets by experience, livestock by experience, OwnCow0, AdiCow0
  "nA", "nO", "nN", 
  "lA", "lO", "lN",
  "lb", #"far", 
  "cn", "co")
reglists <- list(
  #paste0("sv", c(2, 4:5, 7:8)),
  paste0("sc", c("b", "P", "a", "T", "Ta")),
  #paste0("as", c("b", "P", "a", "T", "Ta", "TP", "TPa")),
  paste0("ld", c("b", "P", "a", "T", "Ta", "TP", "TPa")),
  paste0("lv", c("b", "P", "a", "T", "Ta")),
  paste0("cw", c("b", "P", "a", "T", "Ta", "TP", "TPa")),
  paste0("al", c("b", "P", "a", "T", "Ta")),
  paste0("na", c("b", "P", "a", "T", "Ta", "TP", "TPa")),
  paste0("nb", c("b", "P", "a", "T", "Ta", "TP", "TPa")),
  paste0("np", c("b", "P", "a", "T", "Ta", "TP", "TPa")),
  paste0("nl", c("b", "P", "a", "T", "Ta", "TP", "TPa")),
  paste0("nE", c("b", "P", "a", "T", "Ta", "TP", "TPa")),
  paste0("lE", c("b", "P", "a", "T", "Ta", "TP", "TPa")),
  paste0("nA", c("b", "P", "a", "T", "Ta", "TP", "TPa")),
  paste0("nO", c("b", "P", "a", "T", "Ta", "TP", "TPa")),
  paste0("nN", c("b", "P", "a", "T", "Ta", "TP", "TPa")),
  paste0("lA", c("b", "P", "a", "T", "Ta")),
  paste0("lO", c("b", "P", "a", "T", "Ta")),
  paste0("lN", c("b", "P", "a", "T", "Ta")),
  paste0("lb", c("b", "P", "a", "T", "Ta", "TP", "TPa")),
#  paste0("far", c("b", "P", "a", "T", "Ta")),
  paste0("cn", c("b", "P", "a", "T", "Ta", "TP", "TPa")),
  paste0("co", c("b", "P", "a", "T", "Ta", "TP", "TPa"))
  )
names(reglists) <- ListHeaderList
<<run this after reestimation Read This Mannually, eval = F>>=
gc()
robj <- lapply(1:length(FileNames), function(i) 
  readRDS(paste0(pathsaveHere, "ANCOVA_", FileNames[i],".rds")))
FNames <- FileNames
<<run this after reestimation Read This Mannually qs, eval = T>>=
gc()
FNstrings <- "AssetLivestock"
FNames <- FileNames[!grepl(FNstrings, FileNames)]
ListHeaderListForQS <- ListHeaderList[!grepl(FNstrings, FileNames)]
reglists <- reglists[!grepl(FNstrings, FileNames)]
robj <- lapply(1:length(FNames), function(i) 
  qread(paste0(pathsaveHere, "ANCOVA_", FNames[i],".qs")))
@
\begin{verbatim}
cumstrings0 <- peristrings0 <- paste0("^", covadd.nontrad[[1]][2], "$") & 
peristrings2 <- paste(peristrings0, paste0("^", covadd.nontrad[[i]][2], "$"), sep = "|")
\end{verbatim}

\hfil\begin{tabular}{
>{\scriptsize }p{1.25cm}<{}
>{\scriptsize }p{3.5cm}<{}
>{\scriptsize }p{5cm}<{}
>{\scriptsize }p{4cm}<{}
}
\rowcolor{gray90}
\hfil Object & \hfil What it does & \hfil Typical terms & \hfil Code\\
hvT0 & picks covariates to test overall change & \verb+[[1]]"\\(Intercept\\)"+ & covadd.trad[[1]]\\ 
hvN0 & Arm & \verb+[[1]]"\\(Intercept\\)", "dummyInKind"+ & covadd.nontrad[[1]]\\ 
hvN1 & Arm - trad, in period 2 & \verb+[[1]][2] "dummyInKind"+ & covadd.nontrad[[1]][2] \\ 
hvTinT & trad in each period - trad in period 2 & \verb+[[2]] "Time.4"+ & covadd.trad[[i]] \\ 
hv & trad in each period & \verb|intercept + Time.T| & hv = hvT0 + hvTinT\\ 
hvNinT & Arm in each period - nontrad in period 2. For period 2, period 2 level of Arm is reurned. & \verb+[[2]] "Time.4", "dummyInKind.Time4"+ & covadd.nontrad[[i]][c(1, 2)]\\ 
dhvNinT & Difference = 0 (of Arm g and trad in time X) & \verb+[[2]][1] "dummyInKind.Time4"+ & covadd.nontrad[[i]][2]\\
hvNinT2 & Arm in each period - trad in period 2 & \verb+[[2]] Arm + TimeX + Arm.TimeX+ & hvN1+covadd.nontrad[[i]][c(1, 2)]\\ 
periNrelativeT & Cumulative difference = 0 (of arm g and trad in time X) & "dummyInKind"+"dummyInKind.TimeX" for cumulative effects relative to trad in time X & periNrelativeT=hvN1+dhvNinT\\
hvN2 & nontrad gross mean in period t = cumulative trad + relative to concurrent trad = 0 & \verb|Intercept+TimeX| \verb|+Arm+TimeX.Arm| & hvT0 + hvNinT \\
\multicolumn{4}{l}{\scriptsize Impacts by baseline experience \texttt{j} }\\
dhvJ0 & Average difference = 0 (of experienced j and trad) & \verb+dummyAdiCattle0+ & j\\
dhvJinT & Difference = 0 (of experienced j and trad in period X) & \verb+dummyAdiCattle0.TimeX+ & \verb+paste0("^", j, ".Time.$")+\\
hvJinT & Cumulative difference = 0 (of experience j and trad in period X) & \verb|dummyAdiCattle0 + dummyAdiCattle0.TimeX| & dhvJ0+dhvJinT\\
hvJG0 & Average difference = 0 (of experience*arm j*g and arm g) & \verb+dummyAdiCattle0.Large+ & \verb+paste0("^", j, "$")+\\
dhvJGinT & Difference = 0 (of experience*arm j*g and arm g in period X) & \verb+dummyAdiCattle0.Large.TimeX+ & paste0(``\^'', j, ``.'', covadd.nontrad[[i]][2])\\
hvJGinT & Cumulative difference = 0 (of experience*arm j*g and arm g in period X) & \verb|dummyAdiCattle0.Large| \verb|+ dummyAdiCattle0.Large.TimeX| & hvJG0 + dhvJGinT\\
periJGinT & Cumulative difference = 0 (of experience*arm j*g and trad in time X) &  \verb|dummyLarge + dummyLarge.TimeX| \verb|+ dummyAdiCattle0 + dummyAdiCattle0.TimeX| \verb|+ dummyAdiCattle0.Large| \verb|+ dummyAdiCattle0.Large.TimeX| &  periNrelativeT+hvJinT+hvJGinT
\end{tabular}




<<construct confi Do This Mannually, eval = T, warning = F>>=
confi <- linhyp <- NULL
library(car)
library(multcomp)
# r:
# 4 (in ListHeaderList, 5) is number of cattle
# 5 (in ListHeaderList, 6) is net assets
# 9 (in ListHeaderList, 11) is net non livestock assets
r <- grep("NetAssets$", FNames)
for (r in 2:length(ListHeaderListForQS)) {
  # r: outcomes
  for (rr in 1:length(robj[[r]])) {
    # rr: regression type: "b", "P", "a", "T", "Ta", "PT", "PTa"
    # regobj: e.g., "asT" with s=2,...,7 regression specifications
    regtype <- gsub("^..", "", reglists[[r]][rr])
    if (grepl("a", regtype)) 
      lattributes <- lattributeList[[2]] else
      lattributes <- lattributeList[[1]]
    regobj <- robj[[r]][[rr]]
    if (grepl("cn", ListHeaderListForQS[r])) regobj <- regobj[1:3] # consumption: 4-6 are HH aggregates
    if (grepl("co", ListHeaderListForQS[r])) regobj <- regobj[1:2] # consumption: 4-5 are HH aggregates
    lmlist <- lapply(regobj, "[[", "lm")
    coefflist <- lapply(lmlist, "[[", "coefficients")
    c(reglists[[r]][rr]) 
    # drop NAs in coeff
    coefflist <- lapply(coefflist, function(x) x[!is.na(x)])
    Vlist <- lapply(lapply(regobj, "[[",  "robust"), "[[", "V")
    # Define covadd (a string vector used to pick coefficients for testing)
    # if regressand is saving:
    #  Change to loan year: TimeX => LYX
    #  Multiply with 12 (turn to monthly to yearly)
    if (any(grepl("sv", reglists[[r]]))) {
      covadd <- covaddsav 
      Mult <- 12
    } else {
      covadd <- covadd0
      Mult <- 1
    }
    covadd.trad <- lapply(covadd, function(x) x[1])
    for (s in 1:length(regobj)) {
      # s: 7 regression specifications
      thisreg <- lmlist[[s]]
      coeffvec <- coefflist[[s]]
      thisV <- Vlist[[s]]
      # Consumption: No rd1 so period= 1, 2. Drop period 3 variables.
      if (grepl("cn", ListHeaderListForQS[r])) startnum <- 2 else startnum <- 1
      # construct conf int for linear combination of coeffs
      #if (grepl("cn", ListHeaderList[r])) addcova <- covadd[-2]
       ## period 2 (=overall, when no Time is present) effects ##
      # trad
      # hvT0: picks covariates to test overall change
      #  [[1]]"\\(Intercept\\)"
      hvT0 <- rep(0, length(coeffvec))
      hvT0[grepl(
           paste0("^", covadd.trad[[1]], "$")
          , names(coeffvec))] <- 1*Mult
      lhcow <- glht(model=thisreg, linfct = matrix(hvT0, byrow = T, nrow=1), 
        alternative="two.sided", vcov.=thisV)
      confi <- rbind(confi, 
         c(FNames[r], regtype, s, "trad", "None", "level of reference trad", "T0", 
         startnum, confint(lhcow)$confint[1, ], 
         if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
         )
      linhyp <- c(linhyp, list(hvT0, thisreg$coeff))
      names(linhyp)[length(linhyp)] <- 
        paste0(c(FNames[r], regtype, s, "trad", "None", "level of reference trad", startnum), collapse = "")
      # nontrad
      for (g in lattributes) {
        # g: attributes or arm
        # construct coefficient names for attribute g (replace XX with g)
        covadd.nontrad <- lapply(covadd, function(x) gsub("XX", g, x))
        # E.g., if g = Large, 
        #  [[1]]
        #  [1] "\\(Intercept\\)" "dummyLarge"     
        #  [[2]]
        #  [1] "Time.3"           "dummyLarge.Time3"
        #  [[3]]
        #  [1] "Time.4"           "dummyLarge.Time4"
        # hvN0: period 2 level for Arm
        #  [[1]]"\\(Intercept\\)", "dummyInKind"
        hvN0 <- rep(0, length(coeffvec))
        hvN0[grepl(
          paste(
            paste0("^", covadd.nontrad[[1]], "$")
           , collapse = "|")
           , names(coeffvec))] <- 1*Mult
        lhcow <- glht(model=thisreg, linfct = matrix(hvN0, byrow = T, nrow=1), 
          alternative="two.sided", vcov.=thisV)
        confi <- rbind(confi, 
          c(FNames[r], regtype, s, g, "None", "level of reference nontrad", "N0", 
           startnum, confint(lhcow)$confint[1, ], 
           if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
          )
        linhyp <- c(linhyp, list(hvN0, thisreg$coeff))
        names(linhyp)[length(linhyp)] <- 
          paste0(c(FNames[r], regtype, s, g, "None", "level of reference nontrad", startnum), collapse = "")
        # hvN1: difference of period 2 Arm relative to period 2 trad
        #  [[1]][2] "dummyInKind"
        cumstrings0 <- peristrings0 <- paste0("^", covadd.nontrad[[1]][2], "$")
        hvN1 <- rep(0, length(coeffvec))
        hvN1[grepl(
            paste0("^", covadd.nontrad[[1]][2], "$")
           , names(coeffvec))] <- 1*Mult
        lhcow <- glht(model=thisreg, linfct = matrix(hvN1, byrow = T, nrow=1), 
          alternative="two.sided", vcov.=thisV)
        confi <- rbind(confi, 
          c(FNames[r], regtype, s, g, "None", "reference nontrad - reference trad", "N1", 
           startnum, confint(lhcow)$confint[1, ], 
           if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
         )
        linhyp <- c(linhyp, list(hvN1, thisreg$coeff))
        names(linhyp)[length(linhyp)] <- 
          paste0(c(FNames[r], regtype, s, g, "None", "reference nontrad - reference trad", 
          startnum), collapse = "")
         ## 2 way (Arm*Time) interactions ##
        if (grepl("T", regtype)) {
          # i: period loop. Start from startnum+1 (=2. Only in consumption, =3.)
          #for (i in (startnum+1):length(covadd.trad)) {
          # i: period loop. Start from startnum (=1. Only in consumption, =2.)
          #  1: Time2 or reference period. 2: Time3, 3: Time4
          for (i in startnum:length(covadd.trad)) {
            # i: period index
            # trad
            # hvTinT: difference = 0 (of trad in time X relative to trad in time 2)
            # [[2]] "Time.4"
            hvTinT <- rep(0, length(coeffvec))
            hvTinT[grepl(
                paste0("^", covadd.trad[[i]], "$")
              , names(coeffvec))] <- 1*Mult
            lhcow <- glht(model=thisreg, linfct = matrix(hvTinT, byrow = T, nrow=1), 
              alternative="two.sided", vcov.=thisV)
            confi <- rbind(confi, 
              c(FNames[r], regtype, s, "trad", "None", "trad in each period - trad in period 2", 
                "TinT", 
                i, confint(lhcow)$confint[1, ], 
                if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
              )
            linhyp <- c(linhyp, list(hvTinT, thisreg$coeff))
            names(linhyp)[length(linhyp)] <- 
              paste0(c(FNames[r], regtype, s, "trad", "None", "trad in each period - trad in period 2", i), collapse = "")
            # hvTL: level = 0 (of trad in TimeX)
            # intercept + Time.X
            hvTL <- hvT0 + hvTinT
            lhcow <- glht(model=thisreg, linfct = matrix(hvTL, byrow = T, nrow=1), 
              alternative="two.sided", vcov.=thisV)
            confi <- rbind(confi, 
              c(FNames[r], regtype, s, "trad", "None", "level of trad in period X", 
                "TL", 
                i, confint(lhcow)$confint[1, ], 
                if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
            )
            linhyp <- c(linhyp, list(hvTL, thisreg$coeff))
            names(linhyp)[length(linhyp)] <- 
              paste0(c(FNames[r], regtype, s, "trad", "None", "level of trad in period X", i), collapse = "")
            # nontrad
            # hvNinT: difference = 0 (of arm g in time X relative to arm g at period 2)
            #   intercept + Arm +TimeX + Arm.TimeX - (intercept + Arm) 
            #   = TimeX + Arm.TimeX
            # [[2]] "Time.4", "dummyInKind.Time4"
            # For period 2, it gives period 2 level of Arm. 
            hvNinT <- rep(0, length(coeffvec))
            hvNinT[grepl(
              paste(
                paste0("^", covadd.nontrad[[i]], "$")
              , collapse = "|")
              , names(coeffvec))] <- 1*Mult
            lhcow <- glht(model=thisreg, linfct = matrix(hvNinT, byrow = T, nrow=1), 
              alternative="two.sided", vcov.=thisV)
            confi <- rbind(confi, 
              c(FNames[r], regtype, s, g, "None", "nontrad in each period - nontrad in period 2", 
               "NinT", 
                i, confint(lhcow)$confint[1, ], 
                if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
              )
            linhyp <- c(linhyp, list(hvNinT, thisreg$coeff))
            names(linhyp)[length(linhyp)] <- 
              paste0(c(FNames[r], regtype, s, g, "None", "nontrad in each period - nontrad in period 2", i), collapse = "")
            # dhvNinT: Difference = 0 (of Arm g relative to trad, in time X)
            # Marginal difference between g and trad in time X.
            # [[2]][1] "dummyInKind.Time4"
            dhvNinT <- rep(0, length(coeffvec))
            dhvNinT[grepl(
                paste0("^", covadd.nontrad[[i]][2], "$")
              , names(coeffvec))] <- 1*Mult
            lhcow <- glht(model=thisreg, linfct = matrix(dhvNinT, byrow = T, nrow=1), 
              alternative="two.sided", vcov.=thisV)
            confi <- rbind(confi, 
              c(FNames[r], regtype, s, g, "None", "nontrad - trad, in each period", 
                "dNinT", 
                i, confint(lhcow)$confint[1, ], 
                if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
              )
            linhyp <- c(linhyp, list(dhvNinT, thisreg$coeff))
            names(linhyp)[length(linhyp)] <- 
              paste0(c(FNames[r], regtype, s, g, "None", "nontrad - trad in each period", i), collapse = "")
            # hvNinT2: difference = 0 (of arm g in time X relative to trad in time 2)
            #   intercept + Arm +TimeX + Arm.TimeX - (intercept) 
            #   = Arm + TimeX + Arm.TimeX 
            #   = hvN1 + hvNinT
            # [[2]] "dummyInKind", "Time.4", "dummyInKind.Time4"
            hvNinT2 <- hvN1 + hvNinT
            lhcow <- glht(model=thisreg, linfct = matrix(hvNinT2, byrow = T, nrow=1), 
              alternative="two.sided", vcov.=thisV)
            confi <- rbind(confi, 
              c(FNames[r], regtype, s, g, "None", "nontrad in each period - trad in period 2", 
               "NinT2", 
                i, confint(lhcow)$confint[1, ], 
                if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
              )
            linhyp <- c(linhyp, list(hvNinT2, thisreg$coeff))
            names(linhyp)[length(linhyp)] <- 
              paste0(c(FNames[r], regtype, s, g, "None", "nontrad in each period - trad in period 2", i), collapse = "")
            # periNrelativeT: Cumulative difference = 0 (of nontrad Arm g relative to trad, in time i)
            # Total difference between g and trad in time X.
            #  "dummyInKind"+"dummyInKind.TimeX" for cumulative effects relative to trad in time X
            # "dummyInKind" is stored in peristrings0 at hvN1
            periNrelativeT <- rep(0, length(coeffvec))
            peristrings2 <- paste(peristrings0, paste0("^", covadd.nontrad[[i]][2], "$"), sep = "|")
            periNrelativeT[grepl(peristrings2, names(coeffvec))] <- 1*Mult
            lhcow <- glht(model=thisreg, linfct = matrix(periNrelativeT, byrow = T, nrow=1), 
              alternative="two.sided", vcov.=thisV)
            confi <- rbind(confi, 
              c(FNames[r], regtype, s, g, "None", "sum of (nontrad - trad, in each period)", 
                "periNrelativeT", 
                i, confint(lhcow)$confint[1, ], 
                if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
              )
            linhyp <- c(linhyp, list(periNrelativeT, thisreg$coeff))
            names(linhyp)[length(linhyp)] <- 
              paste0(c(FNames[r], regtype, s, g, "None", 
              "sum of nontrad - trad in each period", i), collapse = "")
            # hvN2: level = 0 (of nontrad in period t)
            # = cumulative trad + relative to concurrent trad
            # Intercept+TimeX+Arm+TimeX.Arm=hvT0 + hvNinT
            hvN2 <- hvT0 + hvNinT
            lhcow <- glht(model=thisreg, linfct = matrix(hvN2, byrow = T, nrow=1), 
              alternative="two.sided", vcov.=thisV)
            confi <- rbind(confi, 
              c(FNames[r], regtype, s, g, "None", "level of nontrad in each period", 
              "N2", 
                i, confint(lhcow)$confint[1, ], 
                if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
              )
            linhyp <- c(linhyp, list(hvN2, thisreg$coeff))
            names(linhyp)[length(linhyp)] <- 
              paste0(c(FNames[r], regtype, s, g, "None", "level of nontrad in each period", i), collapse = "")
            ## 3 way (OwnCattle0*Arm*Time) interactions ##
            # Loop over OwnCattle0, AdiCattle0, 
            if (grepl("sExpe", FNames[r])) {
              for (j in paste0("dummy", c("Own", "Adi"), "Cattle0")) {
              # j: experience type
                # dhvJ0: Difference between j and trad at period 2
                #  dummyAdiCattle0
                # dhvJG0: Difference between j and arm/attribute g at period 2
                #  dummyAdiCattle0.Large
                # dhvJinT: Difference between j and concurrent trad in period X.
                #  dummyAdiCattle0.TimeX
                # dhvJGinT: Difference between j*g and g in X
                #  dummyAdiCattle0.Large.TimeX
                # hvJinT: Cumulative difference between j and concurrent trad in period X.
                #  dummyAdiCattle0 + dummyAdiCattle0.TimeX
                # hvJGinT: Cumulative difference between j*g and g in T
                #  dummyAdiCattle0.Large + dummyAdiCattle0.Large.TimeX
                # periJGinT: Cumulative difference between j*g and concurrent trad in time X.
                #  dummyLarge + dummyLarge.TimeX : periNrelativeT
                # +dummyAdiCattle0 + dummyAdiCattle0.TimeX : hvJinT
                # +dummyAdiCows0.Large+dummyAdiCows0.Large.TimeX : hvJGinT

                # dhvJ0: dummyAdiCattle0
                # Difference between j and trad at period 2
                 dhvJ0 <- rep(0, length(coeffvec))
                 dhvJ0[grepl(
                     paste0("^", j, "$")
                   , names(coeffvec))] <- 1*Mult
                 lhcow <- glht(model=thisreg, linfct = matrix(dhvJ0, byrow = T, nrow=1), 
                   alternative="two.sided", vcov.=thisV)
                 confi <- rbind(confi, 
                   c(FNames[r], regtype, s, g, j, "j*g - trad, in period 2", 
                     "dJ0", 
                     i, confint(lhcow)$confint[1, ], 
                     if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
                   )
                 linhyp <- c(linhyp, list(dhvJ0, thisreg$coeff))
                 names(linhyp)[length(linhyp)] <- 
                   paste0(c(FNames[r], regtype, s, g, j, "jg - trad in period 2", i), collapse = "")
                # dhvJinT: dummyAdiCattle0.TimeX
                # dhvJinT: Difference between j and concurrent trad in period X.
                 dhvJinT <- rep(0, length(coeffvec))
                 dhvJinT[grepl(
                     paste0("^", j, ".Time.$")
                   , names(coeffvec))] <- 1*Mult
                 lhcow <- glht(model=thisreg, linfct = matrix(dhvJinT, byrow = T, nrow=1), 
                   alternative="two.sided", vcov.=thisV)
                 confi <- rbind(confi, 
                   c(FNames[r], regtype, s, g, j, "j - trad, in each period", 
                     "dJinT", 
                     i, confint(lhcow)$confint[1, ], 
                     if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
                   )
                 linhyp <- c(linhyp, list(dhvJinT, thisreg$coeff))
                 names(linhyp)[length(linhyp)] <- 
                   paste0(c(FNames[r], regtype, s, g, j, "j - trad in each period", i), collapse = "")
                # hvJinT: Total difference between j and concurrent trad in period T.
                #  dummyAdiCattle0 + dummyAdiCattle0.TimeX
                 hvJinT <- dhvJ0+dhvJinT
                # hvJG0: dummyAdiCattle0.Large
                 hvJG0 <- rep(0, length(coeffvec))
                 hvJG0[grepl(
                     paste0("^", j, "$")
                   , names(coeffvec))] <- 1*Mult
                # dhvJGinT: dummyAdiCattle0.Large.TimeX
                 dhvJGinT <- rep(0, length(coeffvec))
                 dhvJGinT[grepl(
                     paste0("^", j, ".", covadd.nontrad[[i]][2])
                   , names(coeffvec))] <- 1*Mult
                # hvJGinT: dummyAdiCattle0.Large + dummyAdiCattle0.Large.TimeX
                 hvJGinT <- hvJG0 + dhvJGinT
                 lhcow <- glht(model=thisreg, linfct = matrix(hvJGinT, byrow = T, nrow=1), 
                   alternative="two.sided", vcov.=thisV)
                 confi <- rbind(confi, 
                   c(FNames[r], regtype, s, g, j, "j*g - g, in each period", 
                     "JGinT", 
                     i, confint(lhcow)$confint[1, ], 
                     if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
                   )
                 linhyp <- c(linhyp, list(hvJGinT, thisreg$coeff))
                 names(linhyp)[length(linhyp)] <- 
                   paste0(c(FNames[r], regtype, s, g, j,
                     "RelativeToConcurrentArmAttribute", i), collapse = "")
                # periJGinT: Cumulative difference between j*g and concurrent trad in time X.
                #  dummyLarge + dummyLarge.TimeX : periNrelativeT
                # +dummyAdiCattle0 + dummyAdiCattle0.TimeX : hvJinT
                # +dummyAdiCows0.Large+dummyAdiCows0.Large.TimeX : hvJGinT
                periJGinT <- periNrelativeT+hvJinT+hvJGinT
                lhcow <- glht(model=thisreg, linfct = matrix(periJGinT, byrow = T, nrow=1), 
                  alternative="two.sided", vcov.=thisV)
                confi <- rbind(confi, 
                  c(FNames[r], regtype, s, g, j, "j*g - trad, in each period", 
                    "periJGinT", 
                     i, confint(lhcow)$confint[1, ], 
                     if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
                  )
                linhyp <- c(linhyp, list(periNrelativeT, thisreg$coeff))
                names(linhyp)[length(linhyp)] <- 
                  paste0(c(FNames[r], regtype, s, g, j, "jg - trad in each period", i), collapse = "")
              } # end: cattle experience (Own/Adi) j loop
            } # end: if "sExperience in FileName[r]" loop
            ### Some outcomes do not have dummyUltraPoor as a level covariate. Need to fix it.
            ### Before doing so, abort these outcomes.
            if (grepl("Exper", FNames[r])) next
            if (grepl("Pa?$", reglists[[r]][rr])) {
              # if time-invariant poverty wise impacts are estimated
              # matP
              # Poor = 0 for trad
              # Poor + Arm.Poor = 0 for nontrad
              # covadd.trad
              # [[1]][1] "\\(Intercept\\)" ==> dummyUltraPoor
              # [[2]][1] "Time.3" ==> dummyUltraPoor.Time3
              # [[3]][1] "Time.4" ==> dummyUltraPoor.Time4
              # trad
              covadd.tradP <- lapply(covadd.trad, 
                function(x) gsub(".*ntercept.*", "dummyUltraPoor", x))
              covadd.tradP <- lapply(covadd.tradP, 
                function(x) gsub("T", "dummyUltraPoor.T", x))
              covadd.tradP <- lapply(covadd.tradP, 
                function(x) gsub("Time\\.", "Time", x))
              matPT <- rep(0, length(coeffvec))
              matPT[grepl(
                paste0("^", covadd.tradP[[1]], "$")
              , names(coeffvec))] <- 1*Mult
              # dummyInKind.Time4 ==> dummyInKind.UltraPoor.Time4
              covadd.nontradP <- lapply(covadd.nontrad, 
                function(x) gsub("T", "UltraPoor.T", x[2]))
              # nontrad 
              matPN <- rep(0, length(coeffvec))
              matPN[grepl(
                  paste0("^", covadd.nontradP[[i]], "$")
                , names(coeffvec))] <- 1*Mult
              matP <- rbind(matPT, matPN=matPT+matPN)
              lhcow <- glht(model=thisreg, linfct = matP, 
                alternative="two.sided", vcov.=thisV)
              confi <- rbind(confi, 
                c(FNames[r], regtype, s, g, "poor", "Poor + Arm.Poor = 0, time invariant", 
                  "matP", 
                   "2-4", confint(lhcow)$confint[1, ], 
                   if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA),
                c(FNames[r], regtype, s, g, "poor + arm*poor", "Poor + Arm.Poor = 0, time invariant", 
                  "matP", 
                   "2-4", confint(lhcow)$confint[2, ], 
                   if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[2] else NA)
               )
            } # end: if time-invariant poverty wise impacts are estimated
            if (grepl("TPa?$", reglists[[r]][rr])) {
              # if time-variant poverty wise impacts are estimated
              # dmatPTinT
              # Time = 2: Poor = 0; Time = 3: Poor.Time3 = 0  for trad
              # dmatPNinT
              # Time = 2: Arm.Poor = 0; Time = 3: Arm.Poor.Time3 = 0 for nontrad
              # TimeYY ==> dummyUltraPoor.TimeYY
              covadd.tradP <- lapply(covadd.trad, 
                function(x) gsub(".*ntercept.*", "dummyUltraPoor", x))
              covadd.tradP <- lapply(covadd.tradP, 
                function(x) gsub("T", "dummyUltraPoor.T", x))
              covadd.tradP <- lapply(covadd.tradP, 
                function(x) gsub("Time\\.", "Time", x))
              dmatPTinT <- rep(0, length(coeffvec))
              dmatPTinT[grepl(
                paste0("^", covadd.tradP[[i]], "$")
              , names(coeffvec))] <- 1*Mult
              # dummyInKind.Time4 ==> dummyInKind.UltraPoor.Time4
              covadd.nontradP <- lapply(covadd.nontrad, 
                function(x) gsub("T", "UltraPoor.T", x[2]))
              # nontrad 
              dmatPNinT <- rep(0, length(coeffvec))
              dmatPNinT[grepl(
                  paste0("^", covadd.nontradP[[i]], "$")
                , names(coeffvec))] <- 1*Mult
              # matPTinT: sum of (poor trad - nonpoor trad, in each period)
              # Time = 2: Poor = 0; Time = 3: Poor + Poor.Time3 = 0  for trad
              #   = matP + dmatPTinT
              # matPNinT: sum of (poor nontrad - nonpoor nontrad, in each period)
              # Time = 2: Poor + Arm.Poor = 0; Time = 3: Poor + Arm.Poor + Arm.Poor.Time3 = 0 for nontrad
              #   = matPTinT + dmatPNinT
              # Poor = 0 for trad
              matP <- rep(0, length(coeffvec))
              matP[grep("^dummyUltraPoor$", names(coeffvec))] <- 1*Mult
              matPTinT <- matP + dmatPTinT
              matPNinT <- matPTinT + dmatPNinT
              lhcow1 <- glht(model=thisreg, linfct = t(matrix(dmatPTinT)),
                alternative="two.sided", vcov.=thisV)
              lhcow2 <- glht(model=thisreg, linfct = t(matrix(dmatPNinT)),
                alternative="two.sided", vcov.=thisV)
              lhcow3 <- glht(model=thisreg, linfct = t(matrix(matPTinT)),
                alternative="two.sided", vcov.=thisV)
              lhcow4 <- glht(model=thisreg, linfct = t(matrix(matPNinT)),
                alternative="two.sided", vcov.=thisV)
              confi <- rbind(confi, 
                c(FNames[r], regtype, s, g, "dpoor.TimeX", 
                  "poor trad - nonpoor trad, in each period", "dmatPTinT", 
                   i, confint(lhcow1)$confint[1, ], 
                   if (sum(lhcow1$linfct) != 0) summary(lhcow1)$test$pvalues[1] else NA),
                c(FNames[r], regtype, s, g, "dpoor.Arm.TimeX", 
                  "poor nontrad - nonpoor nontrad, in each period", "dmatPNinT", 
                   i, confint(lhcow2)$confint[1, ], 
                   if (sum(lhcow2$linfct) != 0) summary(lhcow2)$test$pvalues[1] else NA),
                c(FNames[r], regtype, s, g, "poor.TimeX", 
                  "sum of (poor trad - nonpoor trad, in each period)", "matPTinT", 
                   i, confint(lhcow3)$confint[1, ], 
                   if (sum(lhcow3$linfct) != 0) summary(lhcow3)$test$pvalues[1] else NA),
                c(FNames[r], regtype, s, g, "poor.Arm.TimeX", 
                  "sum of (poor nontrad - nonpoor nontrad, in each period)", "matPNinT", 
                   i, confint(lhcow4)$confint[1, ], 
                   if (sum(lhcow4$linfct) != 0) summary(lhcow4)$test$pvalues[1] else NA)
               )
            } # end: if time-variant poverty wise impacts are estimated
          } # end: period i loop
        } # end: if "T in regtype" loop
      } # end: attribute g loop
    } # end: reg specification s loop 2:7
  } # end: reg type rr loop ("", "P", "a", "T", "Ta", ...)
} # end: outcome r loop
@
\hfil\begin{tabular}{
>{\scriptsize }p{1.25cm}<{}
>{\scriptsize }p{2.25cm}<{}
>{\scriptsize }p{7cm}<{}
>{\scriptsize }p{2.5cm}<{}
}
\rowcolor{gray90}
\hfil Object & \hfil What it does & \hfil Formula & \hfil Code\\
hvMofTA & average change = 0 (of males in trad school i) & Intercept + School = dMofT & addcovaMofT[c(1, i)]\\
hvFofTA & average change = 0 (of females in trad school i) & Intercept + School + Female + School.Female = hvMofTA + dFofT & hvMofTA + addcovaFofT[c(1, i)]\\
hvMofNA & average change = 0 (of nontrad arm g at school i) & intercept + Arm + School + Arm.School = hvMofTA + dMofNA & hvMofTA + addcovaMofN[c(1, i)]\\
hvFofNA & average change = 0 (of nontrad Arm g at School i for females) & Intercept + Arm + School + Female + Arm.School + Arm.Female + School.Female + Arm.School.Female = Intercept + Arm + School + Arm.School (hvMofNA) + Female + School.Female (dFofT) + Arm.Female + Arm.School.Female (dFofNA) = hvMofNA + dFofT + dFofNA& hvMofNA + dFofT + addcovaFofN[c(1, i)]\\
hvMofN & average difference = 0 (of nontrad Arm g relative to trad, at School i) & hvMofNA - hvMofTA = Arm + Arm.School & dMofNA\\
hvFofN & difference = 0 (of nontrad Arm g females to trad females, at School i) & hvFofNA - hvFofTA =  Arm + School + Female + Arm.School + Arm.Female + School.Female + Arm.School.Female - (School + Female + School.Female) = Arm + Arm.School + Arm.Female + Arm.School.Female = hvMofNA + dFofNA & hvMofNA + dFofNA\\
hvMofTinT & difference = 0 (of trad in timeX relative to period 2, at School i) & School + TimeX + School.TimeX - School = TimeX + School.TimeX & addteeMofTinT[c(1 ,i)]\\
hvFofTinT & difference = 0 (of female trad in timeX relative to period 2, at School i) & School + TimeX + Female + School.TimeX + School.Female + Female.TimeX + School.Female.TimeX - (School + Female + School.Female)= TimeX + School.TimeX + Female.TimeX + School.Female.TimeX  = hvMofTinT + FofTinT & hvMofTinT + addteeFofTinT[c(1 ,i)]\\
hvMofTinTL & cumulative change = 0 (of trad at school i in period X) & Intercept + School + TimeX + School.TimeX = hvMofTA + hvMofTinT & \\
hvFofTinTL & cumulative change = 0 (of female trad at school i in period X)  & Intercept + School + Female + TimeX + School.TimeX + School.Female + Female.TimeX + School.Female.TimeX = hvFofTA + hvFofTinT & \\
dMofNinT & diff = 0 (of nontrad change relative to concurrent trad change, at school iin period X) & 
TimeX + Arm.TimeX + School.TimeX + Arm.School.TimeX - (TimeX + School.TimeX) = Arm.TimeX + Arm.School.TimeX & addteeMofNinT[c(1 ,i)]\\
dFofNinT& diff = 0 (of female nontrad change relative to concurrent female trad change, at school i in period X) & 
TimeX + Arm.TimeX + Female.TimeX + School.TimeX
+ Arm.School.TimeX + Arm.Female.TimeX + Female.School.TimeX 
+ Arm.School.Female.TimeX 
- (TimeX + Female.TimeX + School.TimeX + Female.School.TimeX)
= Arm.TimeX + Arm.School.TimeX + Arm.Female.TimeX
+ Arm.School.Female.TimeX 
= dMofNinT + Arm.Female.TimeX + Arm.School.Female.TimeX
= dMofNinT + dFofNinT0 & addteeFofNinT[c(1 ,i)]\\
hvMofNinT & difference = 0 (of nontrad relative to concurrent trad, at school iin period X) & Arm + School + TimeX + Arm.School + Arm.TimeX + School.TimeX + Arm.School.TimeX - (School + TimeX + School.TimeX)= Arm + Arm.School + Arm.TimeX + Arm.School.TimeX = hvMofN + dMofNinT & hvMofN + dMofNinT\\
hvFofNinT & difference = 0 (of female nontrad relative to concurrent female trad, at school iin period X) & 
Arm + School + Female + TimeX + Arm.School + Arm.Female + Arm.TimeX + School.Female + School.TimeX + Female.TimeX + Arm.School.Female + Arm.School.TimeX + Arm.Female.TimeX + School.Female.TimeX + Arm.School.Female.TimeX - (School + Female + TimeX + School.Female + School.TimeX + Female.TimeX) = Arm + Arm.School  (MofN) + Arm.Female + Arm.School.Female  (dFofN)  + Arm.TimeX + Arm.School.TimeX (dMofNinT)+ Arm.Female.TimeX + Arm.School.Female.TimeX  (dFofNinT0) = hvMofN + dFofN + dMofNinT + dFofNinT0  = hvMofN + dFofN + dFofNinT & hvMofN + dFofNA + dFofNinT\\
hvMofNinTL & cumulative change = 0 (of nontrad school i in period X) & (intercept) + Arm + School + TimeX + Arm.School + Arm.TimeX + School.TimeX + Arm.School.TimeX = hvMofTinTL +  hvMofNinT & \\
&& (intercept) + School + TimeX + School.TimeX  (hvMofTinTL)
+ Arm + Arm.School (hvMofN)
+ Arm.TimeX + Arm.School.TimeX (dMofNinT) & \\
&& (intercept) + Arm + School + Arm.School (MofNA)
TimeX + School.TimeX (MofTinT)
Arm.TimeX + Arm.School.TimeX (dMofNinT) & \\
hvFofNinTL & cumulative change = 0 (of female nontrad school i in period X) & 
(intercept) + Arm + School + Female + TimeX + 
Arm.School + Arm.Female + Arm.TimeX + 
School.Female  + School.TimeX + Female.TimeX + 
Arm.School.Female + Arm.School.TimeX + Arm.Female.TimeX + School.Female.TimeX + 
Arm.School.Female.TimeX &\\
 &  & 
hvMofNinTL  
+ Female + School.Female  (dFofT)
+ Female.TimeX + School.Female.TimeX (dFofTinT)
+ Arm.Female + Arm.School.Female  (dFofNA)
+  Arm.Female.TimeX + Arm.School.Female.TimeX  (dFofNinT)
= hvMofNinTL + dFofT + dFofTinT + dFofNA + dFofNinT
& 
\end{tabular}


<<construct confis for diff schooling, eval = T, warning = F>>=
library(car)
library(multcomp)
# schooling
screglists <-  paste0("sc", 2:3)
schlevels <- c("primary", "junior", "high")
covadd <- covaddsch 
confis <- NULL
rr <- 4; s <- 2
r <- 1; g <- "Large"
for (rr in 1:length(reglists[[r]])) {
  # rr: regression type: "sc", "sca", "scP", "scT", "scTa", ....
  # regobj: e.g., "scT" with 7 regression specifications: 
  # specification s (from SchoolingCovariateSelectionANCOVA2.R):
  # 1. NA,
  # 2.  "|Enrolled0$",
    # add {dummyJunior/dummyHigh} and
    # {Arms}*{dummyJunior/dummyHigh} or
    # {Arms}*{dummyJunior/dummyHigh}*{Time.x}
  # 3.  "|^dummy[JH].*[rh]$|^dummy[CI].*[ed]\\.dummy[JH].*[rh]$|^dummy[LW].*[cgz]e\\.dummy[JH].*[rh]$|^dummy[JH].*[rh]\\.T|^dummy[CI].*[ed]\\.dummy[JH].*[rh]\\.T|^dummy[LW].*[cgz]e\\.dummy[JH].*[rh]\\.T",
  # 4.  "|ChildAge|Eldest|Head.*0|HHsize0|Flood",
    # add {Arms}*{dummyJunior/dummyHigh}*{Female}
    # {Arms}*{dummyJunior/dummyHigh}*{Female}*{Time.x}
  # 5. "|Female",
   #6. "|ChildAge|Eldest|Head.*0|HHsize0|Flood"
  regtype <- gsub("^..", "", reglists[[r]][rr])
  if (grepl("a", regtype)) 
    lattributes <- lattributeList[[2]] else
    lattributes <- lattributeList[[1]]
  regobj <- robj[[r]][[rr]]
  lmlist <- lapply(regobj, "[[", "lm")
  coefflist <- lapply(lmlist, "[[", "coefficients")
  # check NAs in coeff
  lapply(1:length(coefflist), function(i) c(i, names(coefflist[[i]])[is.na(coefflist[[i]])]))
  coefflist <- lapply(coefflist, function(x) x[!is.na(x)])
  Vlist <- lapply(lapply(regobj, "[[",  "robust"), "[[", "V")
  Mult <- 1
  covadd.trad <- lapply(covaddsch, function(x) x[1])
  # s-th specification
  for (s in 2:length(regobj)) {
    thisreg <- regobj[[s]]$lm
    coeffvec <- thisreg$coeff
    thisV <- regobj[[s]]$robust$V
    thisres <- regobj[[s]]$robust$est
    for (g in lattributes) {
      # lattributes: 
      #  Arms (Large, LargeGrace, Cattle) or 
      #  functional attributes (Upfront, Grace, InKind)
      addcova <- lapply(covaddsch, function(x) gsub("XX", g, x))
      # covaddsch[1]: $MofT: \\(Intercept\\), ^dummyJunior$, ^dummyHigh$
      # covaddsch[2]: $FofT: ^Female$, ^dummyJunior.Female$, ^dummyHigh.Female$
      # covaddsch[4]: $FofN: ^dummyXX.Female$, ^dummyXX.dummyJunior.Female$,
      #   ^dummyXX.dummyHigh.Female$
      # covaddsch[7]: $MofNinT: ^dummyXX.TimeYY$, ^dummyXX.dummyJunior.TimeYY$,
      #   ^dummyXX.dummyHigh.TimeYY$
      # So, for example, g = Large gives
      # addcova[4]: $FofN: ^dummyLarge.Female$, ^dummyLarge.dummyJunior.Female$,
      #   ^dummyLarge.dummyHigh.Female$
      # addcova[7]: $MofNinT: ^dummyLarge.TimeYY$, ^dummyLarge.dummyJunior.TimeYY$,
      #   ^dummyLarge.dummyHigh.TimeYY$
      # names(addcova): MofT, FofT, MofN, FofN, MofTinT, FofTinT, MofNinT, FofNinT
      #   male of trad, female of trad, male of nontrad, female of nontrad, 
      #   male of trad in T, female of trad in T, male of nontrad in T, female of nontrad in T
      for (gg in names(addcova))
        assign(paste0("addcova", gg), addcova[[gg]])
      # i: school level
      # addcovaMofT: \\(Intercept\\), ^dummyJunior$, ^dummyHigh$
      for (i in 1:length(addcovaMofT)) {
        # hvMofTA: average change = 0 (of males in trad school i)
        #  Intercept + School 
        #  = MofT
        #  [[1]]"\\(Intercept\\)" "^dummyJunior$"   "^dummyHigh$"
        hvMofTA <- rep(0, length(coeffvec))
        # i picks up: 1 = primary, 2 = primary+dJunior, 3 = primary+dHigh
        hvMofTA[grepl(
             paste0(unique(addcovaMofT[c(1, i)]), collapse = "|")
            , names(coeffvec))] <- 1*Mult
        if (any(is.na(coeffvec))) hvMofTA <- hvMofTA[!is.na(coeffvec)]
        lhcow <- glht(model=thisreg, linfct = matrix(hvMofTA, byrow = T, nrow=1), 
          alternative="two.sided", vcov.=thisV)
        confis <- rbind(confis, 
           c(FileNames[r], regtype, s, "traditional", "male", schlevels[i], 
             "level of reference trad", "2-4", "MofTA", 
             confint(lhcow)$confint[1, ], 
             if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
           )
        # hvFofTA: average change = 0 (of females in trad school i)
        # addcovaFofT: ^Female$, ^dummyJunior.Female$, ^dummyHigh.Female$
        # Intercept+School+^Female$+Female.School
        # = hvMofTA + dFofT
        # For s < 4: There is no Female term. This copies male coefficient.
        # Just use male estimates and label them as "all".
        # After the loop, 
        #  drop s<4 & grepl("female", gender), rewrite "male" => "all"
        hvFofTA <- dFofT <- rep(0, length(coeffvec))
        dFofT[grepl(
             paste0(addcovaFofT[c(1, i)], collapse = "|")
            , names(coeffvec))] <- 1*Mult
        hvFofTA <- hvMofTA + dFofT
        lhcow <- glht(model=thisreg, linfct = matrix(hvFofTA, byrow = T, nrow=1), 
          alternative="two.sided", vcov.=thisV)
        confis <- rbind(confis, 
           c(FileNames[r], regtype, s, "traditional", "female", schlevels[i], 
             "level of reference female trad", "2-4", "FofTA", 
             confint(lhcow)$confint[1, ], 
             if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
           )
        # nontrad
        # construct coefficient names for attribute g
        covadd.nontrad <- lapply(covadd, function(x) gsub("XX", g, x))
        # gross = trad + delta.Arm
        # hvMofNA: average change = 0 (of nontrad arm g at school i)
        # addcovaMofT: \\(Intercept\\), ^dummyJunior$, ^dummyHigh$
        # addcovaMofN: ^dummyLarge$, ^dummyLarge.dummyJunior$, ^dummyLarge.dummyHigh$
        # intercept + School + Arm + Arm.School 
        # = hvMofTA + dMofN
        #  [[1]]"\\(Intercept\\)", "School", "dummyInKind.School"
        dMofNA <- rep(0, length(coeffvec))
        dMofNA[grepl(
             paste0(addcovaMofN[c(1, i)], collapse = "|")
            , names(coeffvec))] <- 1*Mult
        hvMofNA <- hvMofTA + dMofNA
        lhcow <- glht(model=thisreg, linfct = matrix(hvMofNA, byrow = T, nrow=1), 
          alternative="two.sided", vcov.=thisV)
        confis <- rbind(confis, 
             c(FileNames[r], regtype, s, g, "male", schlevels[i], 
               "level of nontrad at school", "2-4", "MofNA", 
               confint(lhcow)$confint[1, ], 
               if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
          )
        # hvFofNA: average change = 0 (of female nontrad Arm g at School i)
        #  \\(Intercept\\)+Arm+School+Female+Arm.School+Arm.Female+School.Female+Arm.School.Female
        #  \\(Intercept\\)+Arm+School+Arm.School + Female+School.Female + Arm.Female+Arm.School.Female
        # hvMofNA + dFofT + dFofNA
        dFofNA <- rep(0, length(coeffvec))
        dFofNA[grepl(
             paste0(addcovaFofN[c(1, i)], collapse = "|")
            , names(coeffvec))] <- 1*Mult
        hvFofNA <- hvMofNA + dFofT + dFofNA
        lhcow <- glht(model=thisreg, linfct = matrix(hvFofNA, byrow = T, nrow=1), 
          alternative="two.sided", vcov.=thisV)
        confis <- rbind(confis, 
             c(FileNames[r], regtype, s, g, "female", schlevels[i], 
               "level of female nontrad at school", "2-4", "FofNA", 
               confint(lhcow)$confint[1, ], 
               if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
          )
        # hvMofN: average difference = 0 (of nontrad Arm g relative to trad, at School i)
        #  hvMofNA - hvMofTA = Arm + Arm.School
        #  dummyInKind + dummyInKind.School
        hvMofN <- hvMofNA - hvMofTA
        lhcow <- glht(model=thisreg, linfct = matrix(hvMofN, byrow = T, nrow=1), 
          alternative="two.sided", vcov.=thisV)
        confis <- rbind(confis, 
             c(FileNames[r], regtype, s, g, "male", schlevels[i], 
               "nontrad - trad, at school", "2-4", "MofN", 
               confint(lhcow)$confint[1, ], 
               if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
          )
        # hvFofN: difference = 0 (of nontrad Arm g females to trad females, at School i)
        #  hvFofNA - hvFofTA = Arm + Arm.School + Arm.Female + Arm.School.Female
        #  = hvMofN + dFofNA
        hvFofN <- hvMofN + dFofNA
        lhcow <- glht(model=thisreg, linfct = matrix(hvFofN, byrow = T, nrow=1), 
          alternative="two.sided", vcov.=thisV)
        confis <- rbind(confis, 
             c(FileNames[r], regtype, s, g, "female", schlevels[i], 
               "female nontrad - female trad, at school", "2-4", "FofN", 
               confint(lhcow)$confint[1, ], 
               if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
          )
        for (tee in 2:4) {
          for (gg in names(addcova)) {
            # for gg (each comparison addcova), substitute period = 3, 4 to YY
            adc <- get(paste0("addcova", gg))
            assign(paste0("addtee", gg), gsub("YY", tee, adc))
            # addcovaMofNinT: ^dummyLarge.TimeYY$, ^dummyLarge.dummyJunior.TimeYY$,
            #   ^dummyLarge.dummyHigh.TimeYY$
            # So, for example, tee = 3 gives
            # addteeMofNinT: ^dummyLarge.Time3$, ^dummyLarge.dummyJunior.Time3$,
            #   ^dummyLarge.dummyHigh.Time3$
            # addcovaFofNinT: ^dummyInKind.Female.TimeYY, 
            #  ^dummyInKind.dummyJunior.Female.TimeYY$, 
            #  ^dummyInKind.dummyHigh.Female.TimeYY$
            # So, for example, tee = 3 gives
            # addteeFofNinT: ^dummyInKind.Female.Time3, 
            #  ^dummyInKind.dummyJunior.Female.Time3$, 
            #  ^dummyInKind.dummyHigh.Female.Time3$
          }
          # hvMofTinT: trad timeX - trad period 2, at school i
          #  School + TimeX + School.TimeX - School
          #  = TimeX + School.TimeX
          #  at tee == 2, (trad timeX - trad period 2, at school i) = 0
          hvMofTinT <- rep(0, length(coeffvec))
          if (tee > 2) 
            hvMofTinT[grepl(
               paste0(addteeMofTinT[c(1 ,i)], collapse = "|")
               , names(coeffvec))] <- 1*Mult
          lhcow <- glht(model=thisreg, linfct = matrix(hvMofTinT, 
            byrow = T, nrow=1), alternative="two.sided", vcov.=thisV)
          confis <- rbind(confis, 
               c(FileNames[r], regtype, s, "traditional", "male", schlevels[i], 
                 "trad in each period - trad in period 2, at school", tee, 
                 "MofTinT", 
                 confint(lhcow)$confint[1, ], 
                 if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
            )
          # female
          # hvFofTinT: female trad timeX - female trad period 2, at school i
          #  School + TimeX + Female
          #   + School.TimeX + School.Female + Female.TimeX + School.Female.TimeX 
          #   - (School + Female + School.Female)
          #  = TimeX + School.TimeX  (hvMofTinT)
          #     +Female.TimeX + School.Female.TimeX ... dFofTinT
          #  = hvMofTinT                + dFofTinT
          #  at tee == 2, (female trad timeX - female trad period 2, at school i) = 0
          dFofTinT <- rep(0, length(coeffvec))
          if (tee > 2) 
            dFofTinT[grepl(
              paste0(addteeFofTinT[c(1 ,i)], collapse = "|")
              , names(coeffvec))] <- 1*Mult
          hvFofTinT <- hvMofTinT + dFofTinT
          lhcow <- glht(model=thisreg, linfct = matrix(hvFofTinT, 
            byrow = T, nrow=1), alternative="two.sided", vcov.=thisV)
          confis <- rbind(confis, 
               c(FileNames[r], regtype, s, "traditional", "female", schlevels[i], 
                 "female trad in each period - period 2 female trad, at school", tee, 
                 "FofTinT", 
                 confint(lhcow)$confint[1, ], 
                 if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
            )
          # hvMofTinTL: cumulative change = 0 (of trad school i in period X)
          # Intercept+School+TimeX+School.TimeX
          #  = hvMofTA + hvMofTinT
          # if tee == 2
          #   Intercept+School = hvMofTA
          hvMofTinTL <- hvMofTA + hvMofTinT
          if (tee == 2) hvMofTinTL <- hvMofTA
          lhcow <- glht(model=thisreg, linfct = matrix(hvMofTinTL, 
            byrow = T, nrow=1), alternative="two.sided", vcov.=thisV)
          confis <- rbind(confis, 
               c(FileNames[r], regtype, s, "traditional", "male", schlevels[i], 
                 "level of trad in each period, at school", tee, 
                 "MofTinTL", 
                 confint(lhcow)$confint[1, ], 
                 if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
            )
          hvFofTinTL <- hvFofTA + hvFofTinT
          if (tee == 2) hvFofTinTL <- hvFofTA
          lhcow <- glht(model=thisreg, linfct = matrix(hvFofTinTL, 
            byrow = T, nrow=1), alternative="two.sided", vcov.=thisV)
          confis <- rbind(confis, 
               c(FileNames[r], regtype, s, "traditional", "female", schlevels[i], 
                 "level of female trad in each period, at school", tee, 
                 "FofTinTL", 
                 confint(lhcow)$confint[1, ], 
                 if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
            )
          # dMofNinT: diff = 0 (of nontrad change relative to concurrent trad change, at school iin period X)
          #  TimeX + Arm.TimeX + School.TimeX + Arm.School.TimeX 
          #    - (TimeX + School.TimeX)
          #  = Arm.TimeX + Arm.School.TimeX 
          # addteeMofNinT: ^dummyLarge.Time3$, ^dummyLarge.dummyJunior.Time3$,
          #   ^dummyLarge.dummyHigh.Time3$
          dMofNinT <- dFofNinT <- dFofNinT0 <- rep(0, length(coeffvec))
          dMofNinT[grepl(
            paste0(addteeMofNinT[c(1 ,i)], collapse = "|")
            , names(coeffvec))] <- 1*Mult
          # if tee == 2: Arm + Arm.School = hvMofN
          if (tee == 2) dMofNinT <- hvMofN
          lhcow <- glht(model=thisreg, linfct = matrix(dMofNinT, 
            byrow = T, nrow=1), alternative="two.sided", vcov.=thisV)
          confis <- rbind(confis, 
               c(FileNames[r], regtype, s, g, "male", schlevels[i], 
                 "nontrad change - trad change, in each period, at school", tee, 
                 "dMofNinT", 
                 confint(lhcow)$confint[1, ], 
                 if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
            )
          # hvMofNinT: diff = 0 (of nontrad relative to concurrent trad, at school iin period X)
          #  Arm + School + TimeX + Arm.School + Arm.TimeX + School.TimeX + Arm.School.TimeX 
          #    - (School + TimeX + School.TimeX)
          #  = Arm + Arm.School + Arm.TimeX + Arm.School.TimeX 
          #  = hvMofTinT + dMofNinT
          # addteeMofNinT: ^dummyLarge.Time3$, ^dummyLarge.dummyJunior.Time3$,
          #   ^dummyLarge.dummyHigh.Time3$
          hvMofNinT <- hvMofTinT + dMofNinT
          # hvMofN (Arm + Arm.School)
          if (tee == 2) hvMofNinT <- hvMofN
          lhcow <- glht(model=thisreg, linfct = matrix(hvMofNinT, 
            byrow = T, nrow=1), alternative="two.sided", vcov.=thisV)
          confis <- rbind(confis, 
               c(FileNames[r], regtype, s, g, "male", schlevels[i], 
                 "nontrad - trad, in each period, at school", tee, 
                 "MofNinT", 
                 confint(lhcow)$confint[1, ], 
                 if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
            )
          # dFofNinT: diff = 0 (of female nontrad change relative to concurrent female trad change, at school i in period X)
          #  TimeX + Arm.TimeX + Female.TimeX + School.TimeX + 
          #   + Arm.School.TimeX + Arm.Female.TimeX + Female.School.TimeX 
          #   + Arm.School.Female.TimeX 
          #    - (TimeX + Female.TimeX + School.TimeX + Female.School.TimeX)
          #  = Arm.TimeX + Arm.School.TimeX + Arm.Female.TimeX
          #   + Arm.School.Female.TimeX 
          #  = dMofNinT + Arm.Female.TimeX + Arm.School.Female.TimeX
          #  = dMofNinT + dFofNinT0
          # addteeFofNinT:  "^dummyInKind.Female.Time4$, 
          #  ^dummyInKind.dummyJunior.Female.Time4$, 
          #  ^dummyInKind.dummyHigh.Female.Time4$
          dFofNinT0[grepl(
            paste0(addteeFofNinT[c(1 ,i)], collapse = "|")
            , names(coeffvec))] <- 1*Mult
          dFofNinT <- dMofNinT + dFofNinT0
          # if tee == 2: Arm.TimeX + Arm.School.TimeX + Arm.Female.TimeX
          #   + Arm.School.Female.TimeX 
          #  =  Arm + Arm.School + Arm.Female+ Arm.School.Female
          #  = hvFofN
          if (tee == 2) dFofNinT <- hvFofN
          lhcow <- glht(model=thisreg, linfct = matrix(dFofNinT, 
            byrow = T, nrow=1), alternative="two.sided", vcov.=thisV)
          confis <- rbind(confis, 
               c(FileNames[r], regtype, s, g, "female", schlevels[i], 
                 "female nontrad change - female trad change, in each period, at school", tee, 
                 "dFofNinT", 
                 confint(lhcow)$confint[1, ], 
                 if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
            )
          # hvFofNinT: diff = 0 (of female nontrad relative to concurrent female trad, at school iin period X)
          #  Arm + Arm.School + Arm.Female + Arm.TimeX + 
          #  Arm.School.Female + Arm.School.TimeX + Arm.Female.TimeX + 
          #  Arm.School.Female.TimeX
          #  = Arm + Arm.School  (MofN)
          #   + Arm.Female + Arm.School.Female  (dFofNA)
          #   + Arm.TimeX + Arm.School.TimeX (dMofNinT)
          #   +  Arm.Female.TimeX + Arm.School.Female.TimeX  (dFofNinT0)
          #  = hvMofN + dFofNA + dMofNinT + dFofNinT0
          #  = hvMofN + dFofNA + dFofNinT
          hvFofNinT <- hvMofN + dFofNA + dFofNinT
          # if tee == 2,
          #  = Arm + Arm.School  (MofN)
          #   + Arm.Female + Arm.School.Female  (dFofNA)
          #  = hvFofN
          if (tee == 2) hvFofNinT <- hvMofN + dFofNA
          lhcow <- glht(model=thisreg, linfct = matrix(hvFofNinT, 
            byrow = T, nrow=1), alternative="two.sided", vcov.=thisV)
          confis <- rbind(confis, 
               c(FileNames[r], regtype, s, g, "female", schlevels[i], 
                 "female nontrad - female trad, in each period, at school", 
                 tee, "FofNinT", 
                 confint(lhcow)$confint[1, ], 
                 if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
            )
          # hvMofNinTL: cumulative change = 0 (of nontrad school i in period X)
          #  (intercept) + School + TimeX + School.TimeX 
          #    + Arm + Arm.School 
          #    + Arm.TimeX + Arm.School.TimeX 
          #  = hvMofTinTL + hvMofN + hvMofNinT
          hvMofNinTL <- hvMofTinTL + hvMofN + hvMofNinT
          #  if tee == 2
          #  (intercept) + School + Arm + Arm.School 
          #  = hvMofTA
          if (tee == 2) hvMofNinTL <- hvMofTA
          lhcow <- glht(model=thisreg, linfct = matrix(hvMofNinT, 
            byrow = T, nrow=1), alternative="two.sided", vcov.=thisV)
          confis <- rbind(confis, 
               c(FileNames[r], regtype, s, g, "male", schlevels[i], 
                 "level of nontrad in each period at school", tee, 
                 "MofNinTL", 
                 confint(lhcow)$confint[1, ], 
                 if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
            )
          # hvFofNinTL: cumulative change = 0 (of female nontrad school i in period X)
          #  (intercept) + School + TimeX + School.TimeX 
          #   + Arm + Arm.School 
          #   + Arm.TimeX + Arm.School.TimeX 
          #   + Female + School.Female  (dFofT)
          #   + Female.TimeX + School.Female.TimeX (dFofTinT)
          #   + Arm.Female + Arm.School.Female  (dFofNA)
          #   +  Arm.Female.TimeX + Arm.School.Female.TimeX  (dFofNinT0)
          # = hvMofNinTL + dFofT + dFofTinT + dFofNA + dFofNinT0
          hvFofNinTL <- hvMofTinTL + dFofT + dFofTinT + dFofNA + dFofNinT0
          #  if tee == 2
          #  (intercept) + School + Arm + Arm.School  (hvMofTA)
          #   + Female + School.Female  (dFofT)
          #   + Arm.Female + Arm.School.Female  (dFofNA)
          if (tee == 2) hvFofNinTL <- hvMofTA + dFofT + dFofNA
          lhcow <- glht(model=thisreg, linfct = matrix(hvFofNinTL, 
            byrow = T, nrow=1), alternative="two.sided", vcov.=thisV)
          confis <- rbind(confis, 
               c(FileNames[r], regtype, s, g, "female", schlevels[i], 
                 "level of female nontrad in each period at school", 
                 tee, "FofNinTL", 
                 confint(lhcow)$confint[1, ], 
                 if (sum(lhcow$linfct) != 0) summary(lhcow)$test$pvalues[1] else NA)
            )
        }  # end: TimeT tee loop
      } # end: school level i loop
    } # end: attribute g loop
  } # end: specification s loop
} # end: regression type rr loop
@

dMofT=addcovaMofT[c(1, i)] \Sexpr{gsub("\\\\|\\^|\\$", "", addcovaMofT)}

dFofT=addcovaFofT[c(1, i)] \Sexpr{gsub("\\\\|\\^|\\$", "", addcovaFofT)}

dMofNA=addcovaMofN[c(1, i)] \Sexpr{gsub("\\\\|\\^|\\$", "", addcovaMofN)}

dFofNA=addcovaFofN[c(1, i)] \Sexpr{gsub("\\\\|\\^|\\$", "", addcovaFofN)}

hvMofTinT=addteeMofTinT[c(1 ,i)] \Sexpr{gsub("\\\\|\\^|\\$", "", addteeMofTinT)}

dFofTinT=addteeFofTinT[c(1 ,i)] \Sexpr{gsub("\\\\|\\^|\\$", "", addteeFofTinT)}

dMofNinT=addteeMofNinT[c(1 ,i)] \Sexpr{gsub("\\\\|\\^|\\$", "", addteeMofNinT)}

dFofNinT=addteeFofNinT[c(1 ,i)] \Sexpr{gsub("\\\\|\\^|\\$", "", addteeFofNinT)}

<<reshape confi Do This Mannually, eval = T, warning = F>>=
confi <- data.table(unique(confi))
setnames(confi, c("FileName", "regtype", "num", "attributes", "experience",
  "ImpactType", "hv", "period", "estimate", "lb", "ub", "pvalue"))
numcols <- c("period", "estimate", "lb", "ub", "num", "pvalue")
confi[, (numcols) := lapply(.SD, as.numeric), .SDcols = numcols]
faccols <- c("FileName", "regtype", "attributes", "experience", "hv", "ImpactType")
confi[, (faccols) := lapply(.SD, as.factor), .SDcols = faccols]
#### Drop all num == 1 except for ConsumptionOLS, 
#### NumCows and NumCowsAdi, NumCowsNone, NumCowsOwn, 
confi <- confi[grepl("NumCows|OLS", FileName) | (!grepl("NumCows", FileName) & num != 1), ]
confi <- confi[!(grepl("NumCowsE", FileName) & num == 1), ]
table(confi[, .(FileName, num)])
confi[, ImpactType := factor(ImpactType, 
  levels = c(
    "level of reference trad",
    "level of trad in period X",
    "level of reference nontrad",
    "level of nontrad in each period",
    "reference nontrad - reference trad",
    "trad in each period - trad in period 2",
    "nontrad in each period - trad in period 2",
    "nontrad in each period - nontrad in period 2",
    "nontrad - trad, in each period",
    "sum of (nontrad - trad, in each period)",
    "j - trad, in each period",
    "j*g - trad, in period 2",
    "j*g - trad, in each period",
    "j*g - g, in each period",
    "Poor + Arm.Poor = 0, time invariant",
    "poor trad - nonpoor trad, in each period",
    "poor nontrad - nonpoor nontrad, in each period",
    "sum of (poor trad - nonpoor trad, in each period)",
    "sum of (poor nontrad - nonpoor nontrad, in each period)"
  ))]
confi[, ImpactType := factor(ImpactType, 
  labels = c(
    "level of reference trad",
    "level of trad in each period",
    "level of reference nontrad",
    "level of nontrad in each period",
    "reference nontrad - reference trad",
    "trad in each period - trad in period 2",
    "nontrad in each period - trad in period 2",
    "nontrad in each period - nontrad in period 2",
    "nontrad - trad, in each period",
    "sum of (nontrad - trad, in each period)",
    "j - trad, in each period",
    "j*g - trad in period 2",
    "j*g - trad, in each period",
    "j*g - g, in each period",
    "poor - nonpoor, in all arms, time invariant",
    "poor trad - nonpoor trad, in each period",
    "poor nontrad - nonpoor nontrad, in each period",
    "sum of (poor trad - nonpoor trad, in each period)",
    "sum of (poor nontrad - nonpoor nontrad, in each period)"
))]


confi[grepl("Con.*O", FileName) & regtype=="T" & grepl("ge$", attributes) & grepl("sum", ImpactType), ]



confi[, period := period + 1]
# period is NA for non-timevarying regressions
confi[!grepl("T", regtype), period := NA]
confi[!is.na(period) & grepl("Con.*O", FileName) & num == 2 & grepl("Ta", regtype), ][
order(attributes, ImpactType, period)]
#confi <- rbindlist(list(confi, confis), use.names = T, fill = T)
setcolorder(confi, c("FileName", "regtype", "num", "attributes", 
  "hv", "ImpactType", "period", "lb", "estimate", "ub"))
confi <- confi[!(grepl("Con", FileName) & estimate == 0), ]
#### Drop 3rd reg spec of Con. This is the same as 2nd reg spec.
confi <- confi[!(grepl("Con", FileName) & num == 3), ]
confi[, attributes := factor(attributes, 
  levels = c("trad", "Large", "LargeGrace", "Cattle",
  "LargeSize", "WithGrace", "InKind"))]
confi[, attributes := factor(attributes, 
  labels = c("Traditional", "Large", "LargeGrace", "Cattle",
  "Upfront", "WithGrace", "InKind"))]
confi[, experience := factor(experience, 
  levels = c("None", "dummyAdiCattle0", "dummyOwnCattle0"))]
confi[, experience := factor(experience, 
  labels = c("None", "AdiCattle", "OwnCattle"))]
# NumCows reg specs
# 1. NA,
# 2. "|NumCows0$",
# 3. "|Head|Flood|HH",
# 4. "|^dummyHadCows"
# 5. "|TotalImp.*0$"
# NumCowsByExperience reg specs
# Own subsample (1=OLS, 2=ANCOVA, 3=ANCOVA with covariates, 4=ditto)
# 1. NA,
# 2. "|NumCows0$",
# 3. "|Head|Flood|HH|^NetVa.*0$",
# 4. "|NumC.*0$"
# Adi, None subsamples (1=OLS, 3=OLS with covariates)
# 1. NA, 
# 2. "", # "|NumC.*0$" is NA if own=none, adi. Lead to error in linear hyp testing. Set to NA.
# 3. "|Head|Flood|HH|^NetVa.*0$",
# 4. ""
# Comparable: 
#  NumCows 1 = 1 in all others
#  NumCows 2 = 2 in Own, 
#  NumCows 3 = 3 in Own, 3 in Adi, None (OLS, though)
confi[, AtType := "Arms (relative to Traditional)"]
confi[grepl("With|Kin", attributes), AtType := "Functional attributes (relative to Upfront, Upfront+WithGrace)"]
confi[grepl("^NinT$|TinT", hv), AtType := "Arms (relative to own in period 2)"]
confi[grepl("N2$|T0|N0", hv), AtType := "Levels"]
confi[, AtType := factor(AtType)]
confi[, regressand := "livestock"]
confi[grepl("Sch", FileName), regressand := "enrollment"]
confi[grepl("Cows$", FileName), regressand := "cattle"]
confi[grepl("CowsEx", FileName), regressand := "cattle, Experience"]
confi[grepl("CowsBy.*a$", FileName), regressand := "cattle, Adi"]
confi[grepl("CowsBy.*o$", FileName), regressand := "cattle, Own"]
confi[grepl("CowsBy.*n$", FileName), regressand := "cattle, None"]
confi[grepl("^NetAssets", FileName), regressand := "net assets"]
confi[grepl("^NetBroad.*ts$", FileName), regressand := "net broad assets"]
confi[grepl("^Net.*ea$", FileName), regressand := "net assets, Adi"]
confi[grepl("^Net.*eo$", FileName), regressand := "net assets, Own"]
confi[grepl("^Net.*en$", FileName), regressand := "net assets, None"]
confi[grepl("Net.*Pri", FileName), regressand := "net assets, AP"]
confi[grepl("tsEx", FileName), regressand := gsub("$", ", Experience", regressand)]
#confi[grepl("^AssetL", FileName), regressand := "broad total assets"]
confi[grepl("^NetNL", FileName), regressand := "net non-livestock assets"]
confi[grepl("Lan", FileName), regressand := "land"]
confi[grepl("Lab", FileName), regressand := "labour incomes"]
confi[grepl("Consumption$", FileName), regressand := "consumption"]
confi[grepl("ConsumptionO", FileName), regressand := "consumption, OLS"]
confi[, FileName := gsub("^Asset", "BroadAsset", FileName)]
confi[, FileName := gsub("ByExperiencea", "Adi", FileName)]
confi[, FileName := gsub("ByExperienceo", "Own", FileName)]
confi[, FileName := gsub("ByExperiencen", "None", FileName)]
confi[, regressand := factor(regressand)]
confi[, FileName := factor(FileName)]
#confi[grepl("far", FileName), regressand := "farm incomes"]
# confi[grepl("sv", FileName), regressand := "net saving"]
# confi[grepl("sv.[45]", FileName), regressand := "repayment"]
# confi[grepl("sv.[78]", FileName), regressand := "effective repayment"]
# confi[grepl("sc", FileName), regressand := "schooling"]
confi[, attributes := factor(attributes, levels = 
  c("Traditional", "Large", "LargeGrace", "Cattle", "Upfront", "WithGrace", "InKind"))]
confi[, regressand := factor(regressand, levels = 
  c("land", "livestock", #"broad total assets", 
    "net non-livestock assets", 
    paste0(rep(c("net assets", "cattle"), each = 5), 
      rep(c("", ", Adi", ", None", ", Own", ", Experience"), 2))
    , "net broad assets", "net assets, AP", 
    "enrollment", "consumption", "consumption, OLS", "labour incomes")
      )]
saveRDS(confi, paste0(pathsaveHere, "EstimatesCI.rds"))
qsave(confi, paste0(pathsaveHere, "EstimatesCI.qs"))
saveRDS(linhyp, paste0(pathsaveHere, "LinearHypothesis.rds"))
<<reshape confis, eval = T, warning = F>>=
confis <- data.table(confis)
setnames(confis, c("FileName", "regtype", "num", "attributes", 
  "gender", "school", "ImpactType", "period", "hv", "estimate", "lb", "ub", "pvalue"))
 # traditional has 4 same entries when computing interactions 
confis <- confis[!duplicated(confis), ]
# drop: b, a, P have zero in time interaction tests (e.g., TimeX + Arm.TimeX for X == 2)
confis <- confis[estimate != 0, ]
numcols <- c("period", "estimate", "lb", "ub", "num", "pvalue")
confis[, (numcols) := lapply(.SD, as.numeric), .SDcols = numcols]
# drop: females are only added for specification s >= 5 & regtype = T, rewrite "male" => "all"
confis <- confis[!(num < 5 & grepl("female", ImpactType)), ]
# Note: rewrite "male" => "all" for num < 5, 
# we are losing gender = "male" entries for specification < 5. 
# Need to get gender = all entries for graphs. But this should not be a problem 
# as we need "male" entries only when we contrast with females (num>=5).
confis[num < 5 & grepl("male", gender), gender := "all"]
confis[grepl("T", regtype) & num < 5 & grepl("ref", ImpactType), ][
  order(regtype, num, attributes, ImpactType, period), ]
faccols <- c("FileName", "regtype", "attributes", "ImpactType", "hv", "gender", "school")
confis[, (faccols) := lapply(.SD, as.factor), .SDcols = faccols]
confis[, ImpactType := factor(ImpactType, 
  levels = c(
    "level of reference trad",
    "level of reference female trad",
    "level of trad in each period, at school",
    "level of female trad in each period, at school",
    "trad in each period - trad in period 2, at school",
    "female trad in each period - period 2 female trad, at school",
    "level of nontrad at school",
    "level of female nontrad at school",
    "level of nontrad in each period at school",
    "level of female nontrad in each period at school",
    "nontrad - trad, at school",
    "female nontrad - female trad, at school",
    "nontrad change - trad change, in each period, at school",
    "female nontrad change - female trad change, in each period, at school",
    "nontrad - trad, in each period, at school",
    "female nontrad - female trad, in each period, at school"
  ))]
confis[, ImpactType := factor(ImpactType, 
  labels = c(
    "level of reference trad",
    "level of reference female trad",
    "level of trad in each period at school",
    "level of female trad in each period at school",
    "trad in each period - trad in period 2, at school",
    "female trad in each period - period 2 female trad, at school",
    "level of nontrad at school",
    "level of female nontrad at school",
    "level of nontrad in each period at school",
    "level of female nontrad in each period at school",
    "nontrad - trad, at school",
    "female nontrad - female trad, at school",
    "nontrad change - trad change, in each period, at school",
    "female nontrad change - female trad change, in each period, at school",
    "nontrad - trad, in each period, at school",
    "female nontrad - female trad, in each period, at school"
  ))]
confis[, hv := factor(hv, 
  levels = c(
  "MofTA", "FofTA", "MofNA", "FofNA", "MofN", "FofN",
   "MofTinT", "FofTinT", "MofTinTL", "FofTinTL",
   "dMofNinT", "dFofNinT", "MofNinT" , "FofNinT",
   "MofNinTL", "FofNinTL"
  ))]
confis[, school := factor(school, levels = c("primary", "junior", "high"))]
confis[!grepl("T", regtype), period := NA]
setcolorder(confis, c("FileName", "regtype", "num", "attributes", 
  "ImpactType", "period", "lb", "estimate", "ub"))
confis[, attributes := factor(attributes, 
  levels = c("traditional", "Large", "LargeGrace", "Cattle",
  "LargeSize", "WithGrace", "InKind"))]
confis[, attributes := factor(attributes, 
  labels = c("Traditional", "Large", "LargeGrace", "Cattle",
  "Upfront", "WithGrace", "InKind"))]
confis[, AtType := "Arms (relative to Traditional)"]
confis[grepl("With|Kin", attributes), AtType := "Functional attributes (relative to Upfront, Upfront+WithGrace)"]
confis[, AtType := factor(AtType)]
saveRDS(confis, paste0(pathsaveHere, "EstimatesCISchooling.rds"))
qsave(confis, paste0(pathsaveHere, "EstimatesCISchooling.qs"))
confis[grepl("^.ofNinT$", hv) & grepl("T$", regtype) & grepl("ge$", attributes) & 
  grepl("j", school) & num == 5, ][order(gender, period), ]
<<delete robj>>=
rm(robj)
@
<<read confidence interval>>=
confi <- qread(paste0(pathsaveHere, "EstimatesCI.qs"))
confis <- qread(paste0(pathsaveHere, "EstimatesCISchooling.qs"))
linhyp <- readRDS(paste0(pathsaveHere, "LinearHypothesis.rds"))
<<figure absolute changes in assets, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 10, fig.cap = paste0("Gross impacts on asset holding", "\\\\ {\\footnotesize \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
# not impacts as it does not take difference with trad, just averages
library(ggplot2)
NeA1R2 <- readRDS(paste0(pathsaveHere, "NetAssetsANCOVA.rds"))
na1 <- NeA1R2[o800 == 1L & !is.na(tee), 
 c("Arm", "hhid", "tee", 
    grepout("^Br.*tValue$|^NetNL.*Value|NumCows$|^NetValue$", colnames(NeA1R2))), 
    with = F]
## modify monthly count
setnames(na1, 
  grepout("^Br.*tValue$|^NLA.*t$|NumCows$|^NetValue$", colnames(NeA1R2))
  ,
  paste0("value.", grepout("^Br.*tValue$|^NLA.*t$|NumCows$|^NetValue$", colnames(NeA1R2)))
  )
na1L <- reshape(na1, direction = "long", idvar = c("Arm", "hhid", "tee"), 
  varying = grepout("value", colnames(na1))
  )
na1L <- na1L[!is.na(value), ]
setnames(na1L, "time", "variables")
na1L[!grepl("Cows", variables) & !is.na(value) & value != 0, value := log(value)]
na1L[, Arm := factor(Arm, labels = ArmsC)]
na1L[, variables := factor(variables)] 
na1L[, variables := factor(variables, labels = 
  c("Net assets", "Net non-livestock assets", "Number of cattle"))]
na1M <- na1L[, .(MeanValue = mean(value, na.rm = T)), by = .(tee, Arm, variables)]
p <- ggplot(data = na1L[!(grepl("catt", variables) & value > 4), ]
  , aes(x = factor(tee), y = value, 
      colour = variables, group = variables)) + 
  geom_point(alpha = .6, size = .0125, position = position_jitter(width = .25, height = .15)) + 
  scale_colour_viridis_d()+
  facet_grid(variables ~ Arm, scales = "free_y") + 
  scale_y_continuous(name = "assets") +
  scale_x_discrete(name = "periods", breaks = 1:4) +
  theme(
   axis.text.x = element_text(size = 6, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 8), 
   axis.title = element_text(size = 8), 
   strip.text.x = element_text(color = "blue", size = 8, 
     margin = margin(0, 1.25, 0, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 8, 
     margin = margin(1.5, 0, 1.5, 0, "cm")),
   panel.spacing.x = unit(.1, units = "cm"),
   panel.spacing.y = unit(.1, units = "cm"),
   legend.position="none") + 
  xlab("periods") + 
  labs(color  = "variables") +
  guides(colour = guide_legend(title = "variables", nrow = 1)) +
  geom_hline(aes(yintercept = 0), data = na1L[!grepl("net", variables), ], colour = "lightgreen")+
  geom_point(data = na1M, alpha = .6, shape = 0, stroke = .75, size = 1.25, color = "red", 
    aes(x = factor(tee), y = MeanValue))
ggsave(
  paste0(pathprogram, "figure/EstimationMemo/AssetsByPeriod.png"),
  p,
  width = 14, height = 10, units = "cm",
  dpi = 600
 )
pdf(
  paste0(pathprogram, "figure/EstimationMemo/AssetsByPeriod.pdf"),
  , width = 2*12/2.54, height = 2*8/2.54)
print(p)
whatever <- dev.off()
<<figure absolute changes in assets of non800, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 10>>=
# not impacts as it does not take difference with trad, just averages
library(ggplot2)
NeA1R2 <- readRDS(paste0(pathsaveHere, "NetAssetsANCOVA.rds"))
na1 <- NeA1R2[o800 == 1L & !is.na(tee), 
 c("Arm", "hhid", "tee", 
    grepout("^Br.*tValue$|^NLA.*t$|NumCows$|^NetValue$", colnames(NeA1R2))), 
    with = F]
## modify monthly count
setnames(na1, 
  grepout("^Br.*tValue$|^NLA.*t$|NumCows$|^NetValue$", colnames(NeA1R2))
  ,
  paste0("value.", grepout("^Br.*tValue$|^NLA.*t$|NumCows$|^NetValue$", colnames(NeA1R2)))
  )
na1L <- reshape(na1, direction = "long", idvar = c("Arm", "hhid", "tee"), 
  varying = grepout("value", colnames(na1))
  )
na1L <- na1L[!is.na(value), ]
setnames(na1L, "time", "variables")
na1L[!grepl("Cows", variables) & !is.na(value) & value != 0, value := log(value)]
na1L[, Arm := factor(Arm, labels = ArmsC)]
na1L[, variables := factor(variables)] 
na1L[, variables := factor(variables, labels = 
  c("Broad net assets", "Net assets", "Net non livestock assets", "Number of cattle"))]
na1M <- na1L[, .(MeanValue = mean(value, na.rm = T)), by = .(tee, Arm, variables)]
p <- ggplot(data = na1L[!(grepl("catt", variables) & value > 4), ]
  , aes(x = factor(tee), y = value, 
      colour = variables, group = variables)) + 
  geom_point(alpha = .6, size = .0125, position = position_jitter(width = .25, height = .15)) + 
  scale_colour_viridis_d()+
  facet_grid(variables ~ Arm, scales = "free_y") + 
  scale_y_continuous(name = "assets") +
  scale_x_discrete(name = "periods", breaks = 1:4) +
  theme(
   axis.text.x = element_text(size = 5, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 6), 
   axis.title = element_text(size = 6), 
   strip.text.x = element_text(color = "blue", size = 5, 
     margin = margin(0, 1.25, 0, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 5, 
     margin = margin(1.5, 0, 1.5, 0, "cm")),
   panel.spacing.x = unit(.1, units = "cm"),
   panel.spacing.y = unit(.1, units = "cm"),
   legend.position="none") + 
  xlab("periods") + 
  labs(color  = "variables") +
  guides(colour = guide_legend(title = "variables", nrow = 1)) +
  geom_hline(aes(yintercept = 0), data = na1L, colour = "lightgreen")+
  geom_point(data = na1M, alpha = .6, shape = 0, stroke = .75, size = 1.25, color = "red", 
    aes(x = factor(tee), y = MeanValue))
ggsave(
  paste0(pathprogram, "figure/EstimationMemo/AssetsByPeriodNon800.png"),
  p,
  width = 14, height = 10, units = "cm",
  dpi = 600
 )
pdf(
  paste0(pathprogram, "figure/EstimationMemo/AssetsByPeriodNon800.pdf"),
  , width = 2*12/2.54, height = 2*8/2.54)
print(p)
whatever <- dev.off()
<<figure absolute changes in net assets, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 10, fig.cap = paste0("Gross impacts on asset holding", "\\\\ {\\footnotesize \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
# not impacts as it does not take difference with trad, just averages
library(ggplot2)
NeA1R2 <- readRDS(paste0(pathsaveHere, "NetAssetsANCOVA.rds"))
na1 <- NeA1R2[o800 == 1L & !is.na(tee), 
 c("Arm", "hhid", "tee", 
    grepout("^NetValue$", colnames(NeA1R2))), 
    with = F]
na1[, Arm := factor(Arm, labels = ArmsC)]
na1[, variables := "Net assets"]
na1M <- na1[, .(MeanValue = mean(NetValue, na.rm = T)), by = .(tee, Arm)]
p <- ggplot(data = na1
  , aes(x = factor(tee), y = NetValue)) + 
  geom_point(alpha = .6, size = .2, colour = "cornflowerblue",
    position = position_jitter(width = .25, height = .15)) + 
  facet_grid(. ~ Arm, scales = "free_y") + 
  scale_y_log10(lim = c(100, 200000), name = "assets") +
  scale_x_discrete(name = "periods", breaks = 1:4) +
  theme(
   axis.text.x = element_text(size = 5, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 6), 
   axis.title = element_text(size = 6), 
   strip.text.x = element_text(color = "blue", size = 8, 
     margin = margin(.1, 1.25, .1, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 5, 
     margin = margin(1.5, 0, 1.5, 0, "cm")),
   panel.spacing.x = unit(.1, units = "cm"),
   panel.spacing.y = unit(.1, units = "cm"),
   legend.position="none") + 
  xlab("periods") + 
  geom_hline(aes(yintercept = 0), data = na1, colour = "lightgreen")+
  geom_point(data = na1M, alpha = .6, shape = 0, stroke = .75, size = 1.25, color = "red", 
    aes(x = factor(tee), y = MeanValue))
ggsave(
  paste0(pathprogram, "figure/EstimationMemo/NetAssetsByPeriod.jpg"),
  p,
  width = 2*12, height = 2*4, units = "cm",
  dpi = 600
 )
pdf(
  paste0(pathprogram, "figure/EstimationMemo/NetAssetsByPeriod.pdf"),
  , width = 2*12/2.54, height = 2*4/2.54)
print(p)
whatever <- dev.off()
<<figure indiv absolute changes in net assets, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 10, fig.cap = paste0("Gross impacts on asset holding", "\\\\ {\\footnotesize \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
# not impacts as it does not take difference with trad, just averages
library(ggplot2)
NeA1R2 <- readRDS(paste0(pathsaveHere, "NetAssetsANCOVA.rds"))
na1 <- NeA1R2[o800 == 1L & !is.na(tee), 
 c("Arm", "hhid", "tee", 
    grepout("^NetValue$", colnames(NeA1R2))), 
    with = F]
na1[, Arm := factor(Arm, labels = ArmsC)]
na1[, variables := "Net assets"]
p <- ggplot(data = na1
  , aes(x = factor(tee), y = NetValue, group = hhid)) + 
  geom_point(alpha = .6, size = .2, colour = "cornflowerblue") + 
  geom_line(alpha = .6, size = .2, colour = "cornflowerblue")+
  facet_grid(. ~ Arm, scales = "free_y") + 
  scale_y_log10(name = "assets") +
  scale_x_discrete(name = "periods", breaks = 1:4) +
  theme(
   axis.text.x = element_text(size = 5, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 6), 
   axis.title = element_text(size = 6), 
   strip.text.x = element_text(color = "blue", size = 5, 
     margin = margin(0, 1.25, 0, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 5, 
     margin = margin(1.5, 0, 1.5, 0, "cm")),
   panel.spacing.x = unit(.1, units = "cm"),
   panel.spacing.y = unit(.1, units = "cm"),
   legend.position="none") + 
  xlab("periods") + 
  geom_hline(aes(yintercept = 0), data = na1, colour = "lightgreen")
ggsave(
  paste0(pathprogram, "figure/EstimationMemo/IndivdualNetAssetsByPeriod.png"),
  p,
  width = 2*12, height = 2*4, units = "cm",
  dpi = 600
 )
pdf(
  paste0(pathprogram, "figure/EstimationMemo/IndividualNetAssetsByPeriod.pdf"),
  , width = 2*12/2.54, height = 2*6/2.54)
print(p)
whatever <- dev.off()
@
<<figure Land NetAssets NLNetAssets NumCows relative to concurrent trad, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 10>>=
library(ggplot2)
confi <- qread(paste0(pathsaveHere, "EstimatesCI.qs"))
confi1 <- confi[grepl("^Lan|^NetAssets$|NetNL|ws$", FileName) & !grepl("Tr|Up", attributes), ]
confi1 <- confi1[!grepl("None|Adi|Own", FileName), ]
confi1 <- confi1[grepl("^periN", hv), ]
confi1 <- confi1[grepl("Ta?$", regtype), ]
confi1[grepl("^Large$", attributes), attributes := "Large/Upfront"]
cols <- c("FileName", "regressand", "attributes", "regtype")
confi1[, (cols) := droplevels(.SD), .SDcols = cols]
confi1[, attributes := factor(attributes, levels = 
  c("Large/Upfront", "LargeGrace", "Cattle", "WithGrace", "InKind"))]
table(confi1[,.(attributes, regressand)])
confi1[, num := factor(num-1)]
p <- ggplot(data = confi1
  , aes(x = factor(period), y = estimate, 
      colour = num, shape = num, group = num)) + 
  geom_pointrange(aes(
    ymin = lb, ymax = ub), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .5))
p <- p + facet_grid(regressand ~ attributes, scales = "free_y") + 
  scale_y_continuous(name = "impacts" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 2:4) +
  theme(
   axis.text.x = element_text(size = 5, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 6), 
   axis.title = element_text(size = 6), 
   strip.text.x = element_text(color = "blue", size = 9, 
     margin = margin(.1, 1.25, .1, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 9, 
     margin = margin(1.5, .1, 1.5, .1, "cm")),
   panel.spacing.x = unit(c(.1, .1, .3, .1), units = "cm"),
   panel.spacing.y = unit(.1, units = "cm"),
   legend.position="bottom") + 
  xlab("periods") + 
  labs(color  = "regression specifications", shape = "regression specifications") +
  guides(colour = guide_legend(title = "regression specifications", nrow = 1)) +
  geom_hline(aes(yintercept = 0), data = confi1, colour = "lightgreen")
ggsave(
  paste0(pathprogram, 
  "figure/EstimationMemo/NetAssetLandCattleEffects.jpg"),
  p,
  width = 13, height = 12, units = "cm",
  dpi = 300
 )
pdf(
  paste0(pathprogram, 
  "figure/EstimationMemo/NetAssetLandCattleEffects.pdf")
  , width = 2*12/2.54, height = 2*8/2.54)
print(p)
whatever <- dev.off()
<<figure NetAssets NLNetAssets NumCows relative to concurrent trad, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 10>>=
library(ggplot2)
confi <- qread(paste0(pathsaveHere, "EstimatesCI.qs"))
confi1 <- confi[
  grepl("^NetAssets$|NetNL|ws$", FileName) & 
  !grepl("None|Adi|Own", FileName) & 
  !grepl("Tr|Up", attributes) &
  grepl("^periN", hv) &
  grepl("Ta?$", regtype), ]
confi1[grepl("^Large$", attributes), attributes := "Large/Upfront"]
cols <- c("FileName", "regressand", "attributes", "regtype")
confi1[, (cols) := droplevels(.SD), .SDcols = cols]
confi1[, attributes := factor(attributes, levels = 
  c("Large/Upfront", "LargeGrace", "Cattle", "WithGrace", "InKind"))]
confi1[, regressand := factor(regressand, levels = 
  c("net assets", "net non livestock assets", "cattle"))]
confi1[, regressand := factor(regressand, labels = 
  c("Net assets (BDT)", "Net non-livestock assets (BDT)", "Cattle (counts)"))]
table(confi1[,.(attributes, regressand)])
confi1[, num := factor(num-1)]
p <- ggplot(data = confi1
  , aes(x = factor(period), y = estimate, 
      colour = num, shape = num, group = num)) + 
  geom_pointrange(aes(
    ymin = lb, ymax = ub), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .5))
p <- p + facet_grid(regressand ~ attributes, scales = "free_y") + 
  scale_y_continuous(name = "impacts" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 2:4) +
  theme(
   axis.text.x = element_text(size = 5, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 6), 
   axis.title = element_text(size = 6), 
   strip.text.x = element_text(color = "blue", size = 9, 
     margin = margin(.1, 1.25, .1, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 9, 
     margin = margin(1.5, .1, 1.5, .1, "cm")),
   panel.spacing.x = unit(c(.1, .1, .3, .1), units = "cm"),
   panel.spacing.y = unit(.1, units = "cm"),
   legend.position="bottom") + 
  xlab("periods") + 
  labs(color  = "regression specifications", shape = "regression specifications") +
  guides(colour = guide_legend(title = "regression specifications", nrow = 1)) +
  geom_hline(aes(yintercept = 0), data = confi1, colour = "lightgreen")
p <- p + ggh4x::facet_nested(regressand ~ AtType+attributes, scales = "free_y")
ggsave(
  paste0(pathprogram, 
  "figure/EstimationMemo/NetAssetsNLAssetsCattleEffects.jpg"),
  p,
  width = 13, height = 12, units = "cm",
  dpi = 300
 )
pdf(
  paste0(pathprogram, 
  "figure/EstimationMemo/NetAssetsNLAssetsCattleEffects.pdf")
  , width = 2*12/2.54, height = 2*8/2.54)
print(p)
whatever <- dev.off()
<<figure NetAssets relative to concurrent trad, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 10>>=
library(ggplot2)
confi <- qread(paste0(pathsaveHere, "EstimatesCI.qs"))
confi1 <- confi[
  grepl("^NetAssets$", FileName) & 
  !grepl("None|Adi|Own", FileName) & 
  !grepl("Tr|Up", attributes) &
  grepl("^periN", hv) &
  grepl("Ta?$", regtype), ]
confi1[grepl("^Large$", attributes), attributes := "Large/Upfront"]
cols <- c("FileName", "regressand", "attributes", "regtype")
confi1[, (cols) := droplevels(.SD), .SDcols = cols]
confi1[, attributes := factor(attributes, levels = 
  c("Large/Upfront", "LargeGrace", "Cattle", "WithGrace", "InKind"))]
confi1[, num := factor(num-1)]
p <- ggplot(data = confi1
  , aes(x = factor(period), y = estimate, 
      colour = num, shape = num, group = num)) + 
  geom_pointrange(aes(
    ymin = lb, ymax = ub), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .5))
p <- p + facet_grid( ~ attributes, scales = "free_y") + 
  scale_y_continuous(name = "impacts" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 2:4) +
  theme(
   axis.text.x = element_text(size = 5, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 6), 
   axis.title = element_text(size = 6), 
   strip.text.x = element_text(color = "blue", size = 9, 
     margin = margin(.1, 1.25, .1, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 9, 
     margin = margin(1.5, .1, 1.5, .1, "cm")),
   panel.spacing.x = unit(c(.1, .1, .3, .1), units = "cm"),
   panel.spacing.y = unit(.1, units = "cm"),
   legend.position="bottom") + 
  xlab("periods") + 
  labs(color  = "regression specifications", shape = "regression specifications") +
  guides(colour = guide_legend(title = "regression specifications", nrow = 1)) +
  geom_hline(aes(yintercept = 0), data = confi1, colour = "lightgreen")
p <- p + ggh4x::facet_nested( ~ AtType+attributes, scales = "free_y")
ggsave(
  paste0(pathprogram, 
  "figure/EstimationMemo/NetAssetsEffects.jpg"),
  p,
  width = 13*2, height = 6*2, units = "cm",
  dpi = 600
 )
pdf(
  paste0(pathprogram, 
  "figure/EstimationMemo/NetAssetsEffects.pdf")
  , width = 2*12/2.54, height = 2*5/2.54)
print(p)
whatever <- dev.off()
<<figure NetAssets by experience relative to concurrent trad, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 8, fig.lp = 'Figure '>>=
library(ggplot2)
confi <- qread(paste0(pathsaveHere, "EstimatesCI.qs"))
cie1 <- confi[
  grepl("^NetA.*ts", FileName) & grepl("^non.*-.*\\,", ImpactType) & 
  grepl("Adi|None|Own", regressand) & 
  grepl("^T$", regtype), ]
cols <- c("FileName", "regressand", "attributes", "ImpactType")
cie1[, (cols) := droplevels(.SD), .SDcols = cols]
cie1[, SubGroup := factor(gsub(".*ts\\, ", "", regressand))]
cie1[, SubGroup := factor(SubGroup, levels = c("Own", "Adi", "None"))]
cie1[, SubGroup := factor(SubGroup, labels = c("Owner", "Adi", "None"))]
cie1[, num := factor(num-1)]
cie1[, num := gsub("^", "Spec ", num)]
p <- ggplot(data = cie1
  , aes(x = factor(period), y = estimate, 
      colour = SubGroup, shape = SubGroup, group = SubGroup), size = .1) + 
  geom_pointrange(aes(
    ymin = lb, ymax = ub), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .5))
p <- p + facet_grid(num ~ attributes) + 
  scale_y_continuous(name = "impacts" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 2:4) +
  theme(
   axis.text.x = element_text(size = 7, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 8), 
   axis.title = element_text(size = 8), 
   strip.text.x = element_text(color = "blue", size = 9, 
     margin = margin(.1, 1.25, .1, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 9, 
     margin = margin(1.5, .1, 1.5, .1, "cm")),
   #panel.spacing.x = unit(c(.1, .1, .3, .1), units = "cm"),
   #panel.spacing.y = unit(.1, units = "cm"),
   legend.text = element_text(size = 7),
   legend.title = element_text(size = 7),
   legend.key = element_rect(fill = "white"),
   legend.key.size = unit(.25, "cm"),
   legend.position="bottom") + 
  xlab("periods") + 
  labs(color  = "Group by experience", shape = "Group by experience") +
  guides(
    colour = guide_legend(title = "Group by experience", nrow = 1),
    shape = guide_legend(override.aes = list(size = .125))) +
  geom_hline(aes(yintercept = 0), data = cie1, colour = "lightgreen")
ggsave(
  paste0(pathprogram, 
  "figure/EstimationMemo/NetAssetsByExperienceEffects.jpg")
  , p,
  width = 12*2, height = 6*2, units = "cm",
  dpi = 300*4
 )
pdf(
  paste0(pathprogram, 
  "figure/EstimationMemo/NetAssetsByExperienceEffects.pdf")
  , width = 2*12/2.54, height = 2*6/2.54)
print(p)
whatever <- dev.off()
<<figure NetAssets by experience func att relative to concurrent trad, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 8, fig.lp = 'Figure '>>=
library(ggplot2)
confi <- qread(paste0(pathsaveHere, "EstimatesCI.qs"))
cie1 <- confi[
  grepl("^NetA.*ts", FileName) & grepl("^non.*-.*\\,", ImpactType) & 
  grepl("Adi|None|Own", regressand) & 
  grepl("^Ta$", regtype), ]
cols <- c("FileName", "regressand", "attributes", "ImpactType")
cie1[, (cols) := droplevels(.SD), .SDcols = cols]
cie1[, SubGroup := factor(gsub(".*ts\\, ", "", regressand))]
cie1[, SubGroup := factor(SubGroup, levels = c("Own", "Adi", "None"))]
cie1[, SubGroup := factor(SubGroup, labels = c("Owner", "Adi", "None"))]
cie1[, num := factor(num-1)]
p <- ggplot(data = cie1
  , aes(x = factor(period), y = estimate, 
      colour = SubGroup, shape = SubGroup, group = SubGroup), size = .1) + 
  geom_pointrange(aes(
    ymin = lb, ymax = ub), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .5))
p <- p + facet_grid(num ~ attributes) + 
  scale_y_continuous(name = "impacts" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 2:4) +
  theme(
   axis.text.x = element_text(size = 7, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 8), 
   axis.title = element_text(size = 8), 
   strip.text.x = element_text(color = "blue", size = 9, 
     margin = margin(.1, 1.25, .1, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 9, 
     margin = margin(1.5, .1, 1.5, .1, "cm")),
   #panel.spacing.x = unit(c(.1, .1, .3, .1), units = "cm"),
   #panel.spacing.y = unit(.1, units = "cm"),
   legend.text = element_text(size = 7),
   legend.title = element_text(size = 7),
   legend.key = element_rect(fill = "white"),
   legend.key.size = unit(.25, "cm"),
   legend.position="bottom") + 
  xlab("periods") + 
  labs(color  = "Group by experience", shape = "Group by experience") +
  guides(
    colour = guide_legend(title = "Group by experience", nrow = 1),
    shape = guide_legend(override.aes = list(size = .125))) +
  geom_hline(aes(yintercept = 0), data = cie1, colour = "lightgreen")
ggsave(
  paste0(pathprogram, 
  "figure/EstimationMemo/NetAssetsByExperienceEffectsFunAttribute.jpg")
  , p,
  width = 12, height = 8, units = "cm",
  dpi = 300*4
 )
pdf(
  paste0(pathprogram, 
  "figure/EstimationMemo/NetAssetsByExperienceEffectsFunAttribute.pdf")
  , width = 2*12/2.54, height = 2*8/2.54)
print(p)
whatever <- dev.off()
<<figure NumCows by experience relative to concurrent trad, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 8, fig.lp = 'Figure '>>=
library(ggplot2)
confi <- qread(paste0(pathsaveHere, "EstimatesCI.qs"))
confie1 <- confi[
  grepl("^Num", FileName) & 
  !grepl("Exp", FileName) & 
  grepl("^periN", hv) & 
  grepl("^T$", regtype) & 
  !grepl("Trad", attributes), ]
cols <- c("FileName", "regressand", "attributes")
confie1[, (cols) := droplevels(.SD), .SDcols = cols]
confie1[, SubGroup := factor(gsub(".*tle\\, ", "", regressand))]
confie1[, SubGroup := factor(SubGroup, levels = c("cattle", "Own", "Adi", "None"))]
confie1[, SubGroup := factor(SubGroup, labels = c("All members", "Owner", "Adi", "None"))]
addmargins(table(confie1[, .(SubGroup, num)]))
# Comparable: 
#  NumCows (All) 1 = 1 in all others (not included in confi)
#  NumCows (All) 2 = 2 in Own, 
#  NumCows (All) 3 = 3 in Own, 3 in Adi, None (OLS, so not strictly comparable)
#  NumCows (All) 4: does not exist in Own, Adi, None 
confie2 <- confie1[grepl("1", num), ]
p <- ggplot(data = confie2
  , aes(x = factor(period), y = estimate, 
      colour = SubGroup, shape = SubGroup, group = SubGroup), size = .1) + 
  geom_pointrange(aes(
    ymin = lb, ymax = ub), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .5))
p <- p + facet_grid( ~ attributes) + 
  scale_y_continuous(name = "impacts" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 2:4) +
  theme(
   axis.text.x = element_text(size = 7, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 8), 
   axis.title = element_text(size = 8), 
   strip.text.x = element_text(color = "blue", size = 9, 
     margin = margin(.1, 1.25, .1, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 9, 
     margin = margin(1.5, .1, 1.5, .1, "cm")),
   #panel.spacing.x = unit(c(.1, .1, .3, .1), units = "cm"),
   #panel.spacing.y = unit(.1, units = "cm"),
   legend.text = element_text(size = 7),
   legend.title = element_text(size = 7),
   legend.key = element_rect(fill = "white"),
   legend.key.size = unit(.25, "cm"),
   legend.position="bottom") + 
  xlab("periods") + 
  labs(color  = "Group by experience", shape = "Group by experience") +
  guides(
    colour = guide_legend(title = "Group by experience", nrow = 1),
    shape = guide_legend(override.aes = list(size = .125))) +
  geom_hline(aes(yintercept = 0), data = confie2, colour = "lightgreen")
ggsave(
  paste0(pathprogram, 
  "figure/EstimationMemo/NumCowsByExperienceEffects.jpg")
  , p,
  width = 12*2, height = 4*2, units = "cm",
  dpi = 300
 )
pdf(
  paste0(pathprogram, 
  "figure/EstimationMemo/NumCowsByExperienceEffects.pdf")
  , width = 2*12/2.54, height = 2*4/2.54)
print(p)
whatever <- dev.off()
<<figure BroadNet etc, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 10>>=
library(ggplot2)
confi <- qread(paste0(pathsaveHere, "EstimatesCI.qs"))
confi1 <- confi[
  grepl("Annual|^NetB|NetNL|ws$", FileName) & 
  !grepl("None|Adi|Own", FileName) & 
  !grepl("Tr|Up", attributes) &
  grepl("^periN", hv) &
  grepl("T$", regtype) & num > 1, ]
confi1[grepl("^Large$", attributes), attributes := "Large"]
cols <- c("FileName", "regressand", "attributes", "regtype")
confi1[, (cols) := droplevels(.SD), .SDcols = cols]
confi1[, regressand := factor(regressand, levels = 
  c("net assets, AP", "net non-livestock assets", "net broad assets", "cattle"))]
confi1[, regressand := factor(regressand, labels = 
  c("Net assets,\nannual price (BDT)", "Net non-livestock\n assets (BDT)", 
  "Net broad assets\n (BDT)", "Cattle (counts)"))]
table(confi1[,.(attributes, regressand)])
confi1[, num := factor(num-1)]
p <- ggplot(data = confi1
  , aes(x = factor(period), y = estimate, 
      colour = num, shape = num, group = num)) + 
  geom_pointrange(aes(
    ymin = lb, ymax = ub), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .5))
p <- p + facet_grid(regressand ~ attributes, scales = "free_y") + 
  scale_y_continuous(name = "impacts" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 2:4) +
  theme(
   axis.text.x = element_text(size = 7, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 8), 
   axis.title = element_text(size = 8), 
   strip.text.x = element_text(color = "blue", size = 9, 
     margin = margin(.1, 1.25, .1, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 9, 
     margin = margin(1.5, .1, 1.5, .1, "cm")),
   #panel.spacing.x = unit(c(.1, .1, .3, .1), units = "cm"),
   #panel.spacing.y = unit(.1, units = "cm"),
   legend.position="bottom") + 
  xlab("periods") + 
  labs(color  = "regression specifications", shape = "regression specifications") +
  guides(colour = guide_legend(title = "regression specifications", nrow = 1)) +
  geom_hline(aes(yintercept = 0), data = confi1, colour = "lightgreen")
ggsave(
  paste0(pathprogram, 
  "figure/EstimationMemo/NetAssetsNetBroadAssetsNLAssetsCattleEffects.jpg"),
  p,
  width = 13*1.5, height = 12*1.5, units = "cm",
  dpi = 300
 )
spdf(
  paste0(pathprogram, 
  "figure/EstimationMemo/NetAssetsNetBroadAssetsNLAssetsCattleEffects.pdf")
  , width = 2*12/2.54, height = 2*8/2.54)
print(p)
whatever <- dev.off()
<<figure poverty NetAssets NLNetAssets NumCows, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 10>>=
library(ggplot2)
confi <- qread(paste0(pathsaveHere, "EstimatesCI.qs"))
confi1 <- confi[
  grepl("^NetAssets$|NetNL|Cows", FileName) & 
  !grepl("None|Adi|Own|Expe", FileName) & 
  !grepl("Tr|Up", attributes) & grepl("^matPN", hv) &
  grepl("TP$", regtype), ]
confi1[grepl("^Large$", attributes), attributes := "Large/Upfront"]
cols <- c("FileName", "regressand", "attributes", "regtype", "hv", "ImpactType", "AtType")
confi1[, (cols) := droplevels(.SD), .SDcols = cols]
confi1[, attributes := factor(attributes, 
  levels = c("Large/Upfront", "LargeGrace", "Cattle"))]
confi1[, attributes := factor(attributes, 
  labels = c("Large", "LargeGrace", "Cattle"))]
confi1[, regressand := factor(regressand, labels = 
  c("Net assets (BDT)", "Net non-livestock assets\n(BDT)", "Cattle (counts)"
  ))]
table(confi1[,.(attributes, regressand)])
confi1[, num := factor(num-1)]
p <- ggplot(data = confi1
  , aes(x = factor(period), y = estimate, 
      colour = num, shape = num, group = num)) + 
  geom_pointrange(aes(
    ymin = lb, ymax = ub), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .5))
p <- p + facet_grid(regressand ~ attributes, scales = "free_y") + 
  scale_y_continuous(name = "impacts" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 2:4) +
  theme(
   axis.text.x = element_text(size = 5, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 6), 
   axis.title = element_text(size = 6), 
   strip.text.x = element_text(color = "blue", size = 9, 
     margin = margin(.1, 1.25, .1, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 9, 
     margin = margin(1.5, .1, 1.5, .1, "cm")),
   #panel.spacing.x = unit(c(.1, .1, .3, .1), units = "cm"),
   #panel.spacing.y = unit(.1, units = "cm"),
   legend.position="bottom") + 
  xlab("periods") + 
  labs(color  = "regression specifications", shape = "regression specifications") +
  guides(colour = guide_legend(title = "regression specifications", nrow = 1)) +
  geom_hline(aes(yintercept = 0), data = confi1, colour = "lightgreen")
#p <- p + ggh4x::facet_nested(regressand ~ AtType+attributes, scales = "free_y")
ggsave(
  paste0(pathprogram, 
  "figure/EstimationMemo/NetAssetsNLAssetsCattleUltraPoorEffects.jpg"),
  p,
  width = 13, height = 12, units = "cm",
  dpi = 300
 )
pdf(
  paste0(pathprogram, 
  "figure/EstimationMemo/NetAssetsNLAssetsCattleUltraPoorEffects.pdf")
  , width = 2*12/2.54, height = 2*8/2.54)
print(p)
whatever <- dev.off()
<<figure income consumption, warning = F, message = F, fig.align='center', fig.height = 8, fig.width = 10, fig.cap = paste0("Effects on labour incomes and consumption", "\\\\ {\\footnotesize \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
library(ggplot2)
confi <- qread(paste0(pathsaveHere, "EstimatesCI.qs"))
confi2 <- confi[
  (grepl("Lab", FileName) |(grepl("OLS", FileName) & num <= 3)) &
  #grepl("^Ta?$", regtype) & For Arm, Fun Attribute panels
  grepl("^T$", regtype) & 
  # traditional gross level, nontrad cumulative relative to trad gross
  ((grepl("Tra", attributes) & grepl("lev.* trad.*d$", ImpactType)) |
    (!grepl("Tra", attributes) & grepl("sum", ImpactType))), ]
confi2[grepl("^Large$", attributes), attributes := "Large/Upfront"]
confi2[grepl("Fun", AtType), 
  AtType := "Functional attributes\n (relative to Upfront, Upfront+WithGrace)"]
confi2 <- confi2[!grepl("^Up", attributes), ]
confi2[, attributes := factor(attributes, levels = 
  c("Traditional", "Large/Upfront", "LargeGrace", "Cattle",
    "WithGrace", "InKind"))]
confi3 <- confi2[!grepl("Tra", attributes), ]
cols <- c("FileName", "regressand", "attributes", "hv", "ImpactType", "AtType")
confi3[, (cols) := droplevels(.SD), .SDcols = cols]
confi3[grepl("lab", regressand), num := num-1]
confi3[, num := factor(num)]
#confi2[grepl("Lab", FileName), estimate := estimate*100]
#confi2[grepl("Lab", FileName), ub := ub*100]
#confi2[grepl("Lab", FileName), lb := lb*100]
p <- ggplot(data = confi3
  , aes(x = factor(period), y = estimate, 
      colour = num, shape = num, group = num)) + 
  geom_pointrange(aes(
    ymin = lb, ymax = ub), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .5))
p <- p + facet_grid(regressand ~ attributes, scales = "free_y",
   labeller = label_wrap_gen(multi_line = TRUE)) + 
  scale_y_continuous(name = "impacts" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 2:4) +
  theme(
   axis.text.x = element_text(size = 5, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 6), 
   axis.title = element_text(size = 6), 
   strip.text.x = element_text(color = "blue", size = 9, 
     margin = margin(.1, 1.25, .1, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 9, 
     margin = margin(1.5, .1, 1.5, .1, "cm")),
   #panel.spacing.x = unit(c(.1, .1, .3, .1), units = "cm"), For Arm, Fun Attribute panels
   panel.spacing.x = unit(c(.1, .1), units = "cm"),
   panel.spacing.y = unit(.1, units = "cm"),
   legend.position="bottom") + 
  xlab("periods") + 
  labs(color  = "regression specifications", shape = "regression specifications") +
  guides(colour = guide_legend(title = "regression specifications", nrow = 1)) +
  geom_hline(aes(yintercept = 0), data = confi3, colour = "lightgreen")
#p <- p + ggh4x::facet_nested(regressand ~ AtType+attributes, scales = "free_y")
ggsave(
  paste0(pathprogram, 
  "figure/EstimationMemo/IncomeConsumptionEffects.jpg"),
  p,
  width = 13*2, height = 8*2, units = "cm",
  dpi = 300*4
 )
pdf(
  paste0(pathprogram, 
  "figure/EstimationMemo/IncomeConsumptionEffects.pdf"),
  , width = 13*2/2.54, height = 8*2/2.54)
print(p)
whatever <- dev.off()
<<figure poverty consumption, warning = F, message = F, fig.align='center', fig.height = 8, fig.width = 10, fig.cap = paste0("Effects on labour incomes and consumption", "\\\\ {\\footnotesize \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
library(ggplot2)
confi <- qread(paste0(pathsaveHere, "EstimatesCI.qs"))
confi2 <- confi[
  (grepl("Lab", FileName) |(grepl("OLS", FileName) & num <= 3)) &
  grepl("^TP$", regtype) & grepl("sum.*poor non", ImpactType), ]
confi2[grepl("on", regressand), regressand := "Per capita consumption\n(BDT)"]
confi2[!grepl("on", regressand), regressand := "Labour income\n(BDT)"]
cols <- c("FileName", "regressand", "attributes", "hv", "ImpactType", "AtType")
confi2[, (cols) := droplevels(.SD), .SDcols = cols]
confi2[grepl("lab", regressand), num := num-1]
confi2[, num := factor(num)]
p <- ggplot(data = confi2
  , aes(x = factor(period), y = estimate, 
      colour = num, shape = num, group = num)) + 
  geom_pointrange(aes(
    ymin = lb, ymax = ub), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .5))
p <- p + facet_grid(regressand ~ attributes, scales = "free_y",
   labeller = label_wrap_gen(multi_line = TRUE)) + 
  scale_y_continuous(name = "impacts" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 2:4) +
  theme(
   axis.text.x = element_text(size = 5, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 6), 
   axis.title = element_text(size = 6), 
   strip.text.x = element_text(color = "blue", size = 9, 
     margin = margin(.1, 1.25, .1, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 9, 
     margin = margin(1.5, .1, 1.5, .1, "cm")),
   #panel.spacing.x = unit(c(.1, .1, .3, .1), units = "cm"), For Arm, Fun Attribute panels
   panel.spacing.x = unit(c(.1, .1), units = "cm"),
   panel.spacing.y = unit(.1, units = "cm"),
   legend.position="bottom") + 
  xlab("periods") + 
  labs(color  = "regression specifications", shape = "regression specifications") +
  guides(colour = guide_legend(title = "regression specifications", nrow = 1)) +
  geom_hline(aes(yintercept = 0), data = confi2, colour = "lightgreen")
#p <- p + ggh4x::facet_nested(regressand ~ AtType+attributes, scales = "free_y")
ggsave(
  paste0(pathprogram, 
  "figure/EstimationMemo/IncomeConsumptionPovertyEffects.jpg"),
  p,
  width = 13*2, height = 6*2, units = "cm",
  dpi = 300
 )
pdf(
  paste0(pathprogram, 
  "figure/EstimationMemo/IncomeConsumptionPovertyEffects.pdf"),
  , width = 13*2/2.54, height = 6*2/2.54)
print(p)
whatever <- dev.off()
<<figure sch arms, eval = T, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 14, fig.cap = paste0("Effects on schooling by arms", "\\\\ {\\footnotesize \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
library(ggplot2)
confis <- qread(paste0(pathsaveHere, "EstimatesCISchooling.qs"))
confi2 <- unique(confis)
confi2 <- confi2[!grepl("^Up", attributes), ]
confi2 <- confi2[grepl("^Large$", attributes), attributes := "Large/Upfront"]
confi2 <- confi2[grepl("T$", regtype), ]
cols <- c("FileName", "school", "attributes")
confi2[, (cols) := droplevels(.SD), .SDcols = cols]
confi2[, attributes := factor(attributes, levels = 
  c("Traditional", "Large/Upfront", "LargeGrace", "Cattle"))]
confi2[, attributes := factor(attributes, labels = 
  c("Traditional", "Large", "LargeGrace", "Cattle"))]
# Trad: Level in each period at school i
confi2t <- confi2[(grepl("^Tra", attributes) & grepl("lev.* trad.*ea", ImpactType)) & num >= 5, ]
# Nontrad: nontrad - trad, in each period, at school i
confi2n <- confi2[grepl("^.ofNinT$", hv) & num >= 5, ][order(gender, period), ]
confi3 <- rbind(confi2t, confi2n)
confi3[, num := factor(num-4)]
faccol <- c("attributes", "gender", "ImpactType", "hv", "regtype", "num")
confi3[, (faccol) := lapply(.SD, droplevels), .SDcol = faccol]
table(confi3[,.(ImpactType, attributes)])
confi3[, numgen := paste0(gender, ", spec", num)]
confi3[, effects := "Level estimates"]
confi3[!grepl("Trad", attributes), effects := "Marginal impacts relative to Traditional"]
p <- ggplot(data = confi3
  , aes(x = factor(period), y = estimate, 
      colour = numgen, shape = numgen, group = numgen)) + 
  geom_pointrange(aes(
    ymin = lb, ymax = ub), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .25))
p <- p + facet_grid(school ~ attributes, scales = "free_y") + 
  scale_y_continuous(name = "impacts" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 2:4) +
  theme(
   axis.text.x = element_text(size = 7, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 7), 
   axis.title = element_text(size = 7), 
   strip.text.x = element_text(color = "blue", size = 9, 
     margin = margin(.1, 1.25, .1, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 9, 
     margin = margin(1.5, .1, 1.5, .1, "cm")),
   panel.spacing.x = unit(c(.3, .1, .1), units = "cm"),
   panel.spacing.y = unit(.1, units = "cm"),
   legend.position="bottom",
   legend.key.size = unit(0.1, "cm"),
   legend.text = element_text(size = 7)) + 
  xlab("periods") + 
  labs(color  = "gender, regression specifications", shape = "gender, regression specifications") +
  guides(colour = guide_legend(title = "gender, regression specifications", nrow = 1)) +
  geom_hline(aes(yintercept = 0), data = confi3, colour = "lightgreen")
p <- p + ggh4x::facet_nested(school ~ effects + attributes, scales = "free_y")
ggsave(
  paste0(pathprogram, 
  "figure/EstimationMemo/SchoolingEffectsWithTradByArm.jpg"),
  p,
  width = 14*2, height = 12*2, units = "cm",
  dpi = 450
 )
pdf(
  paste0(pathprogram, 
  "figure/EstimationMemo/SchoolingEffectsWithTradByArm.pdf"),
  , width = 12*2/2.54, height = 12*2/2.54)
print(p)
whatever <- dev.off()
<<figure sch func attributes, eval = T, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 14, fig.cap = paste0("Effects on schooling by functional attributes", "\\\\ {\\footnotesize \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
library(ggplot2)
confis <- qread(paste0(pathsaveHere, "EstimatesCISchooling.qs"))
confi2 <- unique(confis)
confi2 <- confi2[grepl("^Large$", attributes), attributes := "Large/Upfront"]
confi2 <- confi2[grepl("Ta$", regtype), ]
cols <- c("FileName", "school", "attributes")
confi2[, (cols) := droplevels(.SD), .SDcols = cols]
confi2[, attributes := factor(attributes, levels = 
  c("Traditional", "Upfront", "WithGrace", "InKind"))]
# Trad: Level in each period at school i
confi2t <- confi2[(grepl("^Tra", attributes) & grepl("lev.* trad.*ea", ImpactType)) & num >= 5, ]
# Nontrad: nontrad - trad, in each period, at school i
confi2n <- confi2[grepl("^.ofNinT$", hv) & num >= 5, ][order(gender, period), ]
confi3 <- rbind(confi2t, confi2n)
confi3[, num := factor(num-4)]
faccol <- c("attributes", "gender", "ImpactType", "hv", "regtype", "num")
confi3[, (faccol) := lapply(.SD, droplevels), .SDcol = faccol]
table(confi3[,.(ImpactType, attributes)])
confi3[, numgen := paste0(gender, ", spec", num)]
confi3[, effects := "Level estimates"]
confi3[!grepl("Trad", attributes), effects := "Marginal impacts relative to \nTraditional, Upfront, Upfront+WithGrace"]
p <- ggplot(data = confi3
  , aes(x = factor(period), y = estimate, 
      colour = numgen, shape = numgen, group = numgen)) + 
  geom_pointrange(aes(
    ymin = lb, ymax = ub), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .25))
p <- p + facet_grid(school * gender ~ attributes, scales = "free_y") + 
  scale_y_continuous(name = "impacts" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 2:4) +
  theme(
   axis.text.x = element_text(size = 7, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 7), 
   axis.title = element_text(size = 7), 
   strip.text.x = element_text(color = "blue", size = 9, 
     margin = margin(.1, 1.25, .1, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 9, 
     margin = margin(1.5, .1, 1.5, .1, "cm")),
   panel.spacing.x = unit(c(.3, .1, .1), units = "cm"),
   panel.spacing.y = unit(.1, units = "cm"),
   legend.position="bottom",
   legend.key.size = unit(0.1, "cm"),
   legend.text = element_text(size = 7)) + 
  xlab("periods") + 
  labs(color  = "regression specifications", shape = "regression specifications") +
  guides(colour = guide_legend(title = "regression specifications", nrow = 1)) +
  geom_hline(aes(yintercept = 0), data = confi3, colour = "lightgreen")
p <- p + ggh4x::facet_nested(school ~ effects + attributes, scales = "free_y")
ggsave(
  paste0(pathprogram, "figure/EstimationMemo/SchoolingEffectsWithTradByFunAttribute.jpg"),
  p,
  width = 14*2, height = 12*2, units = "cm",
  dpi = 450
 )
pdf(
  paste0(pathprogram, 
  "figure/EstimationMemo/SchoolingEffectsWithTradByFunAttribute.pdf"),
  , width = 12*2/2.54, height = 12*2/2.54)
print(p)
whatever <- dev.off()
@
<<figure sch arms concurrent, eval = T, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 14, fig.cap = paste0("Effects on schooling by arms per period", "\\\\ {\\footnotesize \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
library(ggplot2)
confis <- qread(paste0(pathsaveHere, "EstimatesCISchooling.qs"))
confi2 <- unique(confis)
confi2 <- confi2[!grepl("^Up", attributes), ]
confi2 <- confi2[grepl("^Large$", attributes), attributes := "Large/Upfront"]
confi2 <- confi2[grepl("T$", regtype), ]
cols <- c("FileName", "school", "attributes")
confi2[, (cols) := droplevels(.SD), .SDcols = cols]
confi2[, attributes := factor(attributes, levels = 
  c("Traditional", "Large/Upfront", "LargeGrace", "Cattle"))]
confi2[, attributes := factor(attributes, labels = 
  c("Traditional", "Large", "LargeGrace", "Cattle"))]
# Trad: Level in each period at school i
confi2t <- confi2[(grepl("^Tra", attributes) & grepl("lev.* trad.*ea", ImpactType)) & num >= 5, ]
# Nontrad: nontrad - trad, in each period, at school i
confi2n <- confi2[grepl("change", ImpactType) & num >= 5, ][order(gender, period), ]
confi3 <- rbind(confi2t, confi2n)
confi3[, num := factor(num-4)]
faccol <- c("attributes", "gender", "ImpactType", "hv", "regtype", "num")
confi3[, (faccol) := lapply(.SD, droplevels), .SDcol = faccol]
table(confi3[,.(ImpactType, attributes)])
confi3[, numgen := paste0(gender, ", spec", num)]
confi3[, effects := "Level estimates"]
confi3[!grepl("Trad", attributes), effects := "Marginal impacts relative to Traditional"]
confi3[, numgen := paste0(gender, ", spec", num)]
confi3[, effects := "Level estimates"]
confi3[!grepl("Trad", attributes), effects := "Marginal impacts relative to Traditional"]
p <- ggplot(data = confi3
  , aes(x = factor(period), y = estimate, 
      colour = numgen, shape = numgen, group = numgen)) + 
  geom_pointrange(aes(
    ymin = lb, ymax = ub), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .25))
p <- p + facet_grid(school ~ attributes, scales = "free_y") + 
  scale_y_continuous(name = "impacts" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 2:4) +
  theme(
   axis.text.x = element_text(size = 7, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 7), 
   axis.title = element_text(size = 7), 
   strip.text.x = element_text(color = "blue", size = 9, 
     margin = margin(.1, 1.25, .1, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 9, 
     margin = margin(1.5, .1, 1.5, .1, "cm")),
   panel.spacing.x = unit(c(.3, .1, .1), units = "cm"),
   panel.spacing.y = unit(.1, units = "cm"),
   legend.position="bottom",
   legend.key.size = unit(0.1, "cm"),
   legend.text = element_text(size = 7)) + 
  xlab("periods") + 
  labs(color  = "gender, regression specifications", shape = "gender, regression specifications") +
  guides(colour = guide_legend(title = "gender, regression specifications", nrow = 1)) +
  geom_hline(aes(yintercept = 0), data = confi3, colour = "lightgreen")
p <- p + ggh4x::facet_nested(school ~ effects + attributes, scales = "free_y")
ggsave(
  paste0(pathprogram, 
  "figure/EstimationMemo/SchoolingEffectsConcurrentWithTradByArm.jpg"),
  p,
  width = 14*2, height = 12*2, units = "cm",
  dpi = 450
 )
pdf(
  paste0(pathprogram, 
  "figure/EstimationMemo/SchoolingEffectsConcurrentWithTradByArm.pdf"),
  , width = 12*2/2.54, height = 12*2/2.54)
print(p)
whatever <- dev.off()
<<figure sch func attributes concurrent, eval = T, warning = F, message = F, fig.align='center', fig.height = 12, fig.width = 14, fig.cap = paste0("Effects on schooling by functional attributes per period", "\\\\ {\\footnotesize \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
library(ggplot2)
confis <- qread(paste0(pathsaveHere, "EstimatesCISchooling.qs"))
confi2 <- unique(confis)
confi2 <- confi2[grepl("^Large$", attributes), attributes := "Large/Upfront"]
confi2 <- confi2[grepl("Ta$", regtype), ]
cols <- c("FileName", "school", "attributes")
confi2[, (cols) := droplevels(.SD), .SDcols = cols]
confi2[, attributes := factor(attributes, levels = 
  c("Traditional", "Upfront", "WithGrace", "InKind"))]
# Trad: Level in each period at school i
confi2t <- confi2[(grepl("^Tra", attributes) & grepl("lev.* trad.*ea", ImpactType)) & num >= 5, ]
# Nontrad: nontrad - trad, in each period, at school i
confi2n <- confi2[grepl("change", ImpactType) & num >= 5, ][order(gender, period), ]
confi3 <- rbind(confi2t, confi2n)
confi3[, num := factor(num-4)]
faccol <- c("attributes", "gender", "ImpactType", "hv", "regtype", "num")
confi3[, (faccol) := lapply(.SD, droplevels), .SDcol = faccol]
table(confi3[,.(ImpactType, attributes)])
confi3[, numgen := paste0(gender, ", spec", num)]
confi3[, effects := "Level estimates"]
confi3[!grepl("Trad", attributes), effects := "Marginal impacts relative to \nTraditional, Upfront, Upfront+WithGrace"]
confi3[, attributes := factor(attributes, label = c("Traditional", 
  "Upfront\nrelative to Traditional", "WithGrace\nrelative to Upfront", 
  "InKind\nrelative to Upfront+WithGrace"))]
p <- ggplot(data = confi3
  , aes(x = factor(period), y = estimate, 
      colour = numgen, shape = numgen, group = numgen)) + 
  geom_pointrange(aes(
    ymin = lb, ymax = ub), 
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .25))
p <- p + facet_grid(school * gender ~ attributes, scales = "free_y") + 
  scale_y_continuous(name = "impacts" #,limits = c(-.35, .15)
  ) +
  scale_x_discrete(name = "periods", breaks = 2:4) +
  theme(
   axis.text.x = element_text(size = 7, angle = 0, vjust = 1, hjust = 1), 
   axis.text.y = element_text(size = 7), 
   axis.title = element_text(size = 7), 
   strip.text.x = element_text(color = "blue", size = 8, 
     margin = margin(.1, 1.25, .1, 1.25, "cm")), 
   strip.text.y = element_text(color = "blue", size = 9, 
     margin = margin(1.5, .1, 1.5, .1, "cm")),
   panel.spacing.x = unit(c(.3, .1, .1), units = "cm"),
   panel.spacing.y = unit(.1, units = "cm"),
   legend.position="bottom",
   legend.key.size = unit(0.1, "cm"),
   legend.text = element_text(size = 7)) + 
  xlab("periods") + 
  labs(color  = "regression specifications", shape = "regression specifications") +
  guides(colour = guide_legend(title = "regression specifications", nrow = 1)) +
  geom_hline(aes(yintercept = 0), data = confi3, colour = "lightgreen")
p <- p + ggh4x::facet_nested(school ~ effects + attributes, scales = "free_y")
ggsave(
  paste0(pathprogram, 
  "figure/EstimationMemo/SchoolingEffectsConcurrentWithTradByFunAttribute.jpg"),
  p,
  width = 14*2, height = 12*2, units = "cm",
  dpi = 450
 )
pdf(
  paste0(pathprogram, 
  "figure/EstimationMemo/SchoolingEffectsConcurrentWithTradByFunAttribute.pdf"),
  , width = 12*2/2.54, height = 10*2/2.54)
print(p)
whatever <- dev.off()
@
<<>>=
NeAE2 <- readRDS(paste0(pathsaveHere, "NetAssetsExperienceANCOVA.rds"))
addmargins(table0(NeAE2[tee == 1 & o800 == 1L,.(AdiCattle, OwnCattle)]))
OwnCattleAtBaseline <- sum(NeAE2[tee == 1 & o800 == 1L, OwnCattle], na.rm = T)
AdiCattleAtBaseline <- sum(NeAE2[tee == 1 & o800 == 1L, AdiCattle], na.rm = T)
NoneCattleAtBaseline <- nrow(NeAE2[tee == 1 & o800 == 1L & OwnCattle == 0L & AdiCattle == 0L, ])
@

\newpage
\renewcommand{\arraystretch}{.6}
\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Assets by period\label{fig AssetCumRelativeToConcurrentTradEffects}}\\
\hfil\includegraphics[width = 14cm]{\Sexpr{    paste0(pathprogram, "figure/EstimationMemo/AssetsByPeriod.pdf")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Tabulated with survey data.\\
Note:&  Red squares are means of respective data. \Sexpr{FNAssetDefinitions} All net assets are in logarithms, number of cattle is in natural numbers. \\[1ex]
\end{tabular}
}

\newpage
\renewcommand{\arraystretch}{.6}
\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Assets by period among out of sample members\label{fig AssetCumRelativeToConcurrentTradEffectsNon800}}\\
\hfil\includegraphics[width = 14cm]{\Sexpr{    paste0(pathprogram, "figure/EstimationMemo/AssetsByPeriodNon800.pdf")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Tabulated with survey data. Out of sample members are households who were not a part of 800 members and treated with the same intervention arms as in our experiment.\\
Note:&  Red squares are means of respective data. \Sexpr{FNAssetDefinitions} All net assets are in logarithms, number of cattle is in natural numbers. \\[1ex]
\end{tabular}
}

\newpage
\renewcommand{\arraystretch}{.6}
\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Net assets by period\label{fig NetAssets}}\\
\hfil\includegraphics[width = 12cm]{\Sexpr{    paste0(pathprogram, "figure/EstimationMemo/NetAssetsByPeriod.pdf")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Tabulated with survey data.\\
Note:&  Red squares are means of respective data. Net assets are in logarithms. \\[1ex]
\end{tabular}
}

\renewcommand{\arraystretch}{.6}
\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Impacts on net assets relative to concurrent traditional arm\label{fig NetAssetsCumRelativeToConcurrentTradEffects}}\\
\hfil\includegraphics[width = 12cm]{\Sexpr{    paste0(pathprogram,   
  "figure/EstimationMemo/NetAssetsNLAssetsCattleEffects.pdf")
  }}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Estimated with survey data.\\
Note:&  Cumulative impacts on net assets. \Sexpr{CumImpactText3} Asset values are expressed in Taka. \textsf{Net assets}=total assets - debts. Debts include outstanding loaned amount of the experiment. Total assets use items observed in all 4 rounds of household surveys. \\[1ex]
\end{tabular}
}

\begin{itemize}
\vspace{1.0ex}\setlength{\itemsep}{1.0ex}\setlength{\baselineskip}{12pt}
\item	All non-\textsf{Traditional} arms achieve larger net assets than \textsf{Traditional} arm by period 4.
\item	This is achieved through increases in both livestock and non-livestock assets relative to \textsf{Traditional} arm.
\item	\textsf{Large} arm shows an earlier increase in all non-\textsf{Traditional} arms. This indicates the borrowers of this arm may be better prepared than other non-\textsf{Traditional} arms as they had to build up cash holding before the loan is disbursed. The impacts in period 4 are similar in all non-\textsf{Traditional} arms. It implies that better preparation may affect the time course of impacts, but not their size (in midium term). 
\item	\textsf{Cattle} arm confidence intervals are tightest among the all non-\textsf{Traditional} arms. While its sample size is largest ($n=199$), it is the same as the \textsf{Large} arm and rejection and flood caused attrition are greater (47 vs. 29). This hints that the limited room of discretionary decision making under this arm may have resulted in smaller variations in project returns. 
\end{itemize}

\renewcommand{\arraystretch}{.6}
\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Cumulative impacts on various assets relative to concurrent traditional arm\label{fig NetAssetLandCattleCumRelativeToConcurrentTradEffects}}\\
\hfil\includegraphics[width = 14cm]{\Sexpr{    paste0(pathprogram,   
  "figure/EstimationMemo/NetAssetLandCattleEffects.pdf")
  }}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Estimated with survey data.\\
Note:&  Cumulative impacts on various asset measures. \Sexpr{CumImpactText3} \Sexpr{FNAssetDefinitions}\\[1ex]
\end{tabular}
}

\renewcommand{\arraystretch}{.6}
\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Cumulative impacts on net assets relative to concurrent traditional arm\label{fig NetAssetRelativeToConcurrentTradEffects}}\\
\hfil\includegraphics[width = 14cm]{\Sexpr{    paste0(pathprogram,   
  "figure/EstimationMemo/NetAssetsEffects.pdf")
  }}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Estimated with survey data.\\
Note:&  Cumulative impacts on net assets of non-\textsf{Traditional} arms relative to \textsf{Traditional} arm. \Sexpr{c(CumImpactText3, FNAssetDefinitions)}\\[1ex]
\end{tabular}
}

Results of land holding is similar to net assets, as it is a part of net assets, but the gap widens as period progresses. This is seen in the point estimates of non-\textsf{traditional} arms that are positive, yet most of estimates are imprecise and have their 95\% confidence intervals crossing zero. Among all three assets, land holding may be most reliable indicator of wealth for fewer missingness. Net assets are defined as total assets less debt outstanding, yet we have smaller coverage of asset items in the first period which inflates the increasing trend.\footnote{This change in coverage is common to all arms, and given randomisation, this should not affect identification of imapcts by ANCOVA estimator as it is captured in the estimates of \textsf{traditional} arm, although it adds an extra noise. }


\renewcommand{\arraystretch}{.6}
\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Cumulative impacts on net assets relative to traditional arm by experience\label{fig AssetRelativeToCumulativeConcurrentTradEffectsByExperience}}\\
\hfil\includegraphics[width = 14cm]{\Sexpr{    
paste0(pathprogram,   "figure/EstimationMemo/NetAssetsByExperienceEffects.pdf")
}}\\
\renewcommand{\arraystretch}{.8}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Estimated with survey data.\\
Note:&  \Sexpr{FNAssetDefinitions} \textsf{Adi} is a group who has an experience of lease-in cattle contract at the period 2, \textsf{Own} is a group who holds cattle at the period 2, and \textsf{None} are all other individuals. There are \Sexpr{OwnCattleAtBaseline} members who owned cattle at the period 2, \Sexpr{AdiCattleAtBaseline} members who ever practiced \textsf{Adi} at the period 2, and  \Sexpr{776-OwnCattleAtBaseline-AdiCattleAtBaseline} members who have no experience in cattle rearing.
\end{tabular}
}

\renewcommand{\arraystretch}{.6}
\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Cumulative impacts on cattle holding relative to traditional arm by experience\label{fig NumCowsRelativeToCumulativeConcurrentTradEffectsByExperience}}\\
%\hfil\includegraphics[width = 14cm]{\Sexpr{    paste0(pathprogram,   "figure/EstimationMemo/NumCowsByExperienceEffects.pdf")}}\\
\renewcommand{\arraystretch}{.8}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Estimated with survey data.\\
Note:&  \Sexpr{FNAssetDefinitions} \textsf{Adi} is a group who has an experience of lease-in cattle contract at the period 2, \textsf{Own} is a group who holds cattle at the period 2, and \textsf{None} are all other individuals. There are \Sexpr{OwnCattleAtBaseline} members who owned cattle at the period 2, \Sexpr{AdiCattleAtBaseline} members who ever practiced \textsf{Adi} at the period 2, and  \Sexpr{776-OwnCattleAtBaseline-AdiCattleAtBaseline} members who have no experience in cattle rearing. 
\end{tabular}
}


\begin{figure}
\mpage{12cm}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Cumulative effects on labour income and per capita consumption\label{fig IncomeConsumptionEffects}}\\

\vspace{2ex}
\hspace{-2em}\includegraphics[height = 8cm, width = 14cm]{\Sexpr{      paste0(pathprogram, "figure/EstimationMemo/IncomeConsumptionEffects.pdf")}}\\
\renewcommand{\arraystretch}{1}
\setlength{\tabcolsep}{1pt}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12.5cm}<{\hfill}}
Source: & Constructed from ANCOVA estimation results 
\textsc{Table \ref{tab ANCOVA consumption timevarying}}, \textsc{Table \ref{tab ANCOVA consumption timevarying attributes original HH}}, \textsc{Table \ref{tab ANCOVA labour incomes timevarying}}, \textsc{Table \ref{tab ANCOVA labour incomes timevarying attributes}}.\\
Note:& Style and placement of panels follow the \textsc{\footnotesize Figure \ref{fig NetAssetEffects}}. \Sexpr{CumImpactText3} \textsf{Per capita consumption} is a total of food, hygiene, social, and energy expenditure divided by the number of household members, expressed as the annuaslied values in BDT. In-kind consumption of home made products is imputed at median prices. \textsf{Labour income} is labour incomes of household in 1000 BDT units. \\[1ex]
\end{tabular}
}
\end{figure}

\begin{figure}
\mpage{13cm}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Effects on child schooling by arm\label{fig SchEffectsByArm}}\\

\vspace{2ex}
\hfil\includegraphics[height = 12cm]{\Sexpr{      paste0(pathprogram, 
  "figure/EstimationMemo/SchoolingEffectsWithTradByArm.pdf")}}\\
\renewcommand{\arraystretch}{1}
\setlength{\tabcolsep}{1pt}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Constructed from ANCOVA estimation results of \textsc{Table \ref{tab ANCOVA Sch}}.\\
Note:& The left most column shows schooling level of \textsf{Traditional arm}. The right three columns show marginal impacts of each arms relative to the \textsf{Traditional arm}. Each rows are grouped into primary, junior, and high school levels. 
\Sexpr{CumImpactText3}  \\[1ex]
\end{tabular}
}
\end{figure}

\begin{figure}
\mpage{13cm}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Effects on child schooling by functional attribute\label{fig SchEffectsByFunAttribute}}\\

\vspace{2ex}
\hfil\includegraphics[height = 12cm]{\Sexpr{      paste0(pathprogram, 
  "figure/EstimationMemo/SchoolingEffectsWithTradByFunAttribute.pdf")}}\\
\renewcommand{\arraystretch}{1}
\setlength{\tabcolsep}{1pt}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Constructed from ANCOVA estimation results of \textsc{Table \ref{tab ANCOVA Sch}}.\\
Note:& The left most column shows schooling level of \textsf{Traditional arm}. The right three columns show marginal impacts of each functional attributes. \textsf{Upfront} shows impacts relative to the \textsf{Traditional arm}, \textsf{With grace} shows impacts relative to \textsf{Traditional arm} and \textsf{Upfront}, and \textsf{In Kind} shows impacts relative to \textsf{Traditional arm}, \textsf{Upfront}, and \textsf{With grace}. Each rows are grouped into primary, junior, and high school levels. 
\Sexpr{CumImpactText3}  \\[1ex]
\end{tabular}
}
\end{figure}

\begin{figure}
\mpage{13cm}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Concurrent effects on child schooling by functional attribute\label{fig SchEffectsConcurrentByFunAttribute}}\\

\vspace{2ex}
\hfil\includegraphics[height = 12cm]{\Sexpr{      paste0(pathprogram, 
  "figure/EstimationMemo/SchoolingEffectsConcurrentWithTradByFunAttribute.pdf")}}\\
\renewcommand{\arraystretch}{1}
\setlength{\tabcolsep}{1pt}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Constructed from ANCOVA estimation results of \textsc{Table \ref{tab ANCOVA Sch}}.\\
Note:& The left most column shows schooling level of \textsf{Traditional arm}. The right three columns show marginal impacts of each functional attributes. \textsf{Upfront} shows impacts relative to the \textsf{Traditional arm}, \textsf{With grace} and \textsf{In Kind} show impacts relative to \textsf{Upfront}. Each rows are grouped into primary, junior, and high school levels. Impacts are per period effects $b_{2t}$ relative to concurrent respective comparison group, not the total effects $b_{0}+b_{2t}$. 
  \\[1ex]
\end{tabular}
}
\end{figure}


\begin{itemize}
\vspace{1.0ex}\setlength{\itemsep}{1.0ex}\setlength{\baselineskip}{12pt}
\item	\textsc{\footnotesize Figure \ref{fig SchEffectsByArm}} shows negative impacts of nontraditional arm among boys of primary school. Impacts on the boys are always negative among non-traditional arms for all school levels. But only primary school impacts are estimated precisely enough to be statistically distinct from zero.
\item	\textsc{\footnotesize Figure \ref{fig SchEffectsByFunAttribute}} shows the negative impacts on primary school aged boys are due to the upfront nature of the leding. 
\item	Given that the \textsf{Upfront} nature of the lending causes borrowers to purchase a heiffer, the negative impacts on the boy's schooling is most likely to be due to heiffer related labour. Impacts in period 4 are 
\Sexpr{
confis[grepl("non.*-.*d\\,.*ea", ImpactType) & grepl("pr", school) & grepl("^ma", gender) & grepl("T$", regtype) & period == 2 & num == 5, estimate]
} percentage points for \textsf{Large}, \textsf{LargeGrace}, and \textsf{Cattle} arms, respectively.

\end{itemize}


\subsection{Project cycle}

<<warning = F>>=
options(width = 90)
library(readstata13)
pc1 <- read.dta13(paste0(path234E, "S21AProjectCycle.dta")
  , generate.factors = T, nonint.factors = T)
pc1 <- data.table(pc1)
pc2 <- read.dta13(paste0(path234E, "S21BProjectCycle.dta")
  , generate.factors = T, nonint.factors = T)
pc2 <- data.table(pc2)
setnames(pc1, c("id", "strat_year", "project_typf"), 
  c("hhid", "start_year", "project_type"))
setnames(pc2, "id", "hhid")
xid <- readRDS(paste0(path1234, "ID.rds"))
xid[, tee := 1:.N, by = hhid]
xid1 <- xid[tee == 1, ]
xid1[, tee := NULL]
setkey(xid1, hhid); setkey(pc1, hhid); setkey(pc2, hhid)
pc1 <- pc1[xid1]
pc2 <- pc2[xid1]
arA <- readRDS(
    paste0(pathsaveHere, DataFileNames[2], "InitialSample.rds")
  )
arid <- unique(arA[, .(groupid, hhid, Mgroup, Mstatus, BStatus, creditstatus, 
  Arm, o800)])
setkey(pc1, groupid, hhid, Mgroup, Mstatus)
setkey(arid, groupid, hhid, Mgroup, Mstatus)
pc1 <- pc1[arid]
if (Only800) {
  pc1 <- pc1[hhid %in% ar[o800 == 1L, hhid], ]
  pc2 <- pc2[hhid %in% ar[o800 == 1L, hhid], ]
}
# Entries with no info
pc1 <- pc1[!is.na(iga1_1st), ]
pc1[, Arm := factor(Arm, levels = arms)]
# Define Project as a more organised summary of project_type
pc1[, Project := as.character(NA)]
pc1[grepl("ow", project_type), Project := "cow"]
pc1[grepl("Ox", project_type), Project := "ox"]
pc1[grepl("Other", project_type) & grepl("goat|ram|sheep", project_type_others), 
  Project := "goat/sheep"]
pc1[grepl("Land", project_type), Project := "land"]
pc1[grepl("busi|trad|tail", project_type_others), Project := "business/trade"]
pc1[, Project := factor(Project, levels = c("cow", "ox", "goat/sheep", "business/trade",
  "land", NA))]
# summarise igas
pc1[, IGA1 := tolower(gsub("^machi.*", "machine", iga1_1st))]
pc1[, IGA1 := gsub("^sheep.*", "goat", IGA1)]
pc1[, IGA1 := gsub("^cow.*", "cow", IGA1)]
pc1[, IGA1 := gsub("^ox.*", "ox", IGA1)]
pc1[, IGA1 := gsub("^smal.*", "trade", IGA1)]
pc1[, IGA1 := gsub("^paddy.*", "land", IGA1)]
pc1[, IGA1 := gsub("^(.*?) .*", "\\1", IGA1)]
pc1[, IGA2 := tolower(gsub("^machi.*", "machine", iga1_2nd))]
pc1[, IGA2 := gsub("^sheep.*", "goat", IGA2)]
pc1[, IGA2 := gsub("^cow.*", "cow", IGA2)]
pc1[, IGA2 := gsub("^ox.*", "ox", IGA2)]
pc1[, IGA2 := gsub("^smal.*", "trade", IGA2)]
pc1[, IGA2 := gsub("^paddy.*", "land", IGA2)]
pc1[, IGA2 := gsub("^(.*?) .*", "\\1", IGA2)]
pc1[, IGA3 := tolower(gsub("^machi.*", "machine", iga1_3rd))]
pc1[, IGA3 := gsub("^sheep.*", "goat", IGA3)]
pc1[, IGA3 := gsub("^cow.*", "cow", IGA3)]
pc1[, IGA3 := gsub("^ox.*", "ox", IGA3)]
pc1[, IGA3 := gsub("^smal.*", "trade", IGA3)]
pc1[, IGA3 := gsub("^paddy.*", "land", IGA3)]
pc1[, IGA3 := gsub("^(.*?) .*", "\\1", IGA3)]
pc1[, IGA13 := paste(IGA1, IGA2, IGA3, sep= "-")]
tabiga13 <- function(x) {
  tb <- table(unlist(base::strsplit(x, "-")))
  if (any(tb>1)) 
    paste0(tb[tb>1], " ", names(tb)[tb>1], "s,", names(tb)[tb==1]) else
    paste(names(tb)[order(tb)], collapse = ",")
}
pc1[, IGAs := gsub("-NA|NA-", "", IGA13)]
pc1[, IGAs := gsub(",", "", IGAs)]
pc1[, IGAs := lapply(IGAs, tabiga13), by = hhid]
pc1[, c("ProjNum", "TotalProj") := .(1:.N, .N), by = hhid]
tb <- table(pc1[, hhid])
# Members reporting multiple projects with multiple rows
#summary(pc1[hhid %in% names(tb)[tb>1], 
#  .(hhid, project_type, IGAs=factor(IGAs), start_year, start_month, 
#  end_year, end_month)])
#table0(pc1[hhid %in% names(tb)[tb>1], .(project_type, IGAs)])
# Conflicting info between Project and IGAs
tb <- table0(pc1[
#hhid %in% names(tb)[tb>1] &
  !((grepl("ow|ox", Project) & grepl("cow|ox", IGAs)) |
  (grepl("oat", Project) & grepl("oat", IGAs)) |
  (grepl("tra", Project) & grepl("tra", IGAs)) |
  (grepl("land", Project) & grepl("land", IGAs))), .(IGAs, Project)])
tb2 <- table(pc1[o800==1, hhid])
tb2 <- table0(pc1[
  hhid %in% names(tb2)[tb2>1] &
  !((grepl("ow|ox", Project) & grepl("cow|ox", IGAs)) |
    (grepl("oat", Project) & grepl("oat", IGAs)) |
    (grepl("tra", Project) & grepl("tra", IGAs)) |
    (grepl("land", Project) & grepl("land", IGAs))), .(IGAs, Project)])
tb3 <- table0(pc1[
  hhid %in% names(tb2)[tb2>1] &
  !((grepl("ow|ox", Project) & grepl("cow|ox", IGAs)) |
    (grepl("oat", Project) & grepl("oat", IGAs)) |
    (grepl("tra", Project) & grepl("tra", IGAs)) |
    (grepl("land", Project) & grepl("land", IGAs))), .(IGAs, TotalProj)])
@
There are issues with the project cycle data. 
\begin{itemize}
\vspace{1.0ex}\setlength{\itemsep}{1.0ex}\setlength{\baselineskip}{12pt}
\item  There are \Sexpr{sum(table(table(pc1[o800==1,hhid]))[-1])} members who report multiple entries (rows). This is the intended way of reporting multiple projects. However, \Sexpr{sum(tb2)} members report IGAs (\textsf{iga1\_1st}, etc.) that do not match with respective \textsf{project\_type}. Among all members, \textsf{project\_type} is less in details (``cow'') and IGAs are more detailed (``cow, trade, goat''). In the majority cases, the contents in the former is a subset of the contents of the latter. In other cases, they simply differ: There are \Sexpr{sum(tb)} unmatching members of which \Sexpr{sum(tb[, ncol(tb)])} with NAs in \textsf{project\_type}. Given that there are (a relatively small number of) \Sexpr{sum(tb[, -ncol(tb)])} cases of nonNAs in project type and detailed IGAs, I will use information only in \textsf{igaX\_Y} and ignore \textsf{project\_type}. 
\item	There is one piece of information that may not to be dropped with \textsf{project\_type} where \Sexpr{tb["cow", "ox"]} members report ox in their project while IGAs report cows. I will overwrite cow as IGA with ox.
\item	\textsf{igaX\_Y} supposedly indicates \textsf{X}-th income generating activity in \textsf{Y}-th most recent project. But \textsf{year\_Y} shows that \textsf{igaX\_Y} is \textsf{Y}-th oldest project. \textsf{year\_2nd} (all 2014), \textsf{year\_3rd} (all 2015) are reported only for \textsf{traditional} indicates that \textsf{year\_Y} refers to disbursement years, not necessarily the project starting year. This is further supported by no \textsf{year\_2nd} is recorded for other arms. Information exists in \textsf{iga1\_1st}, \textsf{iga1\_2nd}, \textsf{iga1\_3rd} (most, 2nd most, 3rd most recent igas), but not in \textsf{iga2\_1st}, \textsf{iga2\_2nd}, \textsf{iga2\_3rd}, \textsf{iga3\_1st}, \textsf{iga3\_2nd}, \textsf{iga3\_3rd}. 
\end{itemize}
<<reported igas>>=
# subset cases
addmargins(table0(pc1[
  ((grepl("ow", Project) & grepl("cow", IGAs)) |(grepl("ox", Project) & grepl("ox", IGAs)) |
  (grepl("oat", Project) & grepl("oat", IGAs)) |(grepl("tra", Project) & grepl("tra", IGAs)) |
  (grepl("land", Project) & grepl("land", IGAs))), .(IGAs, Project)]), 
  1:2, sum, quiet = T)
# unmatching cases
addmargins(table0(pc1[!((grepl("ow", Project) & grepl("cow", IGAs)) |
  (grepl("ox", Project) & grepl("ox", IGAs)) |
  (grepl("oat", Project) & grepl("oat", IGAs)) |
  (grepl("tra", Project) & grepl("tra", IGAs)) |
  (grepl("land", Project) & grepl("land", IGAs))), .(IGAs, Project)]),
  1:2, sum, quiet = T)
setkey(pc1, hhid, start_year, start_month)
table0(pc1[!is.na(iga1_2nd), .(year_1st, year_2nd)])
table0(pc1[!is.na(iga1_3rd), .(year_1st, year_3rd)])
# members multiple igas but reporting only 1 date seem to have multiple projects,
# just not having multiple start dates (they started earlier than this research?)
summary(pc1[!is.na(iga1_2nd) & year_2nd == 0, 
  .(Arm, BStatus = droplevels(BStatus), IGAs = droplevels(factor(IGAs)), 
    Project = droplevels(Project))])
# members with multiple igas reporting more than 1 date
summary(pc1[!is.na(iga1_2nd) & year_2nd != 0, 
  .(Arm=droplevels(Arm), BStatus = droplevels(BStatus), 
    IGAs = droplevels(factor(IGAs)), 
    Project = droplevels(Project), 
    year_2nd = factor(year_2nd), year_3rd= factor(year_3rd))])
summary(pc1[!is.na(iga1_2nd) & year_2nd == 0, 
  .(Arm=droplevels(Arm), BStatus = droplevels(BStatus), 
    IGAs = droplevels(factor(IGAs)), 
    Project = droplevels(Project), 
    year_3rd= factor(year_3rd))])
# Overwrite cow with ox
pc1[grepl("^cow$", IGAs) & grepl("ox", Project), IGAs := "ox"]
@
Tabulation of loan projects shows that there is no member invested all in goats and goats are not the members' main assets. Among the \Sexpr{length(unique(pc1[o800 == 1 & grepl("tra", Arm), hhid]))} \textsf{tradtional} loan recipients who report their loan projects, there are \Sexpr{nrow(pc1[o800 == 1 & grepl("tra", Arm) & grepl("2 goa", IGAs), ])} members who report to have purchased a goat twice and \Sexpr{nrow(pc1[o800 == 1 & grepl("tra", Arm) & grepl("2 tra", IGAs), ])} who have invested in a retail trade twice. It is also puzzling that, among \textsf{traditional} arm members, \Sexpr{nrow(pc1[o800 == 1 & grepl("tra", Arm) & grepl("2 cow", IGAs), ])} report to have invested in a cow twice, which seems unlikely with their purchasing powers. 
<<Tabulation of loan projects>>=
table0(pc1[o800 == 1 & grepl("tra", Arm), IGAs])
# tb <- as.data.frame.matrix(table0(pc1[grepl("bor", BStatus), .(IGA13, Arm)]))
# tb <- data.table(cbind(IGA13 = rownames(tb), tb))
# tb[, IGA13 := as.character(IGA13)]
# setorder(tb, -traditional)
# tb
@
%\textsf{project\_type} and \textsf{project\_type\_others} give primary projects.
Number of reported IGAs by arm shows that \textsf{traditional} members report a project everytime they receive a loan, hence all have 3 IGAs. Interestingly, none has three goats.
<<Number of reported projects>>=
#tbprjnum <- addmargins(table0(pc1[o800==1, .(N=.N), by = .(Arm, hhid)][,
#  .(Arm, N)]), 2, sum)
tbprjnum <- addmargins(table0(pc1[o800==1, 
  .(NumIGAs = as.numeric(!is.na(IGA1)) + as.numeric(!is.na(IGA2)) + as.numeric(!is.na(IGA3))), 
  by = .(Arm, hhid)][, .(Arm, NumIGAs)]), 2, sum)
cbind(round((tbprjnum[, 1:2]/tbprjnum[, 3])*100, 2), sum = tbprjnum[, 3]) 
table0(pc1[o800 == 1 & grepl("tra", Arm), IGAs])
@
%Proportion of single project reporting: Traditional vs. other arms.
<<Proportion of single project reporting, echo = F, eval = F>>=
rn <- rownames(tbprjnum)
bntest <- vector(mode = "list", length = 3)
for (i in 1:3) 
  bntest[[i]] <- 
    binom.test(
        x = tbprjnum[grepl(c("^large$", "gra", "catt")[i], rn), 1]
      , n = tbprjnum[grepl(c("^large$", "gra", "catt")[i], rn), "sum"],
      , p = tbprjnum["traditional", 1]/tbprjnum["traditional", "sum"])
bntest
# Below is raw data of loan projects. This is categorised in summarised in the new variable "Project"
#table0(pc1[o800 == 1 & grepl("trad", Arm), .(BStatus, project_type)])
#table0(pc1[, .(Assign, project_type_others)])
@
Goat holding size and total holding increase by the final round but the number of holders is decreasing, indicating a limited number of expansion in goat holding. Interestingly, it is only \textsf{traditional} arm holding that are increasing while all ther arms reduce the goat holding size.
<<Goat holding by survey round>>=
lvo <- readRDS(paste0(pathsaveHere, DataFileNames[5], "InitialSample.rds"))
lvo[, Num := .N, by = hhid]
@
\verb|addmargins(table0(lvo[o800==1L & tee == 1, .(Arm, Num)]))|
<<>>=
addmargins(table0(lvo[o800==1L & tee == 1, .(Arm, Num)]))
# HHs with single observations
# summary(lvo[hhid %in% hhid[Num==1], 
#   .(Arm, hhid, survey = factor(survey), Livestock = factor(LVcode), 
#   NumCows = factor(NumCows), ObPattern)])
lvo[, N := .N, by = .(Arm, BStatus, o800, survey)]
# HHs with single observations
summary(lvo[hhid %in% hhid[Num==1] & survey == 1, 
  .(Arm, hhid, survey = factor(survey), 
  NumOwned.goatsheep = factor(NumOwned.goatsheep), 
  NumOwned.chickenduck = factor(NumOwned.chickenduck), 
  NumCows = factor(NumCows), ObPattern)])
@
Cattle ownership at rd 1.
<<>>=
addmargins(table0(lvo[o800 == 1L & survey == 1, .(Arm, NumCows)]))
@
Cattle ownership of attriters (at round 4) at rd 1.
<<>>=
addmargins(table0(lvo[o800 == 1L & survey == 1 & AttritIn == 4, .(Arm, NumCows)]))
@
Cattle ownership at rd 4 
<<>>=
addmargins(table0(lvo[o800 == 1L & survey == 4, .(Arm, NumCows)]))
lvo[o800 == 1L, 
 .(N = .N,
   MeanNumCow = mean(NumCows, na.rm = T), 
   MedianNumCow = median(NumCows, na.rm = T)), by = .(Arm, survey)][
  order(Arm, survey), ]
@
Last observed round.
<<>>=
#addmargins(table0(lvo[hhid %in% hhid[AttritIn==4] & survey == 1, .(BStatus, Arm)]))
addmargins(table(lvo[o800 == 1, .(LastObservedRound = max(survey)), by = .(BStatus, hhid)][, 
  .(BStatus, LastObservedRound)]), 1:2, sum, quiet = T)
# lvo[, c("NumberOfTimesObserved", "Cowtee") := .(.N, 1:.N), 
#   by = hhid]
# addmargins(table0(lvo[o800 == 1
#   & Cowtee == 1, 
#   .(Arm, NumberOfTimesObserved)]),
#   1:2, sum, quiet = T)
# addmargins(table0(lvo[o800 == 1
#   & Cowtee == 1, 
#   .(BStatus, NumberOfTimesObserved)]),
#   1:2, sum, quiet = T)
@
Attach 0 cattle ownership when nothing is reported.
<<>>=
lvo[is.na(NumCows), NumCows := 0]
addmargins(table0(lvo[o800 == 1 & survey == 1, 
  .(Arm, NumCows)]),
  1:2, sum, quiet = T)
@
Number of cattle in round 4.
<<>>=
addmargins(table0(lvo[o800 == 1 & survey == 4, 
  .(Arm, NumCows)]),
  1:2, sum, quiet = T)
nocow <- lvo[Arm == "cattle" & o800 == 1 & Year > 2013, 
  hhid[!is.na(NumOwned.cowox) & NumOwned.cowox==0]]
@
There are \Sexpr{length(nocow)} members in \textsf{cattle} arm who report not to own cattle at least once after receiving cattle. Total holding size and holders may be too low. Below gives holding size of cattle among nonattriting members in \textsf{cattle} arm.
<<members of cow arm who do not report cattle ownership inn 2015>>=
addmargins(table0(lvo[Arm == "cattle" & o800 == 1 & AttritIn == 9, .(survey, NumOwned.cowox)]), 2)
@
Members of \textsf{traditional} arm have the smallest cattle holding. In \textsc{\small Table \ref{table anova CattleHoldingArm}}, ANOVA and Kruskal-Wallis tests indicate that means of cattle holding are different between arms in 2017. Tukey HST gives test results that account for multiple testing and shows that there is a difference between \textsf{traditional} and \textsf{large}, and other arms are in between yet their standard errors are too large to be considered statistically different from both extremes.
<<Test diff between per capita holding>>=
#  aovdat <- lvo[grepl(lvstk[1], LVcode) & o800==1 & 
#    hhid %in% arid[, hhid] & grepl("bo", BStatus) & Year == 2017, 
#      .(Arm, number_owned)]
#table0(lvo[, .(NumCows, NumOwned.cowox)])
#table0(lvo[Year >= 2014, .(NumCows, NumOwned.cowox)])
@
<<>>=
# lvo[!grepl("cow", Arm) & 
#   hhid %in% hhid[
#     any(is.na(NumCows)) & 
#     (!is.na(NumCows) & NumCows > 0 & survey < 2)] &
# 	  hhid %in% pc1[grepl("cow", pc1[, IGA13]), hhid], 
#   .(Arm, hhid, survey, NumCows, NumOwned.cowox)] 
lvo[, Arm := factor(Arm, labels = ArmsC)]
aovdat <- lvo[o800==1 & survey == 4, .(Arm, NumCows)]
NCowDestat <- rbindlist(
lapply(by(aovdat[, NumCows], aovdat[, Arm], destat), data.table)
)
NCowDestat[, Arms := arms]
setcolorder(NCowDestat, c(ncol(NCowDestat), 1:(ncol(NCowDestat)-1)))
addmargins(table0(aovdat), 1:2, sum, quiet = T)
# non-Cow arm: Assign 1 to NA for round 2 onwards if 
#  a. NumCows is positive before 2014, and
#  b. IGA13 includes cow
lvo[!grepl("Ca", Arm) & 
  hhid %in% hhid[any(is.na(NumCows)) & (!is.na(NumCows) & NumCows > 0 & survey == 1)] 
  &
  hhid %in% pc1[grepl("Ca", pc1[, IGA13]), hhid] 
  & 
  survey >= 2, 
    NumCows := NumCows[!is.na(NumCows)][1], by = hhid]
aovdat1 <- lvo[o800==1 & survey == 4, .(Arm, NumCows)]
aovdat3 <- lvo[o800==1 & survey == 3, .(Arm, NumCows)]
aovdat4 <- lvo[o800==1 & survey == 2, .(Arm, NumCows)]
aovdat5 <- lvo[o800==1 & survey == 1, .(Arm, NumCows)]
@
Cattle arm: add a cow for borrowers if NumCows is NA or zero in rd 2 onwards.
<<>>=
lvo[grepl("Ca", Arm) & (is.na(NumCows) | (!is.na(NumCows)  & NumCows == 0))
   & survey >= 2 & grepl("bo", BStatus), NumCows := 1]
aovdat2 <- lvo[o800==1 & survey == 4, .(Arm, NumCows)]
NCowDestat <- rbindlist(
lapply(by(aovdat2[, NumCows], aovdat[, Arm], destat), data.table)
)
NCowDestat[, Arms := ArmsC]
setcolorder(NCowDestat, c(ncol(NCowDestat), 1:(ncol(NCowDestat)-1)))
addmargins(table0(aovdat2), 1:2, sum, quiet = T)
# aovdat1: raw data in 2017
# aovdat2: NA => 0 for cow arm after 2013, 2017
# aovdat3: raw data in 2015-16
# aovdat4: raw data in 2014
# aovdat5: raw data in 2012
aovfilenames <- c("_beforeDataEdit", "", "_3", "_2", "_1")
for (k in 1:length(aovfilenames)) {
  aovdat <- get(paste0("aovdat", k))
  NCowDestat <- rbindlist(
  lapply(by(aovdat[, NumCows], aovdat[, Arm], destat), data.table)
  )
  NCowDestat[, Arms := arms]
  setcolorder(NCowDestat, c(ncol(NCowDestat), 1:(ncol(NCowDestat)-1)))
  tb <- addmargins(table0(aovdat), 2, sum)
  round(tb/tb[, ncol(tb)], 2)
  summary(res.aov <- aov(NumCows ~ Arm, data = aovdat))
  tuk <- TukeyHSD(res.aov)
  #plot(res.aov, 1)
  (res.KWaov <- kruskal.test(NumCows ~ Arm, data = aovdat))
  anova.res <- rbind(
    c("ANOVA", rep("", 3), 
      formatC(summary(res.aov)[[1]][1, 5], digits = 4, format = "f"))
    , c("Kruskal-Wallis", rep("", 3), 
      formatC(res.KWaov$p.val, digits = 4, format = "f"))
    , cbind(paste0("\\hspace{.5em}", rownames(tuk$Arm)), 
       formatC(tuk$Arm, digits = 4, format = "f"))
  )
  colnames(anova.res) <- c("Test", "Mean diff", "lower", "upper", "$p$ value")
  assign(paste0("anovares", k), anova.res)
  write.tablev(
   latextab(anova.res, 
     hleft = c("\\footnotesize\\hfill", rep("\\hfil\\footnotesize$", ncol(anova.res)-1)),
     hcenter = c(3.5, rep(1, ncol(anova.res)-1)),
     hright = c("", rep("$", ncol(anova.res)-1)),
     alternatecolor = "gray90",
     LastDiffVariable = "^AN",
     SepLineText = "Tukey HST", inter.with = "")
     ,
    paste0(pathprogram, 
      "table/EstimationMemo/anovaCow", 
      aovfilenames[k], ".tex"), 
    colnamestrue = F)
}
anovares <- rbindlist(
  lapply(list(anovares1, anovares2, anovares3, anovares4, anovares5), 
    function(x) data.table(x[, c(2, 5), drop = F]))
  )
setnames(anovares, c("difference", "pval"))
anovares[, Tests := rep(anovares1[, 1], length(aovfilenames))]
anovares[, pval := paste0("(", 
  formatC(as.numeric(pval)*100, digits = 2, format = "f"), 
  ")")]
#anovares[grepl("AN|Kru", Tests), pval := 
#  formatC(as.numeric(pval)*100, digits = 2, format = "f")]
anovm <- matrix(c(t(anovares[, 1:2])), byrow = F, nrow = 2)
anovm <- data.table(matrix(c(anovm), byrow = F, ncol = length(aovfilenames)))
anovm <- anovm[V1 != "", ]
anovm[, Tests := c(anovares1[1:2, 1], c(t(cbind(anovares1[-(1:2), 1], ""))))]
setcolorder(anovm, c("Tests", paste0("V", 1:5)))
setnames(anovm, c("Tests", "rd4", "rd4 edited", "rd3", "rd2", "rd1"))
write.tablev(
 latextab(
    tab = as.matrix(anovm), 
    hleft = c("\\footnotesize\\hfill", rep("\\hfil\\footnotesize$", ncol(anovm)-1)),
    hcenter = c(3.5, rep(1, ncol(anovm)-1)),
    hright = c("", rep("$", ncol(anovm)-1)),
    alternatecolorManualColor = "gray90", 
    alternatecolorManual = c(seq(7, nrow(anovm)+2, 4), seq(8, nrow(anovm)+2, 4)),
    addheaderAbove = "num", 
    addheaderBelow = letters[1:6], 
    headercolor = "paleblue",
    adjustlineskip = "-.5ex", adjlskiprows = seq(3, nrow(anovm), 2),
    LastDiffVariable = "^AN", SepLineText = "Tukey HST", inter.with = "")
  , paste0(pathprogram, 
      "table/EstimationMemo/anovaCowResults.tex")
  , colnamestrue = F)
addmargins(table0(lvo[o800==1 & NumCows > 4 & survey == 4, 
  .(Arm, groupid)]), 1:2, sum)
@

\mpage{\linewidth}{
\renewcommand{\arraystretch}{.6}
\hfil\textsc{\footnotesize Table \refstepcounter{table}\thetable: Anova results for cattle holding equality by arm\label{table anova CattleHoldingArm}}\\
\hfil\input{\Sexpr{  paste0(pathprogram, "table/EstimationMemo/anovaCowResults.tex")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Survey data.\\
Note:& Each column uses respective year cattle ownership information. For ANOVA and Kruskal-Wallis, each entry indicates $p$ values. ANOVA tests for the null of equality of means under normality. Kruskal-Wallis tests for the null of no stochastic dominance among samples without using the normality assumption. Tukey's honest significant tests show difference in means and $p$ values in parenthesis that account for multiple testing under normality. In column 2, we edited data by assigning 1 to members of \textsf{cattle} arm at dates after disbursement if reported holding is NA or zero. \\[1ex]
\end{tabular}}


%Drop these households from livestock data.
<<drop nocow HHs in cow arm, eval = F, echo = F>>=
lvo2 <- lvo[!(hhid %in% nocow), ]
@
<<summarise livestock holding by arm BStatus>>=
# livestock long format
lvoL <- readRDS(paste0(pathsaveHere, DataFileNames[6], "InitialSample.rds"))
lvoL[, Arm := factor(Arm, labels = ArmsC)]
# goat holding: no reporting for round 2 onwards
tb <- table(lvoL[o800==1 & grepl("goat", LVcode), .(survey, NumOwned)])
tb <- tb[, -1]
tb <- cbind(addmargins(tb, 2, sum), 
  total = tb[, 1]*1 + tb[, 2]*2 + tb[, 3]*3 + tb[, 4]*4 + tb[, 5]*5 + tb[, 6]*6 + tb[, 7]*7)
cbind(tb, HoldingSize = round(tb[, "total"]/tb[, "sum"], 2))
setorder(lvo, Arm, BStatus, survey, Year)
lvoL[, N := .N, by = .(Arm, BStatus, LVcode, o800, survey)]
# number of holders
lvstk <- c("ow|ox", "oat")
lvstkName <- c("cattle", "goat")
lvstkCounts <- c("NumCows", "NumOwned")
lvstkSummary <- NULL
for (k in 1) {
  if (k == 1) 
  lvoc <- lvoL[o800==1 , 
    .(Holders = sum(!is.na(NumCows) & NumCows > 0)
    , Holding = sum(NumCows, na.rm = T)
    ), 
    by = .(survey, Arm, BStatus, N)][, 
    .(Arm, BStatus, survey, Holding, Holders
    , HoldersRate = Holders/N
    , HoldingSize = Holding/Holders, N)] else
  lvoc <- lvoL[o800==1 & grepl("oat", LVcode), 
    .(Holders = sum(!is.na(NumOwned) & NumOwned > 0)
    , Holding = sum(NumOwned, na.rm = T)
    ), 
    by = .(survey, Arm, BStatus, N)][, 
    .(Arm, BStatus, survey, Holding, Holders
    , HoldersRate = Holders/N
    , HoldingSize = Holding/Holders, N)]
  lvoc[, PerCapitaHolding := Holding/N]
  setnames(lvoc, c("HoldingSize", "Holding", "Holders", "HoldersRate", "PerCapitaHolding"), 
    paste0("value.", c("HoldingSize", "Holding", "Holders", "HoldersRate", "PerCapitaHolding")))
  lvocL <- reshape(lvoc, direction = "long", idvar = c("Arm", "BStatus", "survey", "N"),
    varying = grepout("^val", colnames(lvoc)))
  setnames(lvocL, "time", "variables")
  lvocL[, Livestock := lvstkName[k]]
  lvstkSummary <- rbind(lvstkSummary, lvocL)
}
setorder(lvstkSummary, Arm, BStatus, survey)
<<summarise livestock holding by arm>>=
lvoL <- readRDS(paste0(pathsaveHere, DataFileNames[6], "InitialSample.rds"))
lvoL[, Arm := factor(Arm, labels = ArmsC)]
# N2: number of entries per Arm and LVcode in each survey roun
lvoL[, N2 := .N, by = .(Arm, LVcode, o800, survey)]
lvoL[, InitialOwner := as.numeric(hhid %in% 
  hhid[survey == 1 & !is.na(NumOwned) & NumOwned > 0])
  , by = LVcode]
addmargins(table0(lvoL[grepl("co", LVcode) & survey==1 & o800==1,.(Arm,InitialOwner)]))
setorder(lvoL, Arm, LVcode, survey, Year)
# number of holders
lvstkSummary2 <- NULL
lvoc2 <- lvoL[o800==1 & grepl("cow", LVcode), 
  .(Holders = sum(!is.na(NumCows) & NumCows > 0)
  , Holding = sum(NumCows, na.rm = T)
  , InitialOwnerHolding = sum(NumCows[InitialOwner == 1L], na.rm = T)/
      sum(!is.na(NumCows) & NumCows > 0 & InitialOwner == 1L)
  ), 
  by = .(survey, Arm, N2)][, 
  .(Arm, survey, Holding, Holders
  , HolderRate = Holders/N2
  , InitialOwnerHolding
  , HoldingSize = Holding/Holders, N2)] 
lvoc2[, PerCapitaHolding := Holding/N2]
HoldingVariables <- c("HoldingSize", "Holding", "Holders", 
    "InitialOwnerHolding", "HolderRate", "PerCapitaHolding")
setnames(lvoc2, HoldingVariables, paste0("value.", HoldingVariables))
lvocL2 <- reshape(lvoc2, direction = "long", idvar = c("Arm", "survey", "N2"),
  varying = grepout("^val", colnames(lvoc2)))
setnames(lvocL2, "time", "variables")
lvocL2[, Livestock := lvstkName[k]]
#lvstkSummary2 <- rbind(lvstkSummary2, lvocL2)
lvstkSummary2 <- lvocL2
setorder(lvstkSummary2, Arm, Livestock, variables, survey)
@
Given the misreporting in large loans arms, the power may get affected and only \textsf{large} seems to stand out from all other arms, while \textsf{large grace, cattle} are not different in terms of cattle ownership against \textsf{traditional}. 
<<figure cattle holding per arm BStatus survey, warning = F, message = F, fig.align='center', fig.height = 3, fig.width = 10, fig.cap = paste0("Cattle holding", "\\\\ {\\footnotesize  \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
# number of loan recipients in each arm: Data of plot panel info and their N
ArmSizeData <- lvo[o800==1 & survey == 1, .(N = .N), by = .(Arm, BStatus)]
ArmSizeData2 = copy(ArmSizeData)
ArmSizeData3 = copy(ArmSizeData)
ArmSizeData4 = copy(ArmSizeData)
ArmSizeData[, variables := "Holders"]
ArmSizeData2[, variables := "Holding"]
ArmSizeData3[, variables := "HoldingSize"]
ArmSizeData3[, N := NA]
ArmSizeData4[, variables := "PerCapitaHolding"]
ArmSizeData4[, N := NA]
ArmSizeData <- rbindlist(list(ArmSizeData, ArmSizeData2, 
  ArmSizeData3, ArmSizeData4), use.names = T)
library(ggplot2)
g <- ggplot(data = subset(lvstkSummary, grepl("cattle", Livestock)), 
    aes(x = survey, y = value)) + 
  geom_col() +
  scale_x_continuous(name = "round", breaks = 1:4) +
  ylab("counts") +
  theme(
    legend.position = "none",
    axis.title = element_text(size = 7),
    axis.text.x = element_text(size = 5, angle = 90, vjust = 0, hjust = .5),
    axis.text.y = element_text(size = 6, hjust = 1),
    strip.text.x = element_text(color = "blue", size = 6, 
      margin = margin(0, .5, 0, .5, "cm")), 
    strip.text.y = element_text(color = "blue", size = 6, 
      margin = margin(.5, 0, .5, 0, "cm"))
  ) + 
  facet_grid(variables ~ Arm*BStatus, scales = "free_y") +
  geom_hline(data = ArmSizeData, aes(yintercept = N, color = "red"))
ggsave(
  paste0(pathprogram, 
    "figure/EstimationMemo/CowHoldingByArmBStatus.jpg"),
  g,
  width = 14, height = 8, units = "cm",
  dpi = 300
 )
pdf(
  paste0(pathprogram, 
    "figure/EstimationMemo/CowHoldingByArmBStatus.pdf")
  , width = 2*14/2.54, height = 2*10/2.54)
print(g)
whatever <- dev.off()
<<figure cattle holding per arm survey, warning = F, message = F, fig.align='center', fig.height = 3, fig.width = 10, fig.cap = paste0("Goat holding", "\\\\ {\\footnotesize  \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
library(ggplot2)
g <- ggplot(data = subset(lvstkSummary2, grepl("Rate|Size|Per|Ini", variables)),
    aes(x = survey, y = value)) + 
  geom_col() +
  scale_x_continuous(name = "round", breaks = 1:4) +
  ylab("counts") +
  theme(
    axis.title = element_text(size = 7),
    axis.text.x = element_text(size = 5, angle = 90, vjust = .5, hjust = 1),
    axis.text.y = element_text(size = 6, hjust = 1),
    strip.text.x = element_text(color = "blue", size = 6, 
      margin = margin(.05, 1.0, .05, 1.0, "cm")), 
    strip.text.y = element_text(color = "blue", size = 6, 
      margin = margin(1.0, .05, 1.0, .05, "cm"))
  ) + 
  facet_grid(variables ~ Arm, scales = "free_y")
ggsave(
  paste0(pathprogram, 
    "figure/EstimationMemo/CattleHoldingByArm.jpg")
  , g,
  width = 14, height = 10, units = "cm",
  dpi = 300
 )
pdf(
    paste0(pathprogram, "figure/EstimationMemo/CattleHoldingByArm.pdf")
  , width = 2*14/2.54, height = 2*10/2.54)
print(g)
whatever <- dev.off()
<<product choices collapsed original HHs, warning = F, message = F, fig.align='center', fig.height = 3, fig.width = 10, fig.cap = paste0("Project choices", "\\\\ {\\footnotesize  \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
library(ggplot2)
g <- ggplot(data = subset(pc1, creditstatus == "Yes"), aes(Project)) + 
  geom_histogram(stat = "count") +
  xlab("project choices") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
    name = "percentage in sample")+
  aes(y=stat(count)/sum(stat(count))) +
  theme(
    legend.position="bottom", 
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 9),
    legend.key = element_rect(fill = "white"),
    legend.key.size = unit(.5, "cm"),
    axis.text.x = element_text(size = 6, angle = 30, vjust = 1, hjust = 1),
    axis.text.y = element_text(size = 7, vjust = .5, hjust = 1),
    axis.title = element_text(size = 7),
    strip.text.x = element_text(color = "blue", size = 6, 
      margin = margin(0, .5, 0, .5, "cm")), 
    strip.text.y = element_text(color = "blue", size = 6, 
      margin = margin(.5, 0, .5, 0, "cm"))
  ) + 
  facet_grid(. ~ AssignOriginal, switch = "y")
ggsave(
  paste0(pathprogram, 
    "figure/ImpactEstimationOriginal1600Memo2/ProjectChoices.jpg"),
  g,
  width = 10, height = 4, units = "cm",
  dpi = 300
 )
<<fixed investment choices collapsed original HHs, warning = F, message = F, fig.align='center', fig.height = 3, fig.width = 10, fig.cap = paste0("Fixed investment amount", "\\\\ {\\footnotesize  \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
library(ggplot2)
g <- ggplot(data = subset(pc2, size_sequence == 1), aes(cost_once_amount_taka)) + 
  geom_histogram() +
  xlab("amount (Tk.)") +
  scale_y_continuous()+
  theme(
    legend.position="bottom", 
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 9),
    legend.key = element_rect(fill = "white"),
    legend.key.size = unit(.5, "cm"),
    axis.text = element_text(size = 5),
    axis.title = element_text(size = 7),
    strip.text.x = element_text(color = "blue", size = 6, 
      margin = margin(0, .5, 0, .5, "cm")), 
    strip.text.y = element_text(color = "blue", size = 6, 
      margin = margin(.5, 0, .5, 0, "cm"))
  ) + 
  facet_grid(. ~ AssignOriginal, switch = "y")
ggsave(
  paste0(pathprogram, 
    "figure/ImpactEstimationOriginal1600Memo2/FixedInvestmentAmount.jpg"),
  g,
  width = 10, height = 4, units = "cm",
  dpi = 300
 )
<<most recent fixed investment year collapsed original HHs, warning = F, message = F, fig.align='center', fig.height = 3, fig.width = 10, fig.cap = paste0("Fixed investment amount", "\\\\ {\\footnotesize  \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
library(ggplot2)
pc21 <- pc2[!is.na(cost_once_when_year) & !is.na(cost_once_amount_taka) &
  size_sequence == 1, ]
setorder(pc21, hhid, cost_once_when_year)
pc21[, Seq := 1:.N, by = hhid]
pc21[Seq == 1, SeqString := "first"]
pc21[Seq == 2, SeqString := "second"]
pc21[Seq == 3, SeqString := "third"]
pc21[, SeqString := factor(SeqString)]
g <- ggplot(data = subset(pc21, size_sequence == 1), 
  aes(cost_once_amount_taka)) + 
  geom_histogram() +
  xlab("amount") +
  scale_y_continuous()+
  scale_x_continuous(limits = c(0, 30000))+
  theme(
    legend.position="bottom", 
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 9),
    legend.key = element_rect(fill = "white"),
    legend.key.size = unit(.5, "cm"),
    axis.text = element_text(size = 5),
    axis.title = element_text(size = 7),
    strip.text.x = element_text(color = "blue", size = 6, 
      margin = margin(0, .5, 0, .5, "cm")), 
    strip.text.y = element_text(color = "blue", size = 6, 
      margin = margin(.5, 0, .5, 0, "cm"))
  )+   
  #facet_grid(cost_once_when_year ~ AssignOriginal)
  facet_grid(SeqString ~ AssignOriginal, scales = "free_y")
ggsave(
  paste0(pathprogram, 
    "figure/ImpactEstimationOriginal1600Memo2/FixedInvestmentAmountBySequence.png"),
  g,
  width = 12, height = 7, units = "cm",
  dpi = 300
 )
<<first fixed investment year collapsed original HHs, warning = F, message = F, fig.align='center', fig.height = 3, fig.width = 10, fig.cap = paste0("Fixed investment amount", "\\\\ {\\footnotesize  \\setlength{\\baselineskip}{8pt}}"), fig.lp = 'Figure '>>=
library(ggplot2)
g <- 
ggplot(data = subset(pc21, size_sequence == 1 & Seq == 1 & !is.na(DistDate1)), 
  aes(cost_once_amount_taka)) + 
  geom_histogram() +
  xlab("amount") +
  scale_y_continuous()+
  scale_x_continuous(limits = c(0, 30000))+
  theme(
    legend.position="bottom", 
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 9),
    legend.key = element_rect(fill = "white"),
    legend.key.size = unit(.5, "cm"),
    axis.text = element_text(size = 5),
    axis.title = element_text(size = 7),
    strip.text.x = element_text(color = "blue", size = 6, 
      margin = margin(0, .5, 0, .5, "cm")), 
    strip.text.y = element_text(color = "blue", size = 6, 
      margin = margin(.5, 0, .5, 0, "cm"))
  )+   
  facet_grid( ~ AssignOriginal)
ggsave(
  paste0(pathprogram, 
    "figure/ImpactEstimationOriginal1600Memo2/FirstFixedInvestmentAmountByYear.png"),
  g,
  width = 10, height = 3, units = "cm",
  dpi = 300
 )
@
<<>>=
setkey(arid, Arm)
@

\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Cattle holding by arm and borrower status\label{fig CattleHoldingArmBStatus}}\\
\hfil\includegraphics{\Sexpr{  paste0(pathprogram, "figure/EstimationMemo/CowHoldingByArmBStatus.jpg")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Survey data.\\
Note:& Numbers of loan recipients are \Sexpr{lvo[o800==1 & survey == 1, .(N = .N), by = .(Arm, BStatus)][grepl("bo", BStatus), N]}, numbers of reported livestock holding are \Sexpr{unique(lvstkSummary[grepl("bo", BStatus) & grepl("ca", Livestock) & survey == 1, N])} for \textsf{\Sexpr{unique(as.character(arid[, Arm]))}} arms, respectively. Red horizontal lines indicate number of loan recipients. \\[1ex]
\end{tabular}
}


\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Cattle holding by arm\label{fig CattleHoldingArm}}\\
\hfil\includegraphics{\Sexpr{  paste0(pathprogram, "figure/EstimationMemo/CattleHoldingByArm.jpg")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Survey data.\\
Note:& Numbers of survey participants are \Sexpr{lvo[o800==1 & survey == 1, .(N = .N), by = .(Arm)][, N]} for \textsf{\Sexpr{unique(as.character(arid[, Arm]))}} arms in round 1, respectively. Holders rates are the number of cattle owners per arm size, holding size is average holding per owner, initial owner holding are average holding per owner who held cattle at period 2, and per capita holding is cattle owned per arm member. Initial owner holding and holder rates show impacts on the intensive and extensive margins, respectively. Per capita holding shows the total impacts on cattle holding.\\[1ex]
\end{tabular}
}

\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Project choices\label{fig ProjectChoices}}\\
\hfil\includegraphics{\Sexpr{  paste0(pathprogram, "figure/ImpactEstimationOriginal1600Memo2/ProjectChoices.jpg")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Survey data.\\
Note:& Ratios of reported project choices using the lending to total number of projects in \textsf{InitialSample}. NAs include nonresponse to the question and dropped out individuals.  \\[1ex]
\end{tabular}
}

\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Largest fixed investment amount\label{fig FixedInvest}}\\
\hfil\includegraphics{\Sexpr{  paste0(pathprogram, "figure/ImpactEstimationOriginal1600Memo2/FixedInvestmentAmount.jpg")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Survey data.\\
Note:& Reported largest one-off investment amounts of the lending. \\[1ex]
\end{tabular}
}

\mpage{\linewidth}{
\hfil\textsc{\footnotesize Figure \refstepcounter{figure}\thefigure: Fixed investment sequence and amounts\label{fig first2ndFixedInvest}}\\
%\hfil\includegraphics{\Sexpr{  paste0(pathprogram, "figure/ImpactEstimationOriginal1600Memo2/FirstFixedInvestmentAmountByYear.png")}}\\
\hfil\includegraphics{\Sexpr{  paste0(pathprogram, "figure/ImpactEstimationOriginal1600Memo2/FixedInvestmentAmountBySequence.png")}}\\
\renewcommand{\arraystretch}{1}
\hfil\begin{tabular}{>{\hfill\scriptsize}p{1cm}<{}>{\scriptsize}p{12cm}<{\hfill}}
Source: & Survey data.\\
Note:& Reported largest one-off investment amounts of the lending. Top figure is the first investments reported by year, bottom figure is later investments reported by the sequence of investment projects. \\[1ex]
\end{tabular}
}


\footnotesize\bibliographystyle{aer}
\setlength{\baselineskip}{10pt}
\bibliography{c:/seiro/settings/TeX/seiro}

